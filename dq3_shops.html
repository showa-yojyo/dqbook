<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.11. 店屋</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_kings.html" title="5.10. 王様" />
    <link rel="next" href="dq3_overcharge.html" title="5.12. ふっかけ店屋" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_kings.html" title="5.10. 王様"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_overcharge.html" title="5.12. ふっかけ店屋"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_kings.html">5.10. 王様</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_overcharge.html">5.12. ふっかけ店屋</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.shops"></a>5.11. 店屋</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_shops.html#dq3.shops.structure">5.11.1. 構造に関する構成要素</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.structure.C30900">5.11.1.1. 構造体 <code class="varname">$C30900</code>: 店屋</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.structure.C3CA2A">5.11.1.2. 店屋台詞集</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="section">
              <a href="dq3_shops.html#dq3.shops.behavior">5.11.2. 振る舞いに関する構成要素</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3C77C">5.11.2.1. サブルーチン <code class="varname">$C3C77C</code>: 店屋</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3C7EF">5.11.2.2. サブルーチン <code class="varname">$C3C7EF</code>: かいにきた</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CB74">5.11.2.3. サブルーチン <code class="varname">$C3CB74</code>: 購入時呪い処理</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CBBE">5.11.2.4. サブルーチン <code class="varname">$C3CBBE</code>: 売却時呪い処理</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CC21">5.11.2.5. サブルーチン <code class="varname">$C3CC21</code>: 所持金が十分あるか判定する</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CC37">5.11.2.6. サブルーチン <code class="varname">$C3CC37</code>: 購入代金を計算する</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CC51">5.11.2.7. サブルーチン <code class="varname">$C3CC51</code>: 購入取引成立処理</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CCB1">5.11.2.8. サブルーチン <code class="varname">$C3CCB1</code>: うりにきた</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CE2A">5.11.2.9. サブルーチン <code class="varname">$C3CE2A</code>: 所持金の増え方を調べる</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CE5B">5.11.2.10. サブルーチン <code class="varname">$C3CE5B</code>: 売却取引成立処理</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_shops.html#dq3.shops.behavior.C3CE93">5.11.2.11. サブルーチン <code class="varname">$C3CE93</code>: 仲間の誰かまたはふくろにアイテムがあるか調べる</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <p>
本節では武器と防具の店、道具屋、そしてよろず屋について述べる。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.shops.structure"></a>5.11.1. 構造に関する構成要素</h3>
            </div>
          </div>
        </div>
        <p>
店屋を表現するオブジェクト型および店員台詞集について記す。
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.structure.C30900"></a>5.11.1.1. 構造体 <code class="varname">$C30900</code>: 店屋</h4>
              </div>
            </div>
          </div>
          <p>
アドレス <code class="varname">$C30900</code> には次の表で示すような型のオブジェクトが配列されている。
ここにあるオブジェクトそれぞれが対応する店屋のサービスを表現する。
</p>
          <div class="table">
            <a id="table.dq3.C30900"></a>
            <p class="title">
              <strong>表 5.32 構造体 $C30900</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq3.C30900" class="lighttable">
                <thead>
                  <tr>
                    <th>オフセット</th>
                    <th>桁</th>
                    <th>属性</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <code class="literal">#$00</code>
                    </td>
                    <td>
                      <code class="literal">#$007F</code>
                    </td>
                    <td>店屋分類</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$00</code>
                    </td>
                    <td>
                      <code class="literal">#$0080</code>
                    </td>
                    <td>まとめ買い許可</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$01</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 0</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$02</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 1</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$03</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 2</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$04</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 3</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$05</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 4</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$06</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 5</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$07</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 6</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$08</code>
                    </td>
                    <td>
                      <code class="literal">#$00FF</code>
                    </td>
                    <td>商品 7</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
          <p>
各属性の意味を次に記す。
</p>
          <div class="variablelist">
            <dl class="variablelist">
              <dt>
                <span class="term">店屋分類</span>
              </dt>
              <dd>
                <p>
        店屋の分類とは、基本的には店員の台詞回しを決めるものだと考えてよい。
      </p>
              </dd>
              <dt>
                <span class="term">まとめ買い許可</span>
              </dt>
              <dd>
                <p>
        この店屋で同一アイテムを複数個一括して買うことが可能かどうかを示すブーリアン値を取る属性だ。
      </p>
              </dd>
              <dt>
                <span class="term">商品 k (k = 0..7)</span>
              </dt>
              <dd>
                <p>
        この店屋の商品のアイテム ID を値に取る属性だ。
        アイテムについては <a class="xref" href="dq3_items.html" title="5.23. アイテム">5.23 アイテム</a> で述べる。
      </p>
              </dd>
            </dl>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.structure.C3CA2A"></a>5.11.1.2. 店屋台詞集</h4>
              </div>
            </div>
          </div>
          <p>
アドレス <code class="varname">$C3CA2A</code> から各種店屋の台詞 ID が定義されている。
例えば「ようこそ」を表示するために店屋の種類ごとに 5 タイプの台詞が用意されている。
汎用台詞表示サブルーチン <code class="varname">$C1A95A</code> を呼び出すことで店員の台詞を表示している。
</p>
          <p>
台詞配列を表にしてまとめておくと次のようになる。店屋が「武器と防具の店」の台詞例を付しておく。
</p>
          <div class="table">
            <a id="table.dq3.C3CA2A"></a>
            <p class="title">
              <strong>表 5.33 店屋台詞集</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq3.C3CA2A" class="lighttable">
                <thead>
                  <tr>
                    <th>配列</th>
                    <th>台詞例</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <code class="varname">$C3CA2A</code>
                    </td>
                    <td>[D6]ここは 武器と防具の店だ。[AD]どんな用だい？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA34</code>
                    </td>
                    <td>[D6]なにを 買うかね？[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA3E</code>
                    </td>
                    <td>[D6]おっと ざんねんだが[AD]お金が たりないようだ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA48</code>
                    </td>
                    <td>[D6][B5]だね。[AD]どうも ありがとう。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA52</code>
                    </td>
                    <td>[D6][B5] [BB]個だね。[AD]どうも ありがとう。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA5C</code>
                    </td>
                    <td>[D6]これは 戦いのときに[AD]どうぐとして 使っても[AD]効力が あるよ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA66</code>
                    </td>
                    <td>[D6]だれが 持つかね？[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA70</code>
                    </td>
                    <td>[D6]おや？ わるいが [C0]は[AD]それ以上 持てないみたいだ。[AD]持ちものを 整理するかい？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA7A</code>
                    </td>
                    <td>[D6]よし！ 整理したぜ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA84</code>
                    </td>
                    <td>[D6]おや？ しかし [C0]の[AD]持ちものは 大事なものばかりで[AD]勝手に 整理できないぞ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA8E</code>
                    </td>
                    <td>[D6]ほかの人が 持つかね？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CA98</code>
                    </td>
                    <td>[D6]じゃあ その [C3]に[AD]いれておくぜ！[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAA2</code>
                    </td>
                    <td>[D6][C0]は これを[AD]そうびできないが[AD]それでも いいかね？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAAC</code>
                    </td>
                    <td>[D6]ここで そうび していくかい？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAB6</code>
                    </td>
                    <td>[D6]ほらよっ [C0]さん！[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAC0</code>
                    </td>
                    <td>[D6]じゃあ [C0]の[AD]ひつぎの中に いれておくよ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CACA</code>
                    </td>
                    <td>[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAD4</code>
                    </td>
                    <td>[D6]持ちきれなかったぶんは[AD]その[C3]に いれておくよ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CADE</code>
                    </td>
                    <td>[D6]ほかにも 買うかね？[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAE8</code>
                    </td>
                    <td>[D6]だれが 売ってくれるんだい？[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAF2</code>
                    </td>
                    <td>[D6]おや？ でも [C0]は[AD]なんにも 持ってないぜ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CAFC</code>
                    </td>
                    <td>[D6]おや？ その [C3]には[AD]なんにも はいってないぜ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB06</code>
                    </td>
                    <td>[D6]わるいが それは うちでは[AD]買いとれないなあ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB10</code>
                    </td>
                    <td>[D6]しかし それを 売っちまうと[AD]２度と 手に入らないかも[AD]しれないぜ。 いいのかい？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB1A</code>
                    </td>
                    <td>[D6][B5]だね。[AD][BB]ゴールドで[AD]引きとろう。いいかい？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB24</code>
                    </td>
                    <td>[D6]よし！ たしかに買いとったぜ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB2E</code>
                    </td>
                    <td>[D6]それは ざんねんだな。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB38</code>
                    </td>
                    <td>[D6]おっと！ 買いとりたいが[AD]それ以上 お金を[AD]持てないみたいだぜっ。[AF][AD]売るまえに うちで[AD]なにか 買っていきなよ。[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB42</code>
                    </td>
                    <td>[D6]ほかにも 売ってくれるかい？[AF][AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB4C</code>
                    </td>
                    <td>[D6]ほかにも 用は あるかね？[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB56</code>
                    </td>
                    <td>[D6]また 来てくれよなっ！[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB60</code>
                    </td>
                    <td>[D6]わっ びっくりした！ その[AD][B5]は 呪いで[AD]はずれないようだぜ。[AF][AD]しょうがないなあ… とりあえず[AD]受けとっておくれよ。[AC]</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="varname">$C3CB6A</code>
                    </td>
                    <td>[D6]うわっと！ こいつは おどろいた！[AD]買いとりたいのは やまやまだが[AD]呪いで はずれないようだぜ。[AF][AC]</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.shops.behavior"></a>5.11.2. 振る舞いに関する構成要素</h3>
            </div>
          </div>
        </div>
        <p>
店屋の処理を細かく分解すると、パーティーの所持金の変更、仲間キャラクターの持ち物状態の変更、
仲間キャラクターの状態テスト等、総合的な機能を有したサブルーチンの合成物の様相を呈している。
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3C77C"></a>5.11.2.1. サブルーチン <code class="varname">$C3C77C</code>: 店屋</h4>
              </div>
            </div>
          </div>
          <p>
店屋共通処理サブルーチンは <code class="varname">$C3C77C</code> に定義されている。
武器と防具の店、道具屋、よろず屋の処理を一手に引き受ける。
ポイントは次のとおりだ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      最初に与えられた店屋 ID から店屋オブジェクトを読み込み、適宜メモリーにセットする。
      ちなみに店屋 ID は <code class="varname">$7E3538</code> の <code class="literal">#$003F</code> 部分に保存される。
    </p>
              </li>
              <li class="listitem">
                <p>
      店員の挨拶を表示した後、サービス選択メニューを表示する。
      ここで「やめる」を選択すると、お別れの挨拶をして店屋処理全体が終了する。
      それ以外については、各サービスの処理を終えた後、店員が他の用事の有無を尋ね、再度選択メニューを表示する。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3C7EF"></a>5.11.2.2. サブルーチン <code class="varname">$C3C7EF</code>: かいにきた</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3C7EF</code> は店屋サービスの「かいにきた」を選択した場合の処理だ。
この処理は特に複雑なので、重要なポイントに絞って解説する。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      まとめ買い可能な店かどうかで、メニューウィンドウの仕様が若干異なる。
    </p>
              </li>
              <li class="listitem">
                <p>
      購入品が戦闘中に使うことで効果があるかどうかで店員の台詞が加わるかどうかの判定は、
      対象アイテムオブジェクトの戦闘モードコマンド属性値の判定による。
      この属性については <a class="xref" href="dq3_items.html#dq3.items.structure" title="5.23.1. 構造に関する構成要素">5.23.1 構造に関する構成要素</a> で解説する。
    </p>
              </li>
              <li class="listitem">
                <p>
      受取人の所持品が満杯のときには店員が整理するオプションが与えられる。
      ここで、整理後も道具袋が満杯のままであれば、そのときには専用の台詞が表示される。
    </p>
              </li>
              <li class="listitem">
                <p>
      受取人の装備品を更新する際に、現在の装備品が呪われている状況かどうかを判定する。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CB74"></a>5.11.2.3. サブルーチン <code class="varname">$C3CB74</code>: 購入時呪い処理</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CB74</code> は、
装備するための品物を買い、同時に装備させてもらおうとしたが、今装備しているものが呪われているときの処理だ。
ポイントは次のとおりだ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      購入したアイテムと同じアイテム分類である対象キャラクターの装備アイテムを参照する。
    </p>
              </li>
              <li class="listitem">
                <p>
      装備アイテムがある場合に限り、そのアイテムの呪い属性値を判定する。
    </p>
              </li>
              <li class="listitem">
                <p>
      呪い属性値が 1 のときに限り、効果音 <code class="literal">#$002A</code> を再生する。
      さらに店員の台詞集の中から、この状況用のそれをメッセージウィンドウに表示する。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CBBE"></a>5.11.2.4. サブルーチン <code class="varname">$C3CBBE</code>: 売却時呪い処理</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CBBE</code> は持ち物を売ろうとするときに呼び出される。
ポイントは次のとおりだ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      売却対象アイテムがふくろにある場合には以下の処理を行わない。
    </p>
              </li>
              <li class="listitem">
                <p>
      売却対象アイテムの分類を参照し、所有キャラクターの装備品からその分類値と一致するものを検索する。
      装備していない場合には以下の処理を行わない。
    </p>
              </li>
              <li class="listitem">
                <p>
      対象アイテムの呪い属性値を判定する。呪い属性値が 1 でない場合には以下の処理を行わない。
    </p>
              </li>
              <li class="listitem">
                <p>
      効果音 <code class="literal">#$002A</code> を再生する。
    </p>
              </li>
              <li class="listitem">
                <p>
      店員の台詞集の中から、この状況用のそれをメッセージウィンドウに表示する。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CC21"></a>5.11.2.5. サブルーチン <code class="varname">$C3CC21</code>: 所持金が十分あるか判定する</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CC21</code> は、店屋で品物を買うことが決まった直後の処理であり、
所持金が足りるかを調べる。
</p>
          <p>
後述のサブルーチン <code class="varname">$C3CC37</code> で計上した金額がパーティーの所持金以下であることを判定する過程で、
既にパーティーの所持金が減額されてしまっている。
それを汎用所持金加算サブルーチン <code class="varname">$C45B1A</code> を呼び出すことで埋め合わせるというものだ。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CC37"></a>5.11.2.6. サブルーチン <code class="varname">$C3CC37</code>: 購入代金を計算する</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CC37</code> は購入代金を計算して、パーティーの所持金から引いてみるというものだ。
乗算には汎用乗算サブルーチンを用いる。
</p>
          <p>
「パーティーの所持金から引いてみる」と書いたが、成功した場合だけ所持金が減るようになっている。
それゆえ、呼び出し元の状況次第で再度ゴールドを埋め合わせる必要が生じることもある。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CC51"></a>5.11.2.7. サブルーチン <code class="varname">$C3CC51</code>: 購入取引成立処理</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CC51</code> は「かいにきた」一回分のトランザクションだ。
要点を以下に列挙する。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      購入品が「おうじゃのけん」である場合には特別な処理をする。
      すなわち、おうじゃのけん入手フラグをセットし、現在の店屋 ID を <code class="literal">#$0023</code> に上書きして対応する店屋オブジェクトを読み込む。
    </p>
              </li>
              <li class="listitem">
                <p>
      購入代金を計算する。<a class="xref" href="dq3_shops.html#dq3.shops.behavior.C3CC37" title="5.11.2.6. サブルーチン $C3CC37: 購入代金を計算する">5.11.2.6 サブルーチン <code class="varname">$C3CC37</code>: 購入代金を計算する</a> で述べた処理を利用する。
    </p>
              </li>
              <li class="listitem">
                <p>
      受け取り対象がキャラクターの場合、対象者の道具袋に購入品を購入数分だけ反復して追加していく。
      道具袋が満杯になったら、余りをパーティー共有のふくろに回す。
    </p>
              </li>
              <li class="listitem">
                <p>
      受け取り対象がふくろの場合にも、購入品を購入数分だけ反復して追加していく。
      こちらの場合はストックが溢れても構わないものとする。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CCB1"></a>5.11.2.8. サブルーチン <code class="varname">$C3CCB1</code>: うりにきた</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CCB1</code> は「うりにきた」を選択した場合の処理だ。
この処理は特に複雑なので、重要なポイントに絞って解説する。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      売却品のアイテムオブジェクトの属性を参照することで、
      それが処分禁止か貴重品かそれ以外かを同時に判定する。
      アイテムが処分禁止ならば、それが「オリハルコン」であり、
      なおかつ店屋分類が 8 であれば通常品扱いをするという特殊処理が入る。
      アイテムが貴重品ならば、店員が確認の台詞を言うようになる。
    </p>
              </li>
              <li class="listitem">
                <p>
      所持金と買取額の和が 1,000,000 以上になる場合には、この取引は成立しない。
    </p>
              </li>
              <li class="listitem">
                <p>
      アイテム売却後、店員が他にも売り物はあるかを尋ねる条件がある。
      その条件とは「パーティーの誰かの道具袋または共有のふくろにアイテムが存在する」かつ
      「パーティーの所持金が 999,999 ゴールド未満である」だ。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CE2A"></a>5.11.2.9. サブルーチン <code class="varname">$C3CE2A</code>: 所持金の増え方を調べる</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CE2A</code> は、パーティの所持金に指定金額を加算すると、
それがいくらになるのかを調べる処理だ。
加算結果が <code class="literal">1,000,000</code> ゴールド以上になるかどうかをも調べる。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CE5B"></a>5.11.2.10. サブルーチン <code class="varname">$C3CE5B</code>: 売却取引成立処理</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CE5B</code> は「うりにきた」一回分のトランザクションだ。
要点を以下に列挙する。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      先に対象アイテムの売却額をパーティーの所持金に加算する。
    </p>
              </li>
              <li class="listitem">
                <p>
      所有者がキャラクターならばその者の道具袋から、パーティー共有のふくろならば、ふくろから対象アイテムを一つ取り除く。
    </p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.shops.behavior.C3CE93"></a>5.11.2.11. サブルーチン <code class="varname">$C3CE93</code>: 仲間の誰かまたはふくろにアイテムがあるか調べる</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3CE93</code> は、パーティーが何らかのアイテムを一つでも所有しているかどうかを判定するためにある。
処理の概略は以下のようになっている。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
      先にパーティーキャラクターの所持品を勘定する。後列の者から検索対象となる。
    </p>
              </li>
              <li class="listitem">
                <p>
      この時点でアイテムが何もなければ、ふくろを先頭から調べる。有効アイテムを発見すれば検索を終了する。
    </p>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_kings.html" title="5.10. 王様"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_overcharge.html" title="5.12. ふっかけ店屋"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_kings.html">5.10. 王様</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_overcharge.html">5.12. ふっかけ店屋</a></div>
  </body>
</html>
