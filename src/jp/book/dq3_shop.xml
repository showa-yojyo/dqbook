<?xml version="1.0" encoding="UTF-8"?>

<section id="dq3.shop"><?dbhtml filename="dq3_shop.html" ?>
<title>店屋解析</title>
<indexterm id="term.dq3.shop"><primary>店屋</primary><secondary>DQ3</secondary></indexterm>
<para>
本節では武器と防具の店、道具屋、そしてよろず屋に共通する処理部のコードを解析する。
店屋の処理を細かく分解すると、パーティーの所持金の変更、仲間キャラクターの持ち物状態の変更、
仲間キャラクターの状態テスト等、総合的な機能を有したサブルーチンの合成物の様相を呈している。
</para>

<section id="dq3.shop.hack">
<title>解析</title>

<section id="dq3.shop.hack.C3C77C">
<title>店屋共通処理サブルーチン</title>
<para>
店屋共通処理サブルーチンは <varname>$C3C77C</varname> に定義されている。
武器と防具の店、道具屋、よろず屋の処理を一手に引き受ける。
これらの唯一の違いである台詞まわしの差だが、この実現方法は、
<link linkend="dq3.king.hack.C3C07E">王様共通処理サブルーチン</link>と同じだ。
</para>
<para>
サブルーチン <varname>$C3C77C</varname> の処理内容のアウトラインを以下に示す。
なお、解読していないコードや、本処理とは本質的に関係しない細部の説明は省く。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 店屋構造体 ID</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>$7E3538 &amp; #$003F</code> 部分のビットをセットするためにサブルーチン <varname>$C902E9</varname> を呼び出す
			（意図不明）。
		</para>
	</listitem>
	<listitem>
		<para>
			<link linkend="dq3.shop.hack.C3CEC6">店屋構造体アクセスサブルーチン</link>を呼び出す。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = $2BB2; 店屋の台詞パターン</code>
		</para>
	</listitem>
	<listitem>
		<para>
			「ここは武器と防具の店だ」系統の台詞 (ID: <varname>$C3CA2A,X</varname>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>【かいにきた・うりにきた・やめる】</para>
		<para>
			用事を尋ねるウィンドウを表示して、プレイヤーの入力を待つ。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャンセルボタン抜け or やめる ⇒【終了】へジャンプ
				</para>
			</listitem>
			<listitem>
				<para>
					かいにきた ⇒【かいにきた】へジャンプ
				</para>
			</listitem>
			<listitem>
				<para>
					うりにきた ⇒【うりにきた】へジャンプ
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					「また来てくれよな」系統の台詞 (ID: <varname>$C3CB56,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【かいにきた】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3C7EF">「かいにきた」処理サブルーチン</link>を呼び出す
				</para>
			</listitem>
			<listitem>
				<para>
					【他に用は】へジャンプ
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【うりにきた】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CCB1">「うりにきた」処理サブルーチン</link>を呼び出す
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【他に用は】</para>
		<itemizedlist>
			<listitem>
				<para>
					「ほかにも用はあるかね？」系統の台詞 (<varname>$C3CB4C,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【かいにきた・うりにきた・やめる】へジャンプ
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
<para>
このサブルーチンは、プレイヤーが選択したメニュー項目次第で、
専用の補助サブルーチンに処理を委譲するということに徹している。
</para>
</section> <!-- dq3.shop.hack.C3C77C -->

<section id="dq3.shop.hack.C3C7EF">
<title>「かいにきた」処理サブルーチン</title>
<para>
サブルーチン <varname>$C3C7EF</varname> は「かいにきた」を選択した場合の処理だ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>X == 店屋の台詞タイプを表す数値</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			「なにを買うかね？」系統の台詞 (ID: <varname>$C3CA34,X</varname>) を表示する。
		</para>
	</listitem>

	<listitem>
		<para>【かいにきた序盤】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン <varname>$C3CF84</varname> を呼び出し、<code>$2BE2,X = #$01</code> (<code>X = 0..7</code>) とする。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33BA = $33A0</code>; 商品リストウィンドウでの選択位置
				</para>
			</listitem>
			<listitem>
				<para>
					まとめ買い対応かどうか (<varname>$2BB8</varname>) をテストする。
					このフラグにより、商品をリストするウィンドウの型が異なる。
				</para>
			</listitem>
			<listitem>
				<para>
					商品リストウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【商品選択直後】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン ⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33DA = 選択した商品のリスト順序</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA = 選択した商品のアイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33E2 = 選択した商品の単価</code>（ただし <literal>4</literal> バイト長）
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33E6 = 選択した商品の購入個数</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CC21">サブルーチン <varname>$C3CC21</varname></link> を呼び出し、
					所持金が十分あるかテストする。不足している場合、
				</para>
				<itemizedlist>
					<listitem>
						<para>
							「おっと残念だがお金が足りないようだ」系統の台詞 (ID: <varname>$C3CA3E,X</varname>) を表示する。
						</para>
					</listitem>
					<listitem>
						<para>
							呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【トランザクション直後】</para>
		<itemizedlist>
			<listitem>
				<para>
					購入個数 (<varname>$33E6</varname>) をテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<literal>1</literal> でなければ、「○○○○ ×個だね。どうもありがとう」系統の台詞 (ID: <varname>$C3CA52,X</varname>) を表示する。
						</para>
					</listitem>
					<listitem>
						<para>
							<literal>1</literal> ならば、「○○○○だね。どうもありがとう」系統の台詞 (ID: <varname>$C3CA48,X</varname>) を表示する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>A = $33DA; アイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					アイテム種別取得サブルーチン <varname>$C44FE2</varname> を呼び出し、
					アイテム (<varname>A</varname>) の種別（武器とか装飾品とか）を取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A == 5</code> ⇒【だれが持つ】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>A = $33DA; アイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					アイテムサブルーチン <varname>$C451A3</varname> を呼び出し、
					装備可能なアイテム (<varname>A</varname>) が戦闘中に利用できるものかどうかを調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							戦闘中の特別な利用法がなければ、【だれが持つ】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「これは戦いのときに道具として使っても～」系統の台詞 (ID: <varname>$C3CA5C,X</varname>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【だれが持つ】</para>
		<itemizedlist>
			<listitem>
				<para>
					「だれが持つかね？」系統の台詞 (ID: <varname>$C3CA66,X</varname>) を表示する。
				</para>
			</listitem>
			<!-- <listitem>
			<para>メッセージウィンドウを暗くする	</para>
			</listitem> -->
			<listitem>
				<para>
					<code>$33BA = $33A4</code>; 「だれが」ウィンドウの選択位置
				</para>
			</listitem>
			<listitem>
				<para>
					「だれが」ウィンドウ（と持ち物ウィンドウ）を表示して、入力を待つ。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン ⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33D6 = $33A4 = $BE7D = だれウィンドウの順番</code>
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>Overflow == 1</code> ⇒【ふくろに入れる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<!-- キャラクターに持たせる -->
			<listitem>
				<para>
					キャラクターの持ち物個数取得サブルーチン <varname>$C446A4</varname> を呼び出し、
					選択したキャラクター (<varname>A</varname>) の持ち物の個数を取得 (<varname>Y</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							現在の持ち物の個数が <literal>12</literal> より小さければ【整理直後】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「持ちものを整理するかい？」系統の台詞 (ID: <varname>$C3CA70,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【他の人が持つ】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>

			<listitem>
				<para>
					<code>A = $33D6</code>; だれ
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C3BD17</varname> を呼び出し、選択キャラクターの装備状態に何らかの操作をする。
					未調査。
				</para>
			</listitem>
			<listitem>
				<para>
					再びキャラクターの持ち物個数取得サブルーチン <varname>$C446A4</varname> を呼び出し、
					選択したキャラクター (<varname>A</varname>) の持ち物の個数を取得 (<varname>Y</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							持ち物の個数が <literal>12</literal> 以上 ⇒【大事なものばかり】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「よし！ 整理したぜ」系統の台詞 (ID: <varname>$C3CA7A,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【整理直後】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【大事なものばかり】</para>
		<itemizedlist>
			<listitem>
				<para>
					「おや？ ○○○○の持ちものは大事なものばかりで～」系統の台詞 (ID: <varname>$C3CA84,X</varname>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【他の人が持つ】</para>
		<itemizedlist>
			<listitem>
				<para>
					「ほかの人が持つかね？」系統の台詞 (ID: <varname>$C3CA8E,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【だれが持つ】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【ふくろに入れる】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CC51">サブルーチン <varname>$C3CC51</varname></link> を呼び出し、
					買いトランザクションを実行する。
				</para>
			</listitem>
			<listitem>
				<para>
					「じゃあ そのふくろにいれておくぜ」系統の台詞 (ID: <varname>$C3CA98,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【所持金がゼロか調べる】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【整理直後】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A = $33DA</code>; アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					アイテム種別サブルーチン <varname>$C44FE2</varname> を呼び出し、
					アイテム (<varname>A</varname>) の種別を取得 (<varname>Y</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							種別が <literal>5</literal> ⇒【キャラクターに持たせる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>Y = $33D6</code>; だれ
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクターパラメータ計算サブルーチン <varname>$C44A72</varname> を呼び出し、
					キャラクター (<varname>Y</varname>) がアイテム (<varname>A</varname>) を装備するときのパラメータ変化を計算する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							選択キャラクターがアイテムを装備できない場合は【装備できないが】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「ここで装備していくかい？」系統の台詞 (ID: <varname>$C3CAAC,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【キャラクターに持たせる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CB74">サブルーチン <varname>$CB74</varname></link> を呼び出す。
					選択キャラクターが呪われた装備をしているかどうかのテストだ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							呪われている ⇒【装備品の変更なし】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CC51">サブルーチン <varname>$C3CC51</varname></link> を呼び出し、
					買いトランザクションを実行する。
					（このときの <varname>Carry</varname> ビットを憶えておく）
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A = $33D6</code>; だれ
				</para>
			</listitem>
			<listitem>
				<para>
					再びキャラクターの持ち物個数取得サブルーチン <varname>$C446A4</varname> を呼び出し、
					選択したキャラクター (<varname>A</varname>) の持ち物の個数を取得 (<varname>Y</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					--Y
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター装備品更新サブルーチン <varname>$C44C1B</varname> を呼び出し、
					選択キャラクター (<varname>A</varname>) の装備品を更新する。
				</para>
			</listitem>
			<listitem>
				<para>
					メッセージ「○○○○は××××を装備させてもらった！」(ID: <literal>#$011B</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					憶えておいた <varname>Carry</varname> ビットをテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>Carry == 1</code> ⇒【持ちきれない分は～】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【所持金がゼロか調べる】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【装備できないが】</para>
		<itemizedlist>
			<listitem>
				<para>
					「○○○○は これを装備できないが～？」系統の台詞 (ID: <varname>$C3CAA2,X</varname>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【装備品の変更なし】</para>
		<itemizedlist>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【他にも買うかね】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【キャラクターに持たせる】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CC51">サブルーチン $C3CC51</link> を呼び出し、
					買いトランザクションを実行する。
					（このときの <varname>Carry</varname> ビットを憶えておく）
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A = $33D6</code>; だれ
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクターステータス取得サブルーチン <varname>$C43F87</varname> を呼び出し、
					キャラクター (<varname>A</varname>) のステータスを取得 (<varname>A</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A &amp; #$0010</code> をテストし、キャラクターの生死状態を考慮する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							死んでいる ⇒ 「○○○○の棺の中にいれておくよ」系統の台詞 (ID: <varname>$C3CAC0,X</varname>) を表示する。
						</para>
					</listitem>
					<listitem>
						<para>
							生きている ⇒ 「ほらよっ○○○○さん！」系統の台詞 (ID: <varname>$C3CAB6,X</varname>) を表示する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					憶えておいた <varname>Carry</varname> ビットをテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>Carry == 0</code> ⇒【所持金がゼロか調べる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【持ちきれない分は～】</para>
		<itemizedlist>
			<listitem>
				<para>
					「持ちきれなかった分はその袋に～」系統の台詞 (ID: <varname>$C3CAD4,X</varname>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【所持金がゼロか調べる】</para>
			<itemizedlist>
				<listitem>
					<para>
						所持金サブルーチン <varname>$C45AB0</varname> を呼び出し、
						パーティの現在の所持金を取得 (<varname>$70</varname>) する。
						ただし <literal>3</literal> バイト長で処理する。
					</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>$70 == #$000000</code> ⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【他にも買うかね】</para>
		<itemizedlist>
			<listitem>
				<para>
					「ほかにも買うかね？」系統の台詞 (ID: <varname>$C3CADE,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$CA1F</varname> を呼び出し、
					<code>$BE6B &amp; #$0040 != 0</code> かどうかをテストする
					（意味不明）。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル ⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【かいにきた序盤】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3C7EF -->

<section id="dq3.shop.hack.C3CA2A">
<title>台詞</title>
<para>
ここで台詞処理について整理しておく。
アドレス <varname>$C3CA2A</varname> から各種店屋の台詞 ID が定義されている。
例えば「ようこそ」を表示するために店屋の種類 (<varname>X</varname>) ごとに <literal>5</literal> タイプの台詞が用意されている。
Opcode <literal>#$BF</literal> の <code>LDA</code> 命令で以下のアドレスから ID 値をロードして、
台詞表示サブルーチン <varname>$C1A95A</varname> で店屋の台詞を表示している。
</para>
<table id="table.dq3.C3CA2A" class="lighttable">
	<caption>店屋台詞集</caption>
	<thead>
		<tr><th>Address</th><th>X == 0 のときの台詞</th></tr>
	</thead>
	<tbody>
		<tr><td><varname>$C3CA2A,X</varname></td><td>[D6]ここは 武器と防具の店だ。[AD]どんな用だい？[AC]</td></tr>
		<tr><td><varname>$C3CA34,X</varname></td><td>[D6]なにを 買うかね？[AF][AC]</td></tr>
		<tr><td><varname>$C3CA3E,X</varname></td><td>[D6]おっと ざんねんだが[AD]お金が たりないようだ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA48,X</varname></td><td>[D6][B5]だね。[AD]どうも ありがとう。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA52,X</varname></td><td>[D6][B5] [BB]個だね。[AD]どうも ありがとう。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA5C,X</varname></td><td>[D6]これは 戦いのときに[AD]どうぐとして 使っても[AD]効力が あるよ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA66,X</varname></td><td>[D6]だれが 持つかね？[AF][AC]</td></tr>
		<tr><td><varname>$C3CA70,X</varname></td><td>[D6]おや？ わるいが [C0]は[AD]それ以上 持てないみたいだ。[AD]持ちものを 整理するかい？[AC]</td></tr>
		<tr><td><varname>$C3CA7A,X</varname></td><td>[D6]よし！ 整理したぜ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA84,X</varname></td><td>[D6]おや？ しかし [C0]の[AD]持ちものは 大事なものばかりで[AD]勝手に 整理できないぞ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CA8E,X</varname></td><td>[D6]ほかの人が 持つかね？[AC]</td></tr>
		<tr><td><varname>$C3CA98,X</varname></td><td>[D6]じゃあ その [C3]に[AD]いれておくぜ！[AF][AC]</td></tr>
		<tr><td><varname>$C3CAA2,X</varname></td><td>[D6][C0]は これを[AD]そうびできないが[AD]それでも いいかね？[AC]</td></tr>
		<tr><td><varname>$C3CAAC,X</varname></td><td>[D6]ここで そうび していくかい？[AC]</td></tr>
		<tr><td><varname>$C3CAB6,X</varname></td><td>[D6]ほらよっ [C0]さん！[AF][AC]</td></tr>
		<tr><td><varname>$C3CAC0,X</varname></td><td>[D6]じゃあ [C0]の[AD]ひつぎの中に いれておくよ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CACA,X</varname></td><td>[AC]</td></tr>
		<tr><td><varname>$C3CAD4,X</varname></td><td>[D6]持ちきれなかったぶんは[AD]その[C3]に いれておくよ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CADE,X</varname></td><td>[D6]ほかにも 買うかね？[AF][AC]</td></tr>
		<tr><td><varname>$C3CAE8,X</varname></td><td>[D6]だれが 売ってくれるんだい？[AF][AC]</td></tr>
		<tr><td><varname>$C3CAF2,X</varname></td><td>[D6]おや？ でも [C0]は[AD]なんにも 持ってないぜ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CAFC,X</varname></td><td>[D6]おや？ その [C3]には[AD]なんにも はいってないぜ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CB06,X</varname></td><td>[D6]わるいが それは うちでは[AD]買いとれないなあ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CB10,X</varname></td><td>[D6]しかし それを 売っちまうと[AD]２度と 手に入らないかも[AD]しれないぜ。 いいのかい？[AC]</td></tr>
		<tr><td><varname>$C3CB1A,X</varname></td><td>[D6][B5]だね。[AD][BB]ゴールドで[AD]引きとろう。いいかい？[AC]</td></tr>
		<tr><td><varname>$C3CB24,X</varname></td><td>[D6]よし！ たしかに買いとったぜ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CB2E,X</varname></td><td>[D6]それは ざんねんだな。[AF][AC]</td></tr>
		<tr><td><varname>$C3CB38,X</varname></td><td>[D6]おっと！ 買いとりたいが[AD]それ以上 お金を[AD]持てないみたいだぜっ。[AF][AD]売るまえに うちで[AD]なにか 買っていきなよ。[AF][AC]</td></tr>
		<tr><td><varname>$C3CB42,X</varname></td><td>[D6]ほかにも 売ってくれるかい？[AF][AC]</td></tr>
		<tr><td><varname>$C3CB4C,X</varname></td><td>[D6]ほかにも 用は あるかね？[AC]</td></tr>
		<tr><td><varname>$C3CB56,X</varname></td><td>[D6]また 来てくれよなっ！[AC]</td></tr>
		<tr><td><varname>$C3CB60,X</varname></td><td>[D6]わっ びっくりした！ その[AD][B5]は 呪いで[AD]はずれないようだぜ。[AF][AD]しょうがないなあ… とりあえず[AD]受けとっておくれよ。[AC]</td></tr>
		<tr><td><varname>$C3CB6A,X</varname></td><td>[D6]うわっと！ こいつは おどろいた！[AD]買いとりたいのは やまやまだが[AD]呪いで はずれないようだぜ。[AF][AC]</td></tr>
	</tbody>
</table>
</section> <!-- dq3.shop.hack.C3CA2A -->

<section id="dq3.shop.hack.C3CB74">
<title>呪い装備中（かいにきた版）</title>
<para>
サブルーチン <varname>$CB74</varname> は
「装備するための品物を買い、ついでに装備させてもらおうとしたが、
今装備しているものが呪われている」ときに呼び出される。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 == だれウィンドウの順番</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA == 購入する品物のアイテム ID</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			アイテム種別取得サブルーチン <varname>$C44FE2</varname> を呼び出し、
			アイテム (<varname>A</varname>) の種別を取得 (<varname>A</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクターの装備品取得サブルーチン <varname>$C44A03</varname> を呼び出し、
			キャラクター (<varname>Y</varname>) が装備しているアイテム種別 <varname>A</varname> のアイテム ID を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					指定したアイテム種別のアイテムを装備していない ⇒【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			アイテム呪い属性取得サブルーチンを呼び出し、
			装備アイテム (<varname>A</varname>) に呪い属性があるか否かをテスト (<varname>Carry</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					呪い属性がない ⇒【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			効果音 (ID: <literal>#$002A</literal>) を鳴らし、鳴り終わるまで待つ。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = $C3CB60,X</code>; メッセージ ID
		</para>
	</listitem>
	<listitem>
		<para>
			台詞「わっ びっくりした！ その××××は呪いで外れないようだぜ」(ID: <varname>A</varname>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>Carry = 1</code>
		</para>
	</listitem>
	<listitem>
		<para>
			【終了】へジャンプ。
		</para>
	</listitem>

	<listitem>
		<para>【<varname>Carry</varname> クリア】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry = 0</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ 呪われているため、買った品物を装備させてもらえなかった
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CB74 -->

<section id="dq3.shop.hack.C3CBBE">
<title>呪い装備中（うりにきた版）</title>
<para>
サブルーチン <varname>$CBBE</varname> は持ち物を売ろうとするときに呼び出される。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 == だれウィンドウの順番</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA == 売りたい持ち物のアイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DC == リストウィンドウでの選択番号</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			パーティ人数取得サブルーチンを呼び出し、
			パーティの人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 &gt;= A</code> ⇒ ふくろに入っている道具を売るものとみなし、
					【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>A = $33DA</code>; 売りたい持ち物のアイテム ID
		</para>
	</listitem>
	<listitem>
		<para>
			アイテム種別取得サブルーチン <varname>$C44FE2</varname> を呼び出し、
			アイテム (<varname>A</varname>) の種別を取得 (<varname>A</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクターの装備品取得サブルーチン <varname>$C44A03</varname> を呼び出し、
			キャラクター (<varname>Y</varname>) が装備しているアイテム種別 <varname>A</varname> のアイテム ID を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					指定したアイテム種別のアイテムを装備していない ⇒【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			アイテム呪い属性取得サブルーチンを呼び出し、
			装備アイテム (<varname>A</varname>) に呪い属性があるか否かをテスト (<varname>Carry</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					呪い属性がない ⇒【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			キャラクター装備アイテム数取得サブルーチン <varname>$C446D6</varname> を呼び出し、
			キャラクター (<varname>Y</varname>) の装備しているアイテムの総数 (<varname>A</varname>) を取得する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A - 1 &lt; $33DC</code> ⇒【<varname>Carry</varname> クリア】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			効果音 (ID: <literal>#$002A</literal>) を鳴らし、鳴り終わるまで待つ。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = $C3CB6A,X</code>; メッセージ ID
		</para>
	</listitem>
	<listitem>
		<para>
			台詞「買い取りたいのはやまやまだが 呪いで外れないようだぜ」(ID: <varname>A</varname>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>Carry = 1</code>
		</para>
	</listitem>

	<listitem>
		<para>【<varname>Carry</varname> クリア】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry = 0</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ 売ろうとした装備品が呪われているため、売れなかった
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CBBE -->

<section id="dq3.shop.hack.C3CC21">
<title>所持金が足りるかテスト</title>
<para>
サブルーチン <varname>$C3CC21</varname> は、店屋で品物を買うことが決まった直後の処理であり、
所持金が足りるかを調べる。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CC37">サブルーチン <varname>$CC37</varname></link> の事前条件に従う
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			<link linkend="dq3.shop.hack.C3CC37">サブルーチン <varname>$CC37</varname></link> を呼び出し、
			購入代金を計算、所持金が商品の値段以上であるか否かを調べる。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					所持金が不足している ⇒ <varname>Carry</varname> ビットを <literal>0</literal> にして、
					【終了】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			所持金加算サブルーチン <varname>$C45B1A</varname> を呼び出し、
			先程のサブルーチン内部処理で減算された金額 (<varname>$70</varname>) を再び所持金に加算する。
		</para>
	</listitem>
	<listitem>
		<para>
			<varname>Carry</varname> ビットを <literal>1</literal> にする
		</para>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ 所持金が間に合う
				</para>
			</listitem>
			<listitem>
				<para>
					所持金は変更されていない。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CC21 -->

<section id="dq3.shop.hack.C3CC37">
<title>購入代金を計算する</title>
<para>
サブルーチン <varname>$CC37</varname> は購入代金を計算する。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33E2 == 商品価格</code>（ただし <literal>4</literal> バイト長で比較する）
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33E6 == 購入個数</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>$70 = $33E2</code>; 商品価格（ただし <literal>4</literal> バイト長でセット）
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = $33E6</code>; 購入個数
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = #$0070</code>; 次のサブルーチン呼び出しの中で利用する。
		</para>
	</listitem>
	<listitem>
		<para>
			汎用乗算サブルーチン <varname>$C01107</varname> を呼び出し、<code>$70 *= A</code> を計算する。
		</para>
	</listitem>
	<listitem>
		<para>
			ゴールド関係サブルーチン <varname>$C45B66</varname> を呼び出し、
			所持金 (<varname>$3696</varname>) から金額 <varname>$70</varname> をマイナスにならないように引けるか調べる。
		</para>
	</listitem>
	<listitem>
		<para>
			呼び出し元に制御を戻す。
		</para>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 代金の下位 <literal>2</literal> バイト</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>Y == 代金の上位 <literal>2</literal> バイト</code>; ただしこの上位バイトはゼロ
				</para>
			</listitem>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ 所持金から代金を引いても負にならない
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CC37 -->

<section id="dq3.shop.hack.C3CC51">
<title>買いトランザクション</title>
<para>
サブルーチン <varname>$C3CC51</varname> は「かいにきた」一回分のトランザクションだ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 == だれウィンドウの順番</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA == アイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33E6 == 購入個数</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			購入する品物が「おうじゃのけん」であるかどうかをテストする。
			もし「おうじゃのけん」であれば、
		</para>
		<itemizedlist>
			<listitem>
				<para>
					フラグビットセットサブルーチン <varname>$C908F0</varname> を呼び出し、
					<emphasis><varname>$7E353A</varname> 最下位ビットから <literal>#$0053</literal> 番目にあるビットをセットする。</emphasis>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A = #$0023</code>; マイラの道具屋（「おうじゃのけん」抜き）を示す店屋構造体 ID
				</para>
			</listitem>
			<listitem>
				<para>
					フラグビットセットサブルーチン <varname>$C902E9</varname> を呼び出し、
					<emphasis><code>$7E3538 &amp; #$003F</code> 部分のビットをセット (<varname>A</varname>) する。</emphasis>
				</para>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CEC6">店屋構造体アクセスサブルーチン</link>を呼び出し、
					店屋データをリセット (<varname>A</varname>) する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<link linkend="dq3.shop.hack.C3CC37">サブルーチン <varname>$CC37</varname> </link>を呼び出し、
			購入個数と商品価格の積を求める。
			<!-- 実際にパーティの所持金から、その金額が引かれた状態になる。 -->
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = $33E6</code>; 購入個数
		</para>
	</listitem>
	<listitem>
		<para>
			<code>Y = $33D6</code>; だれウィンドウの順番
		</para>
	</listitem>
	<listitem>
		<para>
			パーティ人数取得サブルーチン <varname>$C4297C</varname> を呼び出し、
			パーティにいる人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 == A</code> ⇒【ふくろに追加】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【キャラクターの持ち物に追加】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33DA = A</code>; 購入アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター持ち物更新サブルーチン <varname>$C44739</varname> を呼び出し、
					アイテム (<varname>A</varname>) を一個、パーティのキャラクター (<varname>Y</varname>) の持ち物配列に追加する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>Carry == 1</code> ⇒【ふくろに追加】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>--X</code>; 購入個数をデクリメント
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>X != 0</code> ⇒【ふくろに追加】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>Carry = 0</code>
		</para>
	</listitem>
	<listitem>
		<para>
			【終了】へジャンプ。
		</para>
	</listitem>

	<listitem>
		<para>【ふくろに追加】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33DA = A</code>; 購入アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					ふくろアイテム追加サブルーチン <varname>$C45399</varname> を呼び出し、
					ふくろにアイテム (<varname>A</varname>) を一個追加する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>--X</code>; 購入個数をデクリメント
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>X != 0</code> ⇒【ふくろに追加】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>Carry = 1</code>
		</para>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry == 0</code> ⇔ ふくろの中身は更新しなかった
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CC51 -->

<section id="dq3.shop.hack.C3CCB1">
<title>「うりにきた」処理サブルーチン</title>
<para>
サブルーチン <varname>$C3CCB1</varname> は「うりにきた」を選択した場合の処理だ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>X == 店屋の台詞タイプを表す数値</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			「だれが 売ってくれるんだい？」(ID: <varname>$C3CAE8,X</varname>) 系統の台詞を表示する。
		</para>
	</listitem>

	<listitem>
		<para>【だれがウィンドウ表示】</para>
		<itemizedlist>
			<listitem>
				<para>
					「だれが」ウィンドウとその持ち物をリストしたウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							「だれが」ウィンドウでキャンセルしたとき、
							【だれがウィンドウをキャンセルした】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33D6 = A; $33A2 = A; $BE7D = A</code>; だれウィンドウの順番
				</para>
				<itemizedlist>
					<listitem>
						<para>
							ふくろを選択した ⇒【ふくろを選択した】へジャンプ。
						</para>
					</listitem>
					<listitem>
						<para>
							<code>$2BEE != 0</code> ⇒【キャラクターを選択した】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
			</listitem>
			<listitem>
				<para>
					「でも ○○○○は何にも持ってないぜ」系統の台詞 (ID: <varname>$C3CAF2,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【だれがウィンドウをキャンセルした】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【キャラクターを選択した】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33B8 = $33D6</code>; だれウィンドウの順番
				</para>
			</listitem>
			<listitem>
				<para>
					持ち物リストウィンドウでの入力を待つ
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル ⇒【だれがウィンドウ表示】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33DA = A</code>; アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DC = $33BE</code>; リストウィンドウでの選択番号
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
			</listitem>
			<listitem>
				<para>
					【道具の希少性をテスト】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【ふくろを選択した】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$2BF0 != 0</code> ⇒
				</para>
				<itemizedlist>
					<listitem>
						<para>
							【ふくろ中身選択】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
			</listitem>
			<listitem>
				<para>
					「おや？ そのふくろには何にも入ってないぜ」系統の台詞 (ID: <varname>$C3CAFC,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<!--
	<listitem>
		<para>【だれウィンドウ表示】</para>
		<itemizedlist>
			<listitem>
				<para>
				
				</para>
			</listitem>
		</itemizedlist>
	</listitem> -->

	<listitem>
		<para>【ふくろ中身選択】</para>
		<itemizedlist>
			<listitem>
				<para>
					持ち物リストウィンドウでの入力を待つ
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル ⇒【だれがウィンドウ表示】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33DA = A</code>; アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出す (<code>$33B6 |= #$4000</code>) 
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【道具の希少性をテスト】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$BE79 = $33DA</code>; アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					アイテムサブルーチン <varname>$C44F00</varname> を呼び出し、
					アイテム (<varname>A</varname>) の希少性を取得する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>Carry == 1</code> ⇒【売却不可能】へジャンプ。
						</para>
					</listitem>
					<listitem>
						<para>
							<code>Overflow == 0</code> ⇒【引き取ろう】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【希少品】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【引き取ろう】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A = $33DA</code>; アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					アイテム売値取得サブルーチン <varname>$C44EA6</varname> を呼び出し、
					アイテム (<varname>A</varname>) の売値を取得 (<varname>$70</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$BE81 = $70</code>; アイテム売値 (<literal>3</literal> バイト)
				</para>
			</listitem>
			<listitem>
				<para>
					「○○○○だね。××××ゴールドで引きとろう」系統の台詞 (ID: <varname>$C3CB1A,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
			</listitem>
			<listitem>
				<para>
					キャンセルボタン or 「いいえ」⇒
				</para>
				<itemizedlist>
					<listitem>
						<para>
							【残念だ】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CE2A">サブルーチン <varname>$C3CE2A</varname></link> を呼び出し、
					所持金の増え方を調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							所持金が上限を超えないような場合は【呪いチェック】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「それ以上 お金を持てないみたいだぜっ」系統の台詞 (ID: <varname>$C3CB38,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【売却不可能】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == #$00B1 &amp;&amp; X == #$0008</code> ⇒
				</para>
				<itemizedlist>
					<listitem>
						<para>
							【引き取ろう】へジャンプ。
							<emphasis>ある店屋においては、オリハルコンを買い取らせることができる。</emphasis>
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「悪いがうちでは買いとれないなあ」系統の台詞 (ID: <varname>$C3CB06,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【売り終了後】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪いチェック】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CBBE">サブルーチン <varname>$CBBE</varname></link> を呼び出し、
					キャラクターがそのアイテムを装備していて、なおかつ呪われているかをテストする。
				</para>
			</listitem>
			<listitem>
				<para>
					そのような場合⇒
				</para>
				<itemizedlist>
					<listitem>
						<para>
							【売り終了後】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CE5B">サブルーチン <varname>$C3CE5B</varname></link> を呼び出す。
				</para>
			</listitem>
			<listitem>
				<para>
					「よし！ たしかに買いとったぜ」系統の台詞 (ID: <varname>$C3CB24,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA == #$00B1</code> ⇒
				</para>
				<itemizedlist>
					<listitem>
						<para>
							フラグセットサブルーチン <varname>$C908F0</varname> を呼び出し、
							<varname>$7E353E</varname> の最下位から <literal>#$009B</literal> ビット目のビットを立てる。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【売り終了後】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【残念だ】</para>
		<itemizedlist>
			<listitem>
				<para>
					「それは残念だな」系統の台詞 (ID: <varname>$C3CB2E,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【売り終了後】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【希少品】</para>
		<itemizedlist>
			<listitem>
				<para>
					「しかしそれを売っちまうと２度と手に入らないかも～」系統の台詞 (ID: <varname>$C3CB10,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
			</listitem>
			<listitem>
				<para>
					キャンセルボタン or 「いいえ」⇒ 
				</para>
				<itemizedlist>
					<listitem>
						<para>
							【売り終了後】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【引き取ろう】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【売り終了後】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CE93">サブルーチン <varname>$C3CE93</varname></link> を呼び出し、
					パーティが道具を持っているかどうか調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							持っていなければ、呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$70 = #$000001</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.shop.hack.C3CE2A">サブルーチン <varname>$C3CE2A</varname></link> を呼び出し、
					現在の所持金に <varname>$70</varname> つまり <literal>1</literal> を加えて
					<literal>1000000</literal> G 以上になるか否かをテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							なりそうなときは、呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					「ほかにも売ってくれるかい？」系統の台詞 (ID: <varname>$C3CB42,X</varname>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$CA1F</varname> を呼び出し、
					<code>$BE6B &amp; #$0040 != 0</code> かどうかをテストする
					（意味不明）。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル ⇒ 呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【だれウィンドウ表示】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CCB1 -->

<section id="dq3.shop.hack.C3CE2A">
<title>所持金の増え方を調べる</title>
<para>
サブルーチン <varname>$C3CE2A</varname> は、パーティの所持金に金額を加算すると、
それがいくらになるのかを調べる処理だ。
加算結果が <literal>1000000</literal> ゴールド以上になるかどうかをも調べる。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$70 == 加算したい金額</code> (<literal>2</literal> バイト)
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			所持金取得サブルーチン <varname>$C45AB0</varname> を呼び出し、
			パーティの所持金を取得 (<varname>$73</varname>; <literal>4</literal> バイト) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$73 += $70</code>; <literal>4</literal> バイト
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = $75 &amp; #$00FF</code>
		</para>
	</listitem>
	<listitem>
		<para>
			<varname>A</varname> の値を見る
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == #$0000</code> ⇒【終了】へジャンプ
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A &lt; #$000F</code> ⇒【終了】へジャンプ
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<varname>$73</varname> と <literal>#$4240</literal> を比較し、その結果を <varname>Carry</varname> ビットに残す。
		</para>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$73 == パーティ所持金 + $70</code> (<literal>4</literal> バイト)
				</para>
			</listitem>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ <code>$73 &gt;= #000F4240</code> (<literal>4</literal> バイト)
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CE2A -->

<section id="dq3.shop.hack.C3CE5B">
<title>売りトランザクション</title>
<para>
サブルーチン <varname>$C3CE5B</varname> は「うりにきた」一回分のトランザクションだ。
二つの更新処理からなり、一つはパーティの所持金の更新で、
もう一つはキャラクターもしくはふくろのアイテムリストの更新だ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>$33D6 == だれウィンドウの順番</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA == アイテム ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DC == リストウィンドウでの選択番号</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>X = $33DA</code>; アイテム ID
		</para>
	</listitem>
	<listitem>
		<para>
			アイテム売値計算サブルーチン <varname>$C44EA6</varname> を呼び出し、
			アイテム (<varname>X</varname>) の下取価格を取得 (<varname>$70</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			所持金加算サブルーチン <varname>$C45B1A</varname> を呼び出し、
			基本的に、所持金 (<varname>$3696</varname>) を <varname>$70</varname> だけ増やす。
		</para>
	</listitem>
	<listitem>
		<para>
			パーティ人数取得サブルーチン <varname>$C4297C</varname> を呼び出し、
			パーティにいる人数を取得 (<varname>$70</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$33D6 &lt; $70</code> ⇒
		</para>
		<itemizedlist>
			<listitem>
				<para>
					ふくろアイテム操作サブルーチン <varname>$C453F7</varname> を呼び出し、
					ふくろに入っているアイテム (<varname>X</varname>) の個数を <literal>1</literal> だけ減らす。
				</para>
			</listitem>
			<listitem>
				<para>
					【終了】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>A = $33D6</code>; だれウィンドウの順番
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = $33DC</code>; リストウィンドウでの選択番号
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクターアイテム操作サブルーチン <varname>$C4487F</varname> を呼び出し、
			パーティにいるキャラクター (<varname>A</varname>) の持っているアイテム (<varname>X</varname>) を削除する。
		</para>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CE5B -->

<section id="dq3.shop.hack.C3CE93">
<title>パーティまたはふくろにアイテムがあるか調べる</title>
<para>
サブルーチン <varname>$C3CE93</varname> は、パーティの各キャラクターが何かアイテムを持っているか、
またはふくろの中にアイテムが入っているかどうかを調べる。
処理の概略は以下のようになっている。
</para>
<itemizedlist>
	<listitem>
		<para>
			パーティ人数取得サブルーチンを呼び出し、
			パーティの人数を取得 (<varname>X</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$70 = 0</code>; カウンターとして利用する。
		</para>
	</listitem>
	<listitem>
		<para>【パーティの持ち物の個数を数える】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>--X</code>; キャラクターのパーティ内での並び順
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>X &lt; 0</code> ⇒【ふくろのアイテムの個数を数える】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C446A4</varname> を呼び出し、
					キャラクター (<varname>X</varname>) の持ち物の個数を取得 (<varname>A</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$70 += A</code>; 持ち物の個数を加算
				</para>
			</listitem>
			<listitem>
				<para>
					【パーティの持ち物の個数を数える】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【ふくろのアイテムの個数を数える】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A = $70</code>; パーティの持ち物の個数
				</para>
			</listitem>
			<listitem>
				<para>
					もし <varname>A</varname> がゼロでなければ、
				</para>
				<itemizedlist>
					<listitem>
						<para>
							サブルーチン <varname>$C3305F</varname> を呼び出し、
							ふくろにしまってある相異なるアイテムの個数を取得 (<varname>$2BF0</varname>) する。
						</para>
					</listitem>
					<listitem>
						<para>
							<varname>$2BF0</varname> がゼロ ⇒
						</para>
						<itemizedlist>
							<listitem>
								<para>
									<code>Carry = 0</code>
								</para>
							</listitem>
							<listitem>
								<para>
									【終了】へジャンプ。
								</para>
							</listitem>
						</itemizedlist>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>Carry = 1</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Carry == 1</code> ⇔ パーティの持ち物またはふくろの中身になんらかのアイテムがある
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CE93 -->

<section id="dq3.shop.hack.C3CEC6">
<title>店屋構造体アクセスサブルーチン</title>
<para>
サブルーチン <varname>$C3CEC6</varname> では、店屋の ID を与えて店屋構造体のデータを取得する。
これは、それぞれの店を特徴付ける情報を保持するものだ。
アクセス汎用サブルーチン (<varname>$C9050D</varname>, <varname>$C90717</varname>) を利用しているのがポイントだ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 店屋構造体 ID</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					下の表の通り：
				</para>
				<table id="table.dq3.C3CEC6" class="lighttable">
					<caption>サブルーチン $C3CEC6 事後条件</caption>
					<thead>
						<tr><th>Address</th><th>Value</th></tr>
					</thead>
					<tbody>
						<tr><td><varname>$2BB2</varname></td><td>店屋の台詞パターン ID; <code>0,2,4,6,8</code> のどれか</td></tr>
						<tr><td><varname>$2BB6</varname></td><td>店屋の商品リスト数 </td></tr>
						<tr><td><varname>$2BB8</varname></td><td>店屋でまとめ買いができるかどうかを示す値; <code>0,1</code> のどれか</td></tr>
						<tr><td><varname>$2BBA</varname></td><td>店屋の商品<code>[0]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BBC</varname></td><td>店屋の商品<code>[1]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BBE</varname></td><td>店屋の商品<code>[2]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BC0</varname></td><td>店屋の商品<code>[3]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BC2</varname></td><td>店屋の商品<code>[4]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BC4</varname></td><td>店屋の商品<code>[5]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BC6</varname></td><td>店屋の商品<code>[6]</code> アイテム ID</td></tr>
						<tr><td><varname>$2BCA</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[0]</code> 価格; <varname>$2BBA</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BCD</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[1]</code> 価格; <varname>$2BBC</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BD0</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[2]</code> 価格; <varname>$2BBE</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BD3</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[3]</code> 価格; <varname>$2BC0</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BD6</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[4]</code> 価格; <varname>$2BC2</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BD9</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[5]</code> 価格; <varname>$2BC4</varname> が非ゼロのときに限る</td></tr>
						<tr><td><varname>$2BDC</varname>（<literal>3</literal> バイト長）</td><td>店屋の商品<code>[6]</code> 価格; <varname>$2BC6</varname> が非ゼロのときに限る</td></tr>
					</tbody>
				</table>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C3CF84</varname> 呼び出しの事後条件
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.shop.hack.C3CEC6 -->
</section> <!-- dq3.shop.hack -->
</section> <!-- dq3.shop -->
