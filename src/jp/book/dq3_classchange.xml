<?xml version="1.0" encoding="UTF-8"?>

<section id="dq3.classchange"><?dbhtml filename="dq3_classchange.html" ?>
<title>転職解析</title>
<indexterm id="term.dq3.classchange.1"><primary>転職</primary><secondary>DQ3</secondary></indexterm>
<indexterm id="term.dq3.classchange.2"><primary>職業</primary><secondary>DQ3</secondary></indexterm>
<para>
	ダーマの神殿にいる神官が行う転職手続きを処理するプログラムの逆アセンブルコードを解析する。
	「転職したいキャラクターの性格によって神官が感想を漏らす」処理と、
	「転職直後のキャラクターの装備をセットする」処理がファミコン版にはなかった機能だが、
	前者は性格と新職業の対をキーにするデータ構造の存在をにおわせるし、
	後者は職業とその装備可能アイテムの線形リスト探索処理を想像させられて、
	興味をそそられる解析テーマとなっている。
</para>

<section id="dq3.classchange.hack">
<title>解析</title>
<para>
	<link linkend="dq3.classchange.hack.C3E477">転職処理のメインルーチン</link>は、
	他の店屋系統の共通処理サブルーチンが連なるバンク
	<varname>$C3</varname> の逆アセンブルコードをファイルに書き出し、
	その後半部をテキストエディターで眺めていれば見つかるものだ。
</para>

<section id="dq3.classchange.hack.C3E477">
<title>転職共通処理サブルーチン</title>
<para>
	サブルーチン <varname>$C3E477</varname> は、
	ダーマの神殿の中央にいる神官に「はなす」と呼び出される処理である。
	逆アセンブルコードで見ると大変長いプログラムのようだが、
	台詞表示サブルーチン呼び出しと「はい・いいえ」メニューウィンドウの表示サブルーチンの呼び出しが多いため、
	解読は本質的に容易い。
</para>
<itemizedlist>
	<listitem>
		<para>
			台詞「ここは転職をつかさどるダーマの神殿」(ID: <literal>#$0B10</literal>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャンセルボタン or 「いいえ」⇒【転職しない】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【だれを】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「どなたの職業をかえたいのじゃ？」(ID: <literal>#$0B12</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					ウィンドウ「だれを」を表示し、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン ⇒【やっぱりやめる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<varname>$33D6</varname>, <varname>$BE7D</varname>, <varname>Y</varname> に選択キャラクターの並び順 (<literal>0,1,2,3</literal>) をセットする。
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター状態取得サブルーチン <varname>$C43F87</varname> を呼び出し、
					パーティにいるキャラクター (<varname>Y</varname>) の生死状態値を取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A &amp; 0010h</code> ⇒【死んでいる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					キャラクター職業取得サブルーチン <varname>$C46951</varname> を呼び出し、
					パーティにいるキャラクター (<varname>Y</varname>) の職業 ID を取得 (<varname>X</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$33DA = X;</code> 職業 ID
				</para>
			</listitem>
			<listitem>
				<para>
					職業構造体データアドレス取得サブルーチン <varname>$C4691B</varname> を呼び出し、
					職業 (<varname>X</varname>) のデータアドレスを取得 (<varname>X</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$BE77 = X;</code> 職業データアドレス
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター主人公判定サブルーチン <varname>$C42DA1</varname> を呼び出し、
					パーティにいるキャラクター (<varname>Y</varname>) が主人公であるか、テスト (<varname>Carry</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							主人公でない ⇒【レベルテスト】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「おろか者め！ 勇者をやめたいというのか？」(ID: <literal>#$0B14</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにも】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【死んでいる】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「たわけが！ 死んでおるではないか」(ID: <literal>#$0B13</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにも】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【やっぱりやめる】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「ふむ…やめると申すか？」(ID: <literal>#$0B1C</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにも】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【レベルテスト】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャラクターレベル取得サブルーチン <varname>$C42FEB</varname> を呼び出し、
					パーティにいるキャラクター (<varname>Y</varname>) のレベルを取得 (<varname>X</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>X &gt;= 20</code> ⇒【どの職業】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「未熟者の分際で職を変えたいとは～」(ID: <literal>#$0B15</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにも】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【どの職業】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「○○○○がなりたいのはどの職業じゃな？」(ID: <literal>#$0B16</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					職業リストウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
						キャンセルボタン ⇒【やっぱりやめる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$33DC = A;</code> 職業 ID
				</para>
			</listitem>
			<listitem>
				<para>
					職業名取得サブルーチン <varname>$C4691B</varname> を呼び出し、
					職業 (<varname>A</varname>) の名前文字列 ID を取得 (<varname>X</varname>) する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$BE77 = X;</code> 名前文字列 ID
				</para>
			</listitem>
			<listitem>
				<para>
					台詞「○○○○は ××××になりたいと申すか？」(ID: <literal>#$0B17</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【どの職業】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					選択した職業 (<varname>$33DC</varname>) と今の職業 (<varname>$33DA</varname>) を比較する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							異なる職業である ⇒【確認】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「○○○○はもうそれになっているぞ」(ID: <literal>#$0B18</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【どの職業】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【確認】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.classchange.hack.C3E5F8">サブルーチン <varname>$E5F8</varname></link> を呼び出し、
					キャラクターの性格によっては神官がコメントを出す。
				</para>
			</listitem>
			<listitem>
				<para>
					台詞「一度レベル 1 に戻り～」(ID: <literal>#$0B19</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【やっぱりやめる】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「おお 神よ ○○○○が新たな職につくことを～」(ID: <literal>#$0B1A</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					効果音 (ID: <literal>#$0028</literal>) を鳴らし、鳴り終えるまで待つ。
				</para>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.classchange.hack.C3E79C">サブルーチン <varname>$E79C</varname></link> を呼び出し、
					必要ならば「さとりのしょ」をキャラクターの所持品から削除する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>A = $33D6;</code> 選択キャラクター
				</para>
			</listitem>
			<listitem>
				<para>
					<code>X = $33DC;</code> 選択職業
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C46987</varname> を呼び出し、
					転職後のキャラクターのパラメータ・ステータス（実は呪いが解ける）を決定する。
				</para>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.classchange.hack.C3E7CC">サブルーチン <varname>$C3E7CC</varname></link> を呼び出し、
					選択キャラクターの装備品を変更する。
				</para>
			</listitem>
			<listitem>
				<para>
					台詞「よろしい。では今から○○○○は××××じゃ！」(ID: <literal>#$0B1B</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにも】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【やっぱりやめる】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「ふむ… やめると申すか？ それもよろしかろう」(ID: <literal>#$0B1C</literal>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【ほかにも】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「ほかにも転職したい者はおるかな？」(ID: <literal>#$0B1D</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセルボタン or 「いいえ」⇒【終了】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【だれを】へジャンプ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【転職しない】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「転職をせぬのじゃな？ まあそれもよかろう」(ID: <literal>#$0B11</literal>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【終了】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「ではゆくがよい」(ID: <literal>#$0B1E</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>

<section id="dq3.classchange.hack.C3E5F8">
<title>性格によっては神官がコメントを出すサブルーチン</title>
<para>
	サブルーチン <varname>$E5F8</varname> は、転職するキャラクターの性格によって、
	神官が余計な一言をはなす処理である。
	以下のような流れになる。
</para>
<itemizedlist>
	<listitem>
		<para>
			【事前条件】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>$33D6</varname> == 転職したいキャラクターの並び順
				</para>
			</listitem>
			<listitem>
				<para>
					<varname>$33DC</varname> == 新職業 ID
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			キャラクター性格取得サブルーチン <varname>$C42E53</varname> を呼び出し、
			パーティーにいるキャラクター (<varname>A</varname>) の性格を取得 (<varname>Y</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			構造体データアドレス取得サブルーチン <varname>$C90501</varname> を呼び出し、
			性格 (<varname>Y</varname>) データ格納アドレスを取得 (<varname>$78</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = $33DC;</code> 新職業 ID
		</para>
	</listitem>
	<listitem>
		<para>
			性格名取得サブルーチン <varname>$C42F28</varname> を呼び出し、
			性格 (<varname>Y</varname>) の名前を表す文字列 ID を取得 (<varname>Y</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			転職したい職業の職業 ID (<varname>X</varname>) により、
			性格構造体データのフィールド値を以下のように取得 (<varname>A</varname>) する。
			フィールドの値は必要に応じて右シフトしたものになる。
		</para>
		<table id="table.dq3.C3E5F8.1" class="lighttable">
			<caption>$E5F8 職業による分岐</caption>
			<thead>
				<tr><th>ID</th><th>職業</th><th>フィールド</th></tr>
			</thead>
			<tbody>
				<tr><td><literal>#$0000</literal></td><td>せんし      </td><td><code>A = data[#$0007] &amp; 0780</code></td></tr>
				<tr><td><literal>#$0001</literal></td><td>ぶとうか    </td><td><code>A = data[#$0008] &amp; 0078</code></td></tr>
				<tr><td><literal>#$0002</literal></td><td>まほうつかい</td><td><code>A = data[#$0009] &amp; 0078</code></td></tr>
				<tr><td><literal>#$0003</literal></td><td>そうりょ    </td><td><code>A = data[#$0008] &amp; 0780</code></td></tr>
				<tr><td><literal>#$0004</literal></td><td>しょうにん  </td><td><code>A = data[#$000A] &amp; 0780</code></td></tr>
				<tr><td><literal>#$0005</literal></td><td>あそびにん  </td><td><code>A = data[#$000A] &amp; 0078</code></td></tr>
				<tr><td><literal>#$0006</literal></td><td>とうぞく    </td><td><code>A = data[#$000B] &amp; 0078</code></td></tr>
				<tr><td><literal>#$0007</literal></td><td>けんじゃ    </td><td><code>A = data[#$0009] &amp; 0780</code></td></tr>
			</tbody>
		</table>
	</listitem>
	<listitem>
		<para>
			<varname>A</varname> レジスタの値を基にジャンプテーブルで定義されたアドレスにジャンプし、
			転職したいキャラクターの性格と、
			転職したい職業に応じたコメントをダーマの神官に話させる。
		</para>
		<table id="table.dq3.C3E5F8.2" class="lighttable">
			<caption>$E5F8 職業による分岐</caption>
			<thead>
				<tr><th>A</th><th>Address</th><th>コメント</th></tr>
			</thead>
			<tbody>
				<tr><td><literal>#$0000</literal></td><td><varname>$E6E3</varname></td><td>コメントなし</td></tr>
				<tr><td><literal>#$0001</literal></td><td><varname>$E6E4</varname></td><td>「ねっからの××××じゃのう」</td></tr>
				<tr><td><literal>#$0002</literal></td><td><varname>$E6F4</varname></td><td>「なんという××××じゃ」</td></tr>
				<tr><td><literal>#$0003</literal></td><td><varname>$E704</varname></td><td>「けっこう わらかしてくれるぞ」</td></tr>
				<tr><td><literal>#$0004</literal></td><td><varname>$E71C</varname></td><td>「さすが××××性格だけのことはあるのう」</td></tr>
				<tr><td><literal>#$0005</literal></td><td><varname>$E726</varname></td><td>「これも世の中がいけないからかの」</td></tr>
				<tr><td><literal>#$0006</literal></td><td><varname>$E744</varname></td><td>「ちょっと大変そうな気もするが」</td></tr>
				<tr><td><literal>#$0007</literal></td><td><varname>$E762</varname></td><td>「うけねらいかの？」</td></tr>
				<tr><td><literal>#$0008</literal></td><td><varname>$E77A</varname></td><td>「天職ともいえるナイスチョイスじゃのう」</td></tr>
				<tr><td><literal>#$0009</literal></td><td><varname>$E784</varname></td><td>「ずいぶん成長したものよのう」</td></tr>
			</tbody>
		</table>
	</listitem>
	<listitem>
		<para>
			呼び出し元に制御を戻す。
		</para>
	</listitem>
</itemizedlist>
</section> <!-- dq3.classchange.hack.C3E5F8 -->

<section id="dq3.classchange.hack.C3E79C">
<title>「さとりのしょ」を消費するサブルーチン</title>
<para>
	サブルーチン <varname>$E79C</varname> は必要に応じて、
	転職するキャラクターの所持品から「さとりのしょ」を一つだけ消費する。
</para>
<itemizedlist>
	<listitem>
		<para>
			【事前条件】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>$33D6</varname> == キャラクターのパーティでの並び順
				</para>
			</listitem>
			<listitem>
				<para>
					<varname>$33DC</varname> == 新職業 ID
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			新職業 ID (<varname>$33DC</varname>) が「けんじゃ」のそれ (<literal>#$0007</literal>) と同じであるかをテストする。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					異なる ⇒ 呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>A = $33D6;</code> 並び順
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクター職業 ID 取得サブルーチン <varname>$C46951</varname> を呼び出し、
			パーティのキャラクター (<varname>A</varname>) の職業 ID を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					転職前の職業 (<varname>A</varname>) が「あそびにん」(<literal>#$0005</literal>) ⇒ 呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>A = #$0088;</code> 「さとりのしょ」アイテム ID
		</para>
	</listitem>
	<listitem>
		<para>
			<code>X = $33D6;</code> 並び順
		</para>
	</listitem>
	<listitem>
		<para>
			アイテムサブルーチン <varname>$C44DC0</varname> を呼び出し、
			アイテム (<varname>A</varname>) をパーティのキャラクター (<varname>X</varname>) が何番目に所持しているか (<varname>A</varname>) 調べる。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					所持していない ⇒ 呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			アイテム削除サブルーチン <varname>$C4487F</varname> を呼び出し、
			キャラクター (<varname>X</varname>) の所持品から（<varname>A</varname> 番目の）アイテムを削除する。
		</para>
	</listitem>
</itemizedlist>
<para>
「あそびにん」が「けんじゃ」に転職する場合、「さとりのしょ」を持ち物としてあっても消費されないことがわかる。
</para>
</section> <!-- dq3.classchange.hack.C3E79C -->
</section> <!-- dq3.classchange.hack.C3E477 -->

<section id="dq3.classchange.hack.C3E7CC">
<title>装備品の交換</title>
<para>
	サブルーチン <varname>$C3E7CC</varname> は装備品の交換を行う処理だ。
	<varname>A</varname> レジスタの値を変えつつ、補助サブルーチンを呼び続ける。
</para>
<itemizedlist>
	<listitem>
		<para>
			【事前条件】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>A</varname> == 対象となる職業構造体データの格納アドレス
				</para>
			</listitem>
			<listitem>
				<para>
					<varname>X</varname> == ??
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>$78 = A;</code> キャラクターアドレス
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = 0</code> としてから、<link linkend="dq3.classchange.hack.C3E7ED">サブルーチン <varname>$E7ED</varname></link> を呼び出して、最適な武器を装備させる。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = 1</code> としてから、<link linkend="dq3.classchange.hack.C3E7ED">サブルーチン <varname>$E7ED</varname></link> を呼び出して、最適なよろいを装備させる。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = 2</code> としてから、<link linkend="dq3.classchange.hack.C3E7ED">サブルーチン <varname>$E7ED</varname></link> を呼び出して、最適な盾を装備させる。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>A = 3</code> としてから、<link linkend="dq3.classchange.hack.C3E7ED">サブルーチン <varname>$E7ED</varname></link> を呼び出して、最適なかぶとを装備させる。
		</para>
	</listitem>
	<listitem>
		<para>
			呼び出し元に制御を戻す。
		</para>
	</listitem>
</itemizedlist>

<section id="dq3.classchange.hack.C3E7ED">
<title>ある装備種別に関して最適なものを調べる</title>
<para>
	サブルーチン <varname>$E7ED</varname> は、転職キャラクターに最適な装備品を検索し、可能ならば装備させる処理である。
	まず、転職したいキャラクターの持ち物から、
	職業・性別・呪いを加味した上で、
	装備可能な道具をすべてチェックする。
	そのうち一番パラメータが上昇するものを検索する。
	次に、ふくろから同様に検索する。
	最後に、検索が成功していれば、その道具をそのキャラクターに装備させる、
	という処理である。
</para>
<itemizedlist>
	<listitem>
		<para>
			【事前条件】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>$78</varname> = キャラクターアドレス
				</para>
			</listitem>
			<listitem>
				<para>
					<varname>A</varname> == アイテム種別 (<literal>0,1,2,3</literal>)
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<code>$2BB8 = A;</code> アイテム種別 (<literal>0,1,2,3</literal>)
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクター所持品個数取得サブルーチン <varname>$C446A4</varname> を呼び出し、
			キャラクター (<varname>$78</varname>) の所持品個数を取得 (<varname>A</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$2BB2 = A; $7A = A;</code> 所持品個数
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$2BBA = 0;</code> アイテムを装備品として見たときの、ステータス上昇値を格納するためのアドレスとなる。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$2BBC = #$FFFF; $2BBE = #$FFFF;</code> それぞれアドレス差とアイテム ID を格納するためのアドレスとなる。
		</para>
	</listitem>
	<listitem>
		<para>
			キャラクター所持品個数取得サブルーチン <varname>$C44708</varname> を呼び出し、
			キャラクター (<varname>$78</varname>) の最初の所持品が格納されているアドレスを取得 (<varname>Y</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$2BB6 = Y - 1;</code> キャラクターの最初の所持品が格納されているアドレス
		</para>
	</listitem>

	<listitem>
		<para>
			【キャラクターの所持品を調べる】
		</para>
		<para>
			<varname>$7A</varname> をループカウンターとして、キャラクターの持っている道具を調べる。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>X = $0000,Y &amp; 00FFh;</code> キャラクターの所持品アイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					アイテム種別取得サブルーチン <varname>$C44FE2</varname> を呼び出し、
					アイテム (<varname>X</varname>) の種別を取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A != $2BB8</code> ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					アイテム呪い属性取得サブルーチン <varname>$C4508A</varname> を呼び出し、
					アイテム (<varname>X</varname>) が呪われているかどうか (<varname>Carry</varname>) を調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							呪われている ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					キャラクター装備後パラメータ計算サブルーチン <varname>$C44A72</varname> を呼び出し、
					キャラクターが装備品を装備した場合のパラメータを取得する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							パラメータが <varname>$2BBA</varname> <emphasis>以下</emphasis> ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$2BBA = A;</code> パラメータ上昇値
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$2BBC = Y - $2BB6;</code> そのアイテムの <varname>$2BB6</varname> 基準のアドレスオフセット
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$2BBE = X;</code> そのアイテムのアイテム ID
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【所持品調査終了】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャラクターの所持品個数 (<varname>$2BB2</varname>) をチェックする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>$2BB2 == 12</code> ⇒【<varname>$2BBC</varname> テスト】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$2BB4 = 0;</code> 候補アイテム個数カウンター
				</para>
			</listitem>
			<listitem>
				<para>
					<code>Y = #$FFFF;</code> ふくろ走査カウンター
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【ふくろの中身を調べる】
		</para>
		<para><varname>Y</varname> = <literal>0</literal> から <literal>255</literal> まで、ふくろの道具を調べる。</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A = $3825,Y &amp; #$00FF;</code> アイテム<code>[Y]</code> の個数
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A == 0</code> ⇒【ふくろ調査終了】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>X = $3725,Y &amp; #$00FF;</code> アイテム<code>[Y]</code> のアイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					アイテム種別取得サブルーチン <varname>$C44FE2</varname> を呼び出し、
					アイテム (<varname>X</varname>) の種別を取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A != $2BB8</code> ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					アイテム呪い属性取得サブルーチン <varname>$C4508A</varname> を呼び出し、
					アイテム (<varname>X</varname>) が呪われているかどうか (<varname>Carry</varname>) を調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							呪われている ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					キャラクター装備後パラメータ計算サブルーチン <varname>$C44A72</varname> を呼び出し、
					キャラクターが装備品を装備した場合のパラメータを取得する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							呪われているか、パラメータ値が <varname>$2BBA</varname> <emphasis>以下</emphasis> ⇒ ループを continue する。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>$2BBA = A;</code> パラメータ上昇値
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$2BBC = Y - $2BB6;</code> そのアイテムの <varname>$2BB6</varname> 基準のアドレスオフセット
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$2BBE = X;</code> そのアイテムのアイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					<code>++$2BB4</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【ふくろ調査終了】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>$2BB4</varname> をチェックする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>$2BB4 == 0</code> ⇒【<varname>$2BBC</varname> テスト】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>A = $2BBE;</code> パラメータ上昇が最も大きい装備可能アイテムのアイテム ID
				</para>
			</listitem>
			<listitem>
				<para>
					道具袋アイテム減らしサブルーチン <varname>$C453F7</varname> を呼び出し、
					道具袋に入っているアイテム (<varname>A</varname>) の個数を <literal>1</literal> だけ減らす。
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター持ち物変更サブルーチン <varname>$C44739</varname> を呼び出し、
					キャラクター (<varname>$78</varname>) の持ち物にアイテム (<varname>A</varname>) を追加し、配列を並び替える。
				</para>
			</listitem>
			<listitem>
				<para>
					<varname>$2BBC</varname> = キャラクターの持ち物<code>[0]</code> アドレスからのオフセット;
					装備させたいアイテムを格納しているアドレス
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【<varname>$2BBC</varname> テスト】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<varname>$2BBC</varname> を調べる。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>$2BBC &lt; 0</code> ⇒【終了】へジャンプ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					キャラクター装備変更サブルーチン <varname>$C44C1B</varname> を呼び出し、
					キャラクター (<varname>$78</varname>) にアイテム (<varname>A</varname>) を装備させる。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			【終了】
		</para>
		<itemizedlist>
			<listitem>
				<para>
					呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.classchange.hack.C3E7ED -->
</section> <!-- dq3.classchange.hack.C3E7CC -->
</section> <!-- dq3.classchange.hack -->
</section> <!-- dq3.classchange -->
