<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % replacement SYSTEM "replacement.xml">
  %replacement;
]>
<section id="dq6.talk"><?dbhtml filename="dq6_talk.html" ?>
<title>はなす</title>
<para>
本節では移動コマンド「はなす」の実装詳細について述べる。
まずは「はなす」コマンドの対象であるオブジェクトのすべてを表現する ROM データの構造について説明する。
また、それらの構造それぞれについて、その型のオブジェクトデータを解釈して得られるテキスト CSV ファイルを提示する。
それから「はなす」コマンドを実行するときのプログラムの手順を、可能な限りコードを引用した上で説明する。
</para>

<section id="dq6.talk.model">
<title>モデル</title>
<para>
移動モードではプレイヤーの操作するパーティーとは他に、人々や動物、ときには魔物のが画面内をフラフラとしている。
基本的にはパーティーの先頭者の正面にこれらのオブジェクトが存在すれば、コマンド「はなす」が成功することになっている。
これらの「はなす対象オブジェクト」のデータとして、いつものように配列の形式で定義されている。
以下、この「はなす対象オブジェクト」の構造を説明する。
</para>

<section id="dq6.talk.model.FF08DA">
<title>構造体 <varname>$FF08DA</varname>: 「はなす」対象簡易版</title>
<para>
ROM のアドレス <varname>$FF08DA</varname> には次の表で示すような型のオブジェクトが配列されている：
</para>
<table id="table.dq6.talk.FF08DA" class="lighttable">
  <caption>構造体 $FF08DA</caption>
  <thead>
    <tr><th>オフセット</th><th>桁</th><th>属性</th></tr>
  </thead>
  <tbody>
    <tr><td><literal>#$00</literal></td><td>#$3F</td><td>（調査中）</td></tr>
    <tr><td><literal>#$00</literal></td><td>#$C0</td><td rowspan="2">スプライト ID</td></tr>
    <tr><td><literal>#$01</literal></td><td>#$3F</td></tr>
    <tr><td><literal>#$01</literal></td><td>#$C0</td><td>向き</td></tr>
    <tr><td><literal>#$02</literal></td><td>#$FF</td><td rowspan="2">MX</td></tr>
    <tr><td><literal>#$03</literal></td><td>#$01</td></tr>
    <tr><td><literal>#$03</literal></td><td>#$FE</td><td rowspan="2">MY</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$03</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$1C</td><td>LV</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$20</td><td>描画</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$40</td><td>（未使用）</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$80</td><td>（未使用）</td></tr>
    <tr><td><literal>#$05</literal></td><td>#$FF</td><td rowspan="3">歩行処理サブルーチン</td></tr>
    <tr><td><literal>#$06</literal></td><td>#$FF</td></tr>
    <tr><td><literal>#$07</literal></td><td>#$FF</td></tr>
    <tr><td><literal>#$08</literal></td><td>#$FF</td><td rowspan="2">メッセージ ID</td></tr>
    <tr><td><literal>#$09</literal></td><td>#$FF</td></tr>
  </tbody>
</table>

<variablelist>
  <varlistentry>
    <term>スプライト ID</term>
    <listitem>
      <para>
        スプライト ID とは、「はなす」対象オブジェクトの図像的表現であるスプライトを管理するための ID の値をとる属性だ。
        スプライト ID と内容との対応については別項で述べたい。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>向き</term>
    <listitem>
      <para>
        向きとは、「はなす」対象オブジェクトのスプライトの「向き」を示す 0 から 4 の値をとる属性だ。
        これは初期値であり、このオブジェクトが配置される空間にプレイヤーが入場した瞬間にしか保証されない。
      </para>
      <para>
        次に示す表は向きの値と意味の対応だ：
      </para>
      <table id="table.dq6.talk.FF80DA.direction" class="lighttable">
        <caption>向き</caption>
        <thead>
          <tr><th>値</th><th>向き</th></tr>
        </thead>
        <tbody>
          <tr><td>0</td><td>上</td></tr>
          <tr><td>1</td><td>右</td></tr>
          <tr><td>2</td><td>下</td></tr>
          <tr><td>3</td><td>左</td></tr>
        </tbody>
      </table>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>MX</term>
    <listitem>
      <para>
        MX とは、「はなす」対象オブジェクトのスプライトを配置する空間の M 座標系における位置の X 座標成分のための属性だ。
      </para>
      <para>
        座標系については別の節で説明したいが、本作の移動モードでは座標系は M と W の二つがある。
        スプライトの関係するオブジェクトについては、前者で管理されている。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>MY</term>
    <listitem>
      <para>
        MY とは、「はなす」対象オブジェクトのスプライトを配置する空間の M 座標系における位置の Y 座標成分のための属性だ。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>LV</term>
    <listitem>
      <para>
        LV とは、「はなす」対象オブジェクトのスプライト配置に関する情報のための属性であり、
        同一空間内の対象オブジェクト群を仮想的な標高で分類するために用いられる。
      </para>
      <para>
        これはわかりづらいので例を出す。
        ロンガデセオのホックは最初は家屋の屋上にいる。こういう状況を表現するための値が LV だ。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>描画</term>
    <listitem>
      <para>
        描画とは、「はなす」対象オブジェクトを実際に描画するかどうかを示すブーリアン値の属性だろう。詳細不明。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>歩行処理サブルーチン</term>
    <listitem>
      <para>
        歩行処理サブルーチンとは、「はなす」コマンドが実行されていない状態において、
        オブジェクトがたまに移動したり、あるいは静止したままだったりする様子を与えるコードのアドレス値の属性だ。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>メッセージ ID</term>
    <listitem>
      <para>
        メッセージ ID とは、このオブジェクトに対して「はなす」コマンドが実行されるときに、
        画面テキストウィンドウに出力されるメッセージの ID の値の属性だ。
      </para>
      <para>
        移動モードのテキストについては <xref linkend="dq6.text"/> を参照して欲しい。
      </para>
    </listitem>
  </varlistentry>
</variablelist>
<para>
この型は面白くない。「はなす」コマンド実行によって引き起こされる結果が常に同じだからだ。
それどころか、実際のデータを観察してみると、メッセージの指定すらなく、
単に画面内にいることしか目的としないようなオブジェクトさえ存在する。
一般には、「はなす」コマンドの対象として意味がある振る舞いを提供するのは、次節で示す型だ。
</para>
</section> <!-- dq6.talk.model.FF08DA -->

<section id="dq6.talk.model.FF243C">
<title>構造体 <varname>$FF243C</varname>: 「はなす」対象標準版</title>
<para>
ROM のアドレス <varname>$FF243C</varname> には次の表で示すような型のオブジェクトが配列されている：
</para>

<table id="table.dq6.talk.model.FF243C" class="lighttable">
  <caption>構造体 $FF243C</caption>
  <thead>
    <tr><th>オフセット</th><th>桁</th><th>属性</th></tr>
  </thead>
  <tbody>
    <tr><td><literal>#$00</literal></td><td>#$3F</td><td>（調査中）</td></tr>
    <tr><td><literal>#$00</literal></td><td>#$C0</td><td rowspan="2">スプライト ID</td></tr>
    <tr><td><literal>#$01</literal></td><td>#$3F</td></tr>
    <tr><td><literal>#$01</literal></td><td>#$C0</td><td>向き</td></tr>
    <tr><td><literal>#$02</literal></td><td>#$FF</td><td rowspan="2">MX</td></tr>
    <tr><td><literal>#$03</literal></td><td>#$01</td></tr>
    <tr><td><literal>#$03</literal></td><td>#$FE</td><td rowspan="2">MY</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$03</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$1C</td><td>LV</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$20</td><td>描画</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$40</td><td>ウィンドウ消去</td></tr>
    <tr><td><literal>#$04</literal></td><td>#$80</td><td>（未使用）</td></tr>
    <tr><td><literal>#$05</literal></td><td>#$FF</td><td rowspan="3">歩行処理サブルーチン</td></tr>
    <tr><td><literal>#$06</literal></td><td>#$FF</td></tr>
    <tr><td><literal>#$07</literal></td><td>#$FF</td></tr>
    <tr><td><literal>#$08</literal></td><td>#$FF</td><td rowspan="3">はなす処理サブルーチン</td></tr>
    <tr><td><literal>#$09</literal></td><td>#$FF</td></tr>
    <tr><td><literal>#$0A</literal></td><td>#$FF</td></tr>
  </tbody>
</table>
<para>
属性のほとんどが前節と共通している。以下、こちらの構造体に固有の属性を述べる。
</para>
<variablelist>
  <varlistentry>
    <term>ウィンドウ消去</term>
    <listitem>
      <para>
        ウィンドウ消去とは、ブーリアン値の属性であり、
        「はなす」コマンドの出力テキストウィンドウを処理後に消去するかどうかを示すためのものだ。
      </para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>はなす処理サブルーチン</term>
    <listitem>
      <para>
        はなす処理サブルーチンとは、対象オブジェクトの会話内容の出力を主として実行するための処理コードの開始アドレスを指定する属性だ。
      </para>
      <para>
        単に台詞を表示するだけでなく、店屋処理に制御を委譲したり、フラグを参照や更新をしたり、あるいはゲーム上のイベントを引き起こしたりする等、
        柔軟な振る舞いを実現するのにこの属性は重要だ。
      </para>
    </listitem>
  </varlistentry>
</variablelist>
</section> <!-- dq6.talk.model.FF243C -->

<section id="dq6.talk.model.data">
<title>データ</title>
<para>
<xref linkend="appendix.b"/> で前述の二構造体オブジェクトデータを解釈して作成した CSV ファイルを提供する。
</para>
</section> <!-- dq6.talk.model.data -->
</section> <!-- dq6.talk.model -->

<section id="dq6.talk.process">
<title>処理手順</title>
<para>
TBW
</para>
</section> <!-- dq6.talk.process -->
</section> <!-- dq6.talk -->
