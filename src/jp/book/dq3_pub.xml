<?xml version="1.0" encoding="UTF-8"?>

<section id="dq3.pub"><?dbhtml filename="dq3_pub.html" ?>
<title>ルイーダの酒場解析</title>
<indexterm id="term.dq3.pub"><primary>ルイーダの酒場</primary><secondary>DQ3</secondary></indexterm>
<para>
本節ではルイーダの酒場での定型処理を解析する。
つまり、パーティーにいる仲間キャラクターを酒場から呼び出したり、
逆に預けたり、どんなキャラクターが酒場にいるのかを調べたりする処理を見る。
</para>

<section id="dq3.pub.hack">
<title>解析</title>
<para>
ゲーム開始時直後の状態や、バラモスを征伐してきてアリアハン王に報告する前などの、特定のイベント中でなければ、
酒場の女主人ルイーダに「はなす」とすぐに<link linkend="dq3.pub.hack.C3D760">サブルーチン <varname>$C3D760</varname></link> が呼ばれる。
ここから処理を辿ることにする。
このサブルーチンと、その補助サブルーチン内の台詞表示は
サブルーチンとして <varname>$C1A92E</varname> を、
ナレーション系のメッセージ表示にはサブルーチン <varname>$C1A8D4</varname> がそれぞれ用いられているようなので、
それを手掛かりに逆アセンブルコードを読み解いていくのが基本だ。
</para>

<section id="dq3.pub.hack.C3D760">
<title>ルイーダの酒場共通処理サブルーチン</title>
<para>
サブルーチン <varname>$C3D760</varname> が、ルイーダの酒場での通常処理を実装している。
</para>
<itemizedlist>
	<listitem>
		<para>
			台詞「ここはルイーダの店～」(ID: <literal>#$0AC5</literal>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>【メニュー表示】</para>
		<para>
			「なかまをよびだす・なかまをあずける・めいぼをみる」ウィンドウを表示し、
			プレイヤーの入力を待つ。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャンセルボタン抜け⇒【またいらしてね】へ制御をスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					なかまをあずける⇒【なかまをあずける】へ制御をスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					なかまをよびだす⇒【なかまをよびだす】へ制御をスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					めいぼをみる⇒【めいぼをみる】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【またいらしてね】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「じゃまたいらしてね」(ID: <literal>#$0ADA</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【なかまをあずける】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.pub.hack.C3D7BB">「なかまをあずける」処理サブルーチン</link>を呼び出す。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにご用は】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【なかまをよびだす】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.pub.hack.C3D8E8">「なかまをよびだす」処理サブルーチン</link>を呼び出す。
				</para>
			</listitem>
			<listitem>
				<para>
					【ほかにご用は】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【めいぼをみる】</para>
		<itemizedlist>
			<listitem>
				<para>
					<link linkend="dq3.pub.hack.C3D983">「めいぼをみる」処理サブルーチン</link>を呼び出す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【ほかにご用は】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「ほかに ご用は？」(ID: <literal>#$0AD9</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【メニュー表示】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
<para>
メニューウィンドウを表示して、プレイヤーの選択項目に従って処理を振り分けるというのが、
このサブルーチンの役割のようだ。
</para>
</section> <!-- dq3.pub.hack.C3D760 -->

<section id="dq3.pub.hack.C3D7BB">
<title>「なかまをあずける」処理サブルーチン</title>
<para>
サブルーチン <varname>$D7BB</varname> は「なかまをあずける」を選択したら呼び出すサブルーチンだ。
</para>
<itemizedlist>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			パーティの人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 1</code> のとき、台詞「あずけるって…… だれを？」(ID: <literal>#$0AC6</literal>) を表示する。
					そのあと、サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【だれを】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「だれを おあずかりすれば いいの？」(ID: <literal>#$0AC8</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					だれをウィンドウを表示して、プレイヤーの入力を待つ
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜け⇒【キャンセル 1】へ制御をスキップする。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					選択したキャラクター (<varname>A</varname>) の登録インデックスを得る (<varname>X</varname>) ため、
					サブルーチン <varname>$C42F5E</varname> を呼び出す。
				</para>
			</listitem>
			<listitem>
				<para>
					選択したキャラクター (<varname>A</varname>) が主人公か否かをテストするべく、
					サブルーチン <varname>$C42DA1</varname> を呼び出す。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							主人公ではなかったら【テスト後】へ制御をスキップする。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$CC8C5A</varname> を呼び出して、バラモスを倒していることと、
					ゾーマを倒していること
					(<code>($3546 &amp; 0004h) &amp;&amp; ($3545 &amp; 0004h)</code>)
					をテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							両方のビットがセットされていれば【テスト後】へ制御をスキップする。
						</para>
					</listitem>
					<listitem>
						<para>
							どちらかのビットがゼロであれば、
							台詞「○○○○さんがいなくなったら旅の指揮を執る人が～」(ID: <literal>#$0AC9</literal>) を表示する。
							そのあと、サブルーチン呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【キャンセル 1】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「あら おやめになるのね」(ID: <literal>#$0AD8</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【死人だけ】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「死んでるひと ばかりで旅には 出られなくてよ」(ID: <literal>#$0AC7</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【テスト後】</para>
		<itemizedlist>
			<listitem>
				<para>
					生死判定サブルーチン <varname>$C43F87</varname> を呼び出し、
					キャラクター (<varname>A</varname>) の生死を表現するデータを取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャラクターが死んでいれば (<code>A &amp; #$0010</code>)
							【死んでいるキャラクターを預けようとする】へ制御をスキップする。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.pub.hack.C3D8C8">サブルーチン <varname>$D8C8</varname></link> を呼び出し、
					パーティに生きている人が二人以上いるかをテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							テストが失敗した場合は【死人だけ】に制御を移す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「○○○○さんをお預かりすればいいのね？」(ID: <literal>#$0ACD</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜けまたは「いいえ」と答えた場合は【キャンセル 1】に制御を移す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「じゃあ○○○○さん。しばらくお休みだわよ」(ID: <literal>#$0ACE</literal>) を表示する。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【装備品を袋に】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「装備しているもの以外はそのふくろに～」(ID: <literal>#$0ACF</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					フラグテストサブルーチン <varname>$C909AE</varname> を呼び出し、
					<emphasis><varname>$7E353E</varname> の最下位ビットから <literal>#$000F</literal> ビット目に位置するビット</emphasis> をテストする。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							ビットがゼロの場合、
						</para>
						<itemizedlist>
							<listitem>
								<para>
									台詞「こうしておかないと大切なものを～」(ID: <literal>#$0AD0</literal>) を表示する。
								</para>
							</listitem>
							<listitem>
								<para>
									フラグセットサブルーチン <varname>$C908F0</varname> を呼び出し、同ビットをセットする。
								</para>
							</listitem>
						</itemizedlist>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<link linkend="dq3.pub.hack.C3DA97">サブルーチン <varname>$C3DA97</varname></link> を呼び出し、アイテム移動を行う。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C42A6D</varname> を呼び出し、
					キャラクターのデータ格納アドレス配列 (<varname>$36E8,X</varname>) を更新する。
				</para>
			</listitem>
			<listitem>
				<para>
					TODO <varname>$C3BD64</varname>
				</para>
			</listitem>
			<listitem>
				<para>
					キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
					パーティの人数を取得 (<varname>A</varname>) する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A &lt; 2</code> ならば、
							サブルーチン呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「ほかにも誰かお預かりしましょうか」(ID: <literal>#$0AD1</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜けまたは「いいえ」と答えた場合は
							サブルーチン呼び出し元に制御を戻す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					【だれを】へ制御を移す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【死んでいるキャラクターを預けようとする】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「まあ！ ○○○○さんをそんな姿のまま～」(ID: <literal>#$0ACA</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜けまたは「いいえ」と答えた場合は
							【ルイーダに諭される】へ制御を移す。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					台詞「それならしかたないわね」(ID: <literal>#$0ACB</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					【装備品を袋に】へ制御を移す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【ルイーダに諭される】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「だったら助けてあげたほうが～」(ID: <literal>#$0ACC</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3D7BB -->

<section id="dq3.pub.hack.C3D8C8">
<title>パーティに生きている人が二人以上いるか調べるサブルーチン</title>
<para>
	サブルーチン <varname>$D8C8</varname> は（生きている）メンバーを預ける直前のパーティにおいて、
	生きているメンバーが二人以上いるか否かを調べて、<varname>Carry</varname> ビットを更新する。
</para>
<itemizedlist>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			パーティの人数を取得 (<varname>X</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>Y = 0</code> とし、これを「生きているメンバーの人数カウンター」とする。
		</para>
	</listitem>
	<listitem>
		<para>【for-each <varname>X</varname> in <varname>X</varname> - 1 .. 0】</para>
		<itemizedlist>
			<listitem>
				<para>
					死に状態テストサブルーチン <varname>$C43F87</varname> 呼び出しにより、
					パーティキャラクター (<varname>X</varname>) が死んでいるかどうかのビットを含む値を取得 (<varname>A</varname>) する。
					生きているときに限り、<varname>Y</varname> をインクリメントする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<varname>Carry</varname> ビットを条件 <code>Y &gt;= 2</code> でセットする。
		</para>
	</listitem>
	<listitem>
		<para>
			サブルーチン呼び出し元に制御を戻す。
		</para>
	</listitem>
	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					パーティで生きているメンバー人数が <literal>2</literal> 以上のときに限り <varname>Carry</varname> ビットがセット。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3D8C8 -->

<section id="dq3.pub.hack.C3D8E8">
<title>「なかまをよびだす」処理サブルーチン</title>
<para>
	サブルーチン <varname>$D8E8</varname> は「なかまをよびだす」を選択したら呼び出すサブルーチンだ。
</para>
<itemizedlist>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			パーティの人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 4</code> のとき【既に 4 人パーティ】に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			酒場にいる仲間の人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 0</code> のとき【酒場に誰もいない】に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【誰を呼ぶ】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「だれをお呼びしましょうか？」(ID: <literal>#$0AD4</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					「だれを」ウィンドウを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜け⇒【キャンセル】へ制御をスキップする。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			選択したキャラクター (<varname>A</varname>) の登録インデックスを得る (<varname>X</varname>) ため、
			サブルーチン <varname>$C42F5E</varname> を呼び出す。
		</para>
	</listitem>
	<listitem>
		<para>
			<code>$BE77 = X</code> とする（次の台詞が含む名前を表示するため）。
		</para>
	</listitem>
	<listitem>
		<para>
			台詞「○○○○さんを 仲間にくわえるのね」(ID: <literal>#$0AD5</literal>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			メッセージ「○○○○が 仲間に くわわった」(ID: <literal>#$0ADB</literal>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			サブルーチン <varname>$C42A6D</varname> を呼び出し、
			キャラクターのデータ格納アドレス配列 (<varname>$36E8,X</varname>) を更新する。
		</para>
	</listitem>
	<listitem>
		<para>
			TODO <varname>$C3BD64</varname>
		</para>
	</listitem>

	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			パーティの人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 4</code> のとき【終了】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			酒場にいる仲間の人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 0</code> のとき【終了】へ制御をスキップする。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			台詞「他にも誰か～」(ID: <literal>#$0AD6</literal>) を表示する。
		</para>
	</listitem>
	<listitem>
		<para>
			「はい・いいえ」ウィンドウを表示して、プレイヤーの入力を待つ。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					キャンセル抜け⇒【終了】へ制御を移す。
				</para>
			</listitem>
			<listitem>
				<para>
					「はい」⇒【誰を呼ぶ】へ制御を移す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【既に 4 人パーティ】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「そんなにぞろぞろお仲間がいるのに？」(ID: <literal>#$0AD2</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【酒場に誰もいない】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「でもお店にはあなたの仲間にできるような人は～」(ID: <literal>#$0AD3</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3D8E8 -->

<section id="dq3.pub.hack.C3D983">
<title>「めいぼをみる」処理サブルーチン</title>
<para>
	サブルーチン <varname>$D983</varname> は「めいぼをみる」を選択したら呼び出すサブルーチンだ。
	ウィンドウの表示が主な処理だ。
	処理の概略は以下のようになっている。
</para>
<itemizedlist>
	<listitem>
		<para>
			キャラクター人数カウントサブルーチン <varname>$C4297C</varname> 呼び出しにより、
			酒場にいる仲間の人数を取得 (<varname>A</varname>) する。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 0</code> のとき【酒場に誰もいない】に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【だれを】</para>
		<itemizedlist>
			<listitem>
				<para>
					「だれを」ウィンドウと、その中のカーソルが指すキャラクターの「つよさ」ウィンドウを、
					画面左側と右側にそれぞれ表示する。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャラクターを選択⇒【呪文リスト開始】
						</para>
					</listitem>
					<listitem>
						<para>
							キャンセル抜け⇒【終了】
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>
	
	<listitem>
		<para>【酒場に誰もいない】</para>
		<itemizedlist>
			<listitem>
				<para>
					台詞「お仲間はひとりもおあずかりしてなくてよ」(ID: <literal>#$0AD7</literal>) を表示する。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪文リスト開始】</para>
		<itemizedlist>
			<listitem>
				<para>
					キャラクター ID を憶えておく。<code>$33B8 = $33D6 = A</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>X = 5</code> としてから<link linkend="dq3.pub.hack.C3DA75">サブルーチン <varname>$DA75</varname></link> を呼び出し、
					対象キャラクターの魔法使い系統の習得呪文リストを作成する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$3398 = (魔法使い系統の戦闘時用習得呪文個数 | 魔法使い系統の移動時用習得呪文個数)</code>
				</para>
			</listitem>

			<listitem>
				<para>
					<code>X = 6</code> としてから<link linkend="dq3.pub.hack.C3DA75">サブルーチン <varname>$DA75</varname></link> を呼び出し、
					対象キャラクターの僧侶系統の習得呪文リストを作成する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$339A = (僧侶系統の戦闘時用習得呪文個数 | 僧侶系統の移動時用習得呪文個数)</code>
				</para>
			</listitem>

			<listitem>
				<para>
					<code>X = 7</code> としてから<link linkend="dq3.pub.hack.C3DA89">サブルーチン <varname>$DA89</varname></link> を呼び出し、
					対象キャラクターの魔法使い・僧侶系統<emphasis>以外の</emphasis>習得呪文リストを作成する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$339C = (その他戦闘時用習得呪文個数 | その他移動時用習得呪文個数)</code>
				</para>
			</listitem>

			<listitem>
				<para>
					職業 ID 取得サブルーチン <varname>$C46951</varname> を呼び出し、キャラクターの職業 (<varname>A</varname>) を得る。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							<code>A != 8</code> ⇒【呪文リスト魔法使い】へスキップ。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<code>X = 3</code> としてから<link linkend="dq3.pub.hack.C3DA75">サブルーチン <varname>$DA75</varname></link> を呼び出し、
					対象キャラクターの勇者系統の習得呪文リストを作成する。
				</para>
			</listitem>
			<listitem>
				<para>
					<code>$3396 = (勇者系統の戦闘時用習得呪文個数 | 勇者系統の移動時用習得呪文個数)</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪文リスト勇者】</para>
		<itemizedlist>
			<listitem>
				<para>
					勇者呪文習得個数 (<varname>$3396</varname>) がゼロならば、【呪文リスト魔法使い】へスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					勇者呪文リストを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜け⇒【だれを】へ戻る。
						</para>
					</listitem>
					<listitem>
						<para>
							キャンセル抜けでない⇒【終了】へスキップする。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪文リスト魔法使い】</para>
		<itemizedlist>
			<listitem>
				<para>
					魔法使い呪文習得個数 (<varname>$3398</varname>) がゼロならば、【呪文リスト僧侶】へスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					魔法使い呪文リストを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜け⇒【だれを】へ戻る。
						</para>
					</listitem>
					<listitem>
						<para>
							キャンセル抜けでない⇒
						</para>
						<itemizedlist>
							<listitem>
								<para>
									僧侶呪文習得個数 (<varname>$339A</varname>) がゼロでなければ、
									効果音 (ID: <literal>#$003D</literal>) を鳴らす。
								</para>
							</listitem>
							<listitem>
								<para>
									その他呪文習得個数 (<varname>$339C</varname>) がゼロでなければ、
									【呪文リストその他】へスキップする。
								</para>
							</listitem>
						</itemizedlist>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					次へ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪文リスト僧侶】</para>
		<itemizedlist>
			<listitem>
				<para>
					僧侶呪文習得個数 (<varname>$339A</varname>) がゼロならば、【呪文リストその他】へスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					僧侶呪文リストを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜け⇒
						</para>
						<itemizedlist>
							<listitem>
								<para>
									魔法使い習得呪文個数がゼロでなければ、【呪文リスト魔法使い】へ戻る。
								</para>
							</listitem>
							<listitem>
								<para>
									それ以外は【だれを】へ戻る。
								</para>
							</listitem>
						</itemizedlist>
					</listitem>
					<listitem>
						<para>
							キャンセル抜けでない⇒
						</para>
						<itemizedlist>
							<listitem>
								<para>
									その他呪文習得個数 (<varname>$339C</varname>) がゼロでなければ、効果音 (ID: <literal>#$003D</literal>) を鳴らす。
								</para>
							</listitem>
						</itemizedlist>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					次へ。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【呪文リストその他】</para>
		<itemizedlist>
			<listitem>
				<para>
					その他呪文習得個数 (<varname>$339C</varname>) がゼロならば、【終了】へスキップする。
				</para>
			</listitem>
			<listitem>
				<para>
					盗賊・商人・遊び人習得移動時呪文リストを表示して、プレイヤーの入力を待つ。
				</para>
				<itemizedlist>
					<listitem>
						<para>
							キャンセル抜けでなければ、【終了】へスキップする。
						</para>
					</listitem>
					<listitem>
						<para>
							僧侶習得呪文個数がゼロでなければ、【呪文リスト僧侶】へ戻る。
						</para>
					</listitem>
					<listitem>
						<para>
							魔法使い習得呪文個数がゼロでなければ、【呪文リスト魔法使い】へ戻る。
						</para>
					</listitem>
					<listitem>
						<para>
							それ以外は【だれを】へ戻る。
						</para>
					</listitem>
				</itemizedlist>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン <varname>$C32413</varname> を呼び出すことで、
					プレイヤーの最近の入力 (<varname>$33B6</varname>) をチェックする。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3D983 -->

<section id="dq3.pub.hack.C3DA75">
<title>習得呪文リスト作成サブルーチン</title>
<para>
	サブルーチン <varname>$DA75</varname> は、キャラクターと職業系統を指定して、
	その習得呪文リストを作成する。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == キャラクター ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>X == 職業 ID</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			<link linkend="dq3.pub.hack.C3DA89">移動時呪文リスト作成サブルーチン</link>を呼び出す。
		</para>
	</listitem>

	<listitem>
		<para>
			習得呪文リスト作成サブルーチン <varname>$C45796</varname> を呼び出す。
			これは、キャラクターの習得呪文ビットを見て、
			<varname>$C415B7</varname> 構造体から呪文名をある配列にセットする、
			というような働きをする。
		</para>
	</listitem>

	<listitem>
		<para>
			前者の呪文個数と、後者の呪文個数を <code>ORA</code> する
		</para>
	</listitem>

	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == 戦闘用習得呪文の個数 | 移動用習得呪文の個数</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3DA75 -->

<section id="dq3.pub.hack.C3DA89">
<title>移動時呪文リスト作成サブルーチン</title>
<para>
	サブルーチン <varname>$DA89</varname> は、キャラクターと職業系統を指定して、
	その移動時における習得呪文リストを作成する。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>A == キャラクター ID</code>
				</para>
			</listitem>
			<listitem>
				<para>
					<code>X == 職業 ID</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>

	<listitem>
		<para>
			習得呪文リスト作成サブルーチン <varname>$C456BC</varname> を呼び出す。
			これは、キャラクターの習得呪文ビットを見て、
			<varname>$C41480</varname> 構造体から呪文名をある配列にセットする、
			というような働きをする。
		</para>
	</listitem>
	
	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para>
					<code>Y == 習得呪文の個数</code>
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.pub.hack.C3DA89 -->

<section id="dq3.pub.hack.C3DA97">
<title>アイテムをふくろに</title>
<para>
	サブルーチン <varname>$C3DA97</varname> は、キャラクターの装備品でない所持品をふくろに入れる処理だ。
</para>
<itemizedlist>
	<listitem>
		<para>
			サブルーチン <varname>$C446A4</varname> 呼び出しにより、
			パーティキャラクター (<varname>$78</varname>) のすべての所持品個数を取得 (<varname>$7A</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>
			サブルーチン <varname>$C446D6</varname> 呼び出しにより、
			パーティキャラクター (<varname>$78</varname>) のすべての所持品個数を取得 (<varname>X</varname>) する。
		</para>
	</listitem>
	<listitem>
		<para>【for-each <varname>Y</varname> in <varname>$7A</varname> .. <varname>X</varname>】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチン <varname>$C4487F</varname> 呼び出しにより、
					パーティキャラクター (<varname>$78</varname>) の <varname>Y</varname> 番目のアイテムを所持品から削除し、
					そのアイテムのアイテム構造体 ID を <varname>A</varname> にロードする。
				</para>
			</listitem>
			<listitem>
				<para>
					サブルーチン <varname>$C45399</varname> 呼び出しにより、
					ふくろの中にあるアイテム (<varname>A</varname>) を一個増やす。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			サブルーチン呼び出し元に制御を戻す。
		</para>
	</listitem>
</itemizedlist>

</section> <!-- dq3.pub.hack.C3DA97 -->
</section> <!-- dq3.pub.hack -->

<section id="dq3.pub.data">
<title>データ</title>
<para>
	移動時呪文のリスト処理に関係する <varname>$C41480</varname> 構造体と、
	戦闘時呪文のリスト処理に関係する <varname>$C415B7</varname> 構造体を表にしたいが、
	構造体の解析を含め、現在調査中。
</para>
</section> <!-- dq3.pub.data -->
</section> <!-- dq3.pub -->
