<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % replacement SYSTEM "replacement.xml">
  %replacement;
]>

<section id="dq3.tipster"><?dbhtml filename="dq3_tipster.html" ?>
<title>予想屋解析</title>
<indexterm id="term.dq3.tipster"><primary>予想屋</primary><secondary>DQ3</secondary></indexterm>
<para>
格闘場に必ず併設されている予想屋。
本節では、その共通処理サブルーチンの解析を行う。
</para>
<para>
先に結論を述べると、実際に予想をしているのは彼らではなく、
格闘場マッチメイクを実装するサブルーチンだ。
つまり、予想屋に話しかける前にその予想が既に決まっているのだ。
格闘場のフロアに入場する際の処理でマッチメイクがなされるわけだが、
出場モンスターを決めるついでに、予想勝ちモンスターの出場番号も同時に決めているのだ。
これは<xref linkend="dq3.matchmake"/>で詳しく解析を行う。
</para>

<section id="dq3.tipster.hack">
<title>解析</title>
<para>
世界各地の格闘場にいる予想屋に「はなす」と呼び出されるサブルーチンは共通して
<link linkend="dq3.tipster.hack.C3EFBE"><varname>$C3EFBE</varname></link> を呼び出す。
予想屋の話す台詞は、
<link linkend="dq3.text.travel">メッセージ ID</link>
<literal>2</literal> バイト値を引数として渡すサブルーチン <varname>$C1A92E</varname> でウィンドウに表示するようなので、
逆アセンブルコードを解読する際には、これらの呼び出しの合間を読むようにする。
</para>

<section id="dq3.tipster.hack.C3EFBE">
<title>予想屋共通処理サブルーチン</title>
<para>
サブルーチン <varname>$C3EFBE</varname> は、アレフガルドに朝が来たなどの特殊なイベント中でない限りは、
予想屋に「はなす」となされる処理だ。
</para>
<itemizedlist>
	<listitem>
		<para>
			予想屋がメッセージ (ID: <literal>#$0618</literal>) の台詞
			「次の試合の予想がたったの５ゴールド！ お聞きになりますか？」を言う。
		</para>
	</listitem>
	<listitem>
		<para>
			はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					プレイヤーが「いいえ」と答えたか、もしくはキャンセルボタンを押したとき、
					プログラム制御を【予想を聞かない】へ移す。
				</para>
			</listitem>
			<listitem>
				<para>
					プレイヤーが「はい」と答えたとき、次の処理へ進む。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<varname>A</varname> レジスタと <varname>X</varname> レジスタに <literal>#$0005</literal> と <literal>#$0000</literal> をそれぞれロードしてから、
			汎用サブルーチン <varname>$C45B66</varname> を呼び出す。
			すなわちパーティの所持金から <literal>5</literal> だけ減らそうとする。
		</para>
		<itemizedlist>
			<listitem>
				<para>
					もし処理に失敗した場合、つまりパーティの所持金が <literal>5</literal> に満たないときは、
					制御を【予想を聞かない】へ移す。
				</para>
			</listitem>
			<listitem>
				<para>
					それ以外の場合は、次へ進む。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<varname>X</varname> レジスタに <varname>$3378</varname> の値をロード、
			それから <varname>A</varname> レジスタに <varname>$2000,X</varname> の値をロードする。
			さらに<link linkend="dq3.tipster.hack.C3F022">サブルーチン <varname>$F022</varname></link> を呼び出すことで、
			次の予想屋の台詞に出てくるモンスター名を決定する。
		</para>
		<para>
			既に <varname>$3378</varname> には予想勝ちモンスターの出場番号がセットされている。
			マッチメイクのついでにセットされたものだ。
		</para>
	</listitem>
	<listitem>
		<para>
			予想屋がメッセージ (ID: <literal>#$0619</literal>) の台詞
			「よろしい！ では予想をお聞かせしましょう！ 次はズバリ～」
			を言う。
		</para>
	</listitem>
	<listitem>
		<para>
			【終了】へ制御を進める。
		</para>
	</listitem>
	<listitem>
		<para>【予想を聞かない】</para>
		<itemizedlist>
			<listitem>
				<para>
					予想屋がメッセージ (ID: <literal>#$061A</literal>) の台詞
					「おや？ たった５ゴールドすらはらえない？」
					を言う。
				</para>
			</listitem>
			<listitem>
				<para>
					そのまま【終了】へ制御を進める。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>【終了】</para>
		<itemizedlist>
			<listitem>
				<para>
					サブルーチンを終了し、呼び出し元に制御を戻す。
				</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.tipster.hack.C3EFBE -->

<section id="dq3.tipster.hack.C3F022">
<title>予想モンスターの名前を調べるサブルーチン</title>
<para>
サブルーチン <varname>$F022</varname> は、予想屋が予想を言うときのモンスター名の表記をどうするのかを決める。
同種のモンスターが複数エントリーしているときにのみ、このサブルーチンが意味を持つ。
例えば、おおありくいが <literal>4</literal> 匹からなるようなマッチメイクがなされているとする。
このとき、どのおおありくいを予想しているのかを識別する目的で、
モンスター名「おおありくい」に suffix を付与するのだ。
</para>
<itemizedlist>
	<listitem>
		<para>【事前条件】</para> 
		<itemizedlist>
			<listitem>
				<para><varname>X</varname> レジスタは、勝ちモンスターのエントリー番号を表す。</para>
			</listitem>
			<listitem>
				<para><varname>A</varname> レジスタは、勝ちモンスターのモンスター構造体 ID を表す。</para>
			</listitem>
		</itemizedlist>
	</listitem>
	<listitem>
		<para>
			<varname>$338C</varname>, <varname>$338E</varname> を <varname>A</varname> レジスタが表すモンスターの登場匹数カウンターとして用いる。
		</para>
	</listitem>
	<listitem>
		<para>
			予想モンスターと同種のものが自身も含めて 2 以上出場する場合は、
			<code>LDA $C30EF5,X</code> (where <code>X == 予想番号 * 2</code>)
			してサブルーチン呼び出し元に処理を戻す。
		</para>
		<para>
			構造体 <varname>$C30EF5</varname> は<link linkend="dq3.string">文字列 ID</link> 値が <literal>4</literal> つ並ぶ小さなものだ。
			先頭から <literal>#$0314</literal>, <literal>#$0315</literal>, <literal>#$0316</literal>, <literal>#$0317</literal> と配列されており、
			その表す文字列は、それぞれ Ａ, Ｂ, Ｃ, Ｄ だ。
		</para>
	</listitem>
	<listitem>
		<para>
			予想モンスターと同種のものが自分以外にいないときは、
			<varname>A</varname> レジスタに <literal>#$0023</literal> (null) をロードしてサブルーチン呼び出し元に処理を戻す。
		</para>
	</listitem>
	<listitem>
		<para>【事後条件】</para>
		<itemizedlist>
			<listitem>
				<para><varname>A</varname> レジスタに勝ち予想モンスター suffix 用の文字列 ID がロードされている。</para>
			</listitem>
		</itemizedlist>
	</listitem>
</itemizedlist>
</section> <!-- dq3.tipster.hack.C3F022 -->
</section> <!-- dq3.tipster.hack -->
</section> <!-- dq3.tipster -->
