<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.21. 予想屋解析</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_stadium.html" title="5.20. 格闘場解析" />
    <link rel="next" href="dq3_medal.html" title="5.22. メダルおじさん解析" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_stadium.html" title="5.20. 格闘場解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_medal.html" title="5.22. メダルおじさん解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_stadium.html">5.20. 格闘場解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_medal.html">5.22. メダルおじさん解析</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.tipster"></a>5.21. 予想屋解析</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_tipster.html#dq3.tipster.hack">5.21.1. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_tipster.html#dq3.tipster.hack.C3EFBE">5.21.1.1. 予想屋共通処理サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_tipster.html#dq3.tipster.hack.C3F022">5.21.1.2. 予想モンスターの名前を調べるサブルーチン</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <a id="term.dq3.tipster" class="indexterm"></a>
      <p>
格闘場に必ず併設されている予想屋。
本節では、その共通処理サブルーチンの解析を行う。
</p>
      <p>
先に結論を述べると、実際に予想をしているのは彼らではなく、
格闘場マッチメイクを実装するサブルーチンだ。
つまり、予想屋に話しかける前にその予想が既に決まっているのだ。
格闘場のフロアに入場する際の処理でマッチメイクがなされるわけだが、
出場モンスターを決めるついでに、予想勝ちモンスターの出場番号も同時に決めているのだ。
これは<a class="xref" href="dq3_matchmake.html" title="5.19. 格闘場マッチメイク解析">5.19 格闘場マッチメイク解析</a>で詳しく解析を行う。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.tipster.hack"></a>5.21.1. 解析</h3>
            </div>
          </div>
        </div>
        <p>
世界各地の格闘場にいる予想屋に「はなす」と呼び出されるサブルーチンは共通して
<a class="link" href="dq3_tipster.html#dq3.tipster.hack.C3EFBE" title="5.21.1.1. 予想屋共通処理サブルーチン"><code class="varname">$C3EFBE</code></a> を呼び出す。
予想屋の話す台詞は、
<a class="link" href="dq3_text.html#dq3.text.travel" title="5.2.2. 移動モード">メッセージ ID</a>
<code class="literal">2</code> バイト値を引数として渡すサブルーチン <code class="varname">$C1A92E</code> でウィンドウに表示するようなので、
逆アセンブルコードを解読する際には、これらの呼び出しの合間を読むようにする。
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.tipster.hack.C3EFBE"></a>5.21.1.1. 予想屋共通処理サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3EFBE</code> は、アレフガルドに朝が来たなどの特殊なイベント中でない限りは、
予想屋に「はなす」となされる処理だ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
			予想屋がメッセージ (ID: <code class="literal">#$0618</code>) の台詞
			「次の試合の予想がたったの５ゴールド！ お聞きになりますか？」を言う。
		</p>
              </li>
              <li class="listitem">
                <p>
			はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					プレイヤーが「いいえ」と答えたか、もしくはキャンセルボタンを押したとき、
					プログラム制御を【予想を聞かない】へ移す。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					プレイヤーが「はい」と答えたとき、次の処理へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">A</code> レジスタと <code class="varname">X</code> レジスタに <code class="literal">#$0005</code> と <code class="literal">#$0000</code> をそれぞれロードしてから、
			汎用サブルーチン <code class="varname">$C45B66</code> を呼び出す。
			すなわちパーティの所持金から <code class="literal">5</code> だけ減らそうとする。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					もし処理に失敗した場合、つまりパーティの所持金が <code class="literal">5</code> に満たないときは、
					制御を【予想を聞かない】へ移す。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外の場合は、次へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">X</code> レジスタに <code class="varname">$3378</code> の値をロード、
			それから <code class="varname">A</code> レジスタに <code class="varname">$2000,X</code> の値をロードする。
			さらに<a class="link" href="dq3_tipster.html#dq3.tipster.hack.C3F022" title="5.21.1.2. 予想モンスターの名前を調べるサブルーチン">サブルーチン <code class="varname">$F022</code></a> を呼び出すことで、
			次の予想屋の台詞に出てくるモンスター名を決定する。
		</p>
                <p>
			既に <code class="varname">$3378</code> には予想勝ちモンスターの出場番号がセットされている。
			マッチメイクのついでにセットされたものだ。
		</p>
              </li>
              <li class="listitem">
                <p>
			予想屋がメッセージ (ID: <code class="literal">#$0619</code>) の台詞
			「よろしい！ では予想をお聞かせしましょう！ 次はズバリ～」
			を言う。
		</p>
              </li>
              <li class="listitem">
                <p>
			【終了】へ制御を進める。
		</p>
              </li>
              <li class="listitem">
                <p>【予想を聞かない】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					予想屋がメッセージ (ID: <code class="literal">#$061A</code>) の台詞
					「おや？ たった５ゴールドすらはらえない？」
					を言う。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					そのまま【終了】へ制御を進める。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【終了】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					サブルーチンを終了し、呼び出し元に制御を戻す。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.tipster.hack.C3F022"></a>5.21.1.2. 予想モンスターの名前を調べるサブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$F022</code> は、予想屋が予想を言うときのモンスター名の表記をどうするのかを決める。
同種のモンスターが複数エントリーしているときにのみ、このサブルーチンが意味を持つ。
例えば、おおありくいが <code class="literal">4</code> 匹からなるようなマッチメイクがなされているとする。
このとき、どのおおありくいを予想しているのかを識別する目的で、
モンスター名「おおありくい」に suffix を付与するのだ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>【事前条件】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p><code class="varname">X</code> レジスタは、勝ちモンスターのエントリー番号を表す。</p>
                    </li>
                    <li class="listitem">
                      <p><code class="varname">A</code> レジスタは、勝ちモンスターのモンスター構造体 ID を表す。</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">$338C</code>, <code class="varname">$338E</code> を <code class="varname">A</code> レジスタが表すモンスターの登場匹数カウンターとして用いる。
		</p>
              </li>
              <li class="listitem">
                <p>
			予想モンスターと同種のものが自身も含めて 2 以上出場する場合は、
			<code class="code">LDA $C30EF5,X</code> (where <code class="code">X == 予想番号 * 2</code>)
			してサブルーチン呼び出し元に処理を戻す。
		</p>
                <p>
			構造体 <code class="varname">$C30EF5</code> は<a class="link" href="dq3_string.html" title="5.3. 文字列">文字列 ID</a> 値が <code class="literal">4</code> つ並ぶ小さなものだ。
			先頭から <code class="literal">#$0314</code>, <code class="literal">#$0315</code>, <code class="literal">#$0316</code>, <code class="literal">#$0317</code> と配列されており、
			その表す文字列は、それぞれ Ａ, Ｂ, Ｃ, Ｄ だ。
		</p>
              </li>
              <li class="listitem">
                <p>
			予想モンスターと同種のものが自分以外にいないときは、
			<code class="varname">A</code> レジスタに <code class="literal">#$0023</code> (null) をロードしてサブルーチン呼び出し元に処理を戻す。
		</p>
              </li>
              <li class="listitem">
                <p>【事後条件】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p><code class="varname">A</code> レジスタに勝ち予想モンスター suffix 用の文字列 ID がロードされている。</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_stadium.html" title="5.20. 格闘場解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_medal.html" title="5.22. メダルおじさん解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_stadium.html">5.20. 格闘場解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_medal.html">5.22. メダルおじさん解析</a></div>
  </body>
</html>
