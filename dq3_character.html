<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.25. 性格解析</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_class.html" title="5.24. 職業構造体解析" />
    <link rel="next" href="dq3_talk.html" title="5.26. はなす" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_class.html" title="5.24. 職業構造体解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_talk.html" title="5.26. はなす"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_class.html">5.24. 職業構造体解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_talk.html">5.26. はなす</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.character"></a>5.25. 性格解析</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_character.html#dq3.character.hack">5.25.1. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_character.html#dq3.character.hack.C424BC">5.25.1.1. <code class="varname">$C424BC</code> 性格構造体</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="section">
              <a href="dq3_character.html#dq3.character.data">5.25.2. データ</a>
            </span>
          </dt>
        </dl>
      </div>
      <a id="term.dq3.character" class="indexterm"></a>
      <p>
性格構造体 <code class="varname">$C424BC</code> のメンバー解析を行う。
性格に関係しそうなデータと言われて、名前文字列 ID とレベルアップ時のパラメータ上昇に関係する値、
あとは性別データくらいしか思い浮かばないかもしれないが、
ドラクエらしい風変わりなパラメータも、しっかりとこの構造体が定義している。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.character.hack"></a>5.25.1. 解析</h3>
            </div>
          </div>
        </div>
        <p>
性格構造体の存在に気付くのは、次の 4 通りが考えられるので、
ロムイメージ解析の比較的早い段階で、データ定義位置を特定できるだろう。
</p>
        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc; ">
            <li class="listitem">ダーマでの転職処理の解析</li>
            <li class="listitem">ルイーダの酒場の処理の解析</li>
            <li class="listitem">レベルアップ処理の解析</li>
            <li class="listitem">すごろくで性格が変わるイベントの解析</li>
          </ul>
        </div>
        <p>
次に、構造体のメモリレイアウトを調べる。
すなわち、各メンバーをビットフィールドとして見るときの長さ、
それらがどのように構造体内部で配置されているかを解析していく。
それには、構造体内部データをプログラムがどのように取得しているかをすべて見ればよい。
<code class="varname">$C426F0</code> が各性格構造体データの格納アドレス値の配列となっていることもすぐに気付くので、
性格構造体データの各メンバー取得の方法として、
構造体データの値を取得する汎用サブルーチンを利用していることがわかる。
以下に、プログラムが「性格 ID を与えて、それが性別制限がある場合にその性別を取得する」という処理を引用する。
このようなパターンを、力任せにロムイメージから検索しつくせばよい。
</p>
        <pre class="programlisting">
C4/6C15:    DA          PHX
C4/6C16:    AA          TAX
C4/6C17:    227205C9    JSR $C90572    <a id="dq3.character.co.1"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C4/6C1B:    01
C4/6C1C:    0C00        <a id="dq3.character.co.2"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C4/6C1E:    F026C4      <a id="dq3.character.co.3"></a><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span>
C4/6C21:    0700        <a id="dq3.character.co.4"></a><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span>
C4/6C23:    030000      <a id="dq3.character.co.5"></a><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span>
C4/6C26:    FA          PLX
C4/6C27:    6B          RTL
</pre>
        <div class="calloutlist">
          <table border="0" summary="Callout list">
            <tr>
              <td width="5%" valign="top" align="left">
                <p><a href="#dq3.character.co.1"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> </p>
              </td>
              <td valign="top" align="left">
                <p>
SFC 版ドラクエ 3 の全プログラムコード内において、
サブルーチン <code class="varname">$C90572</code> の呼び出し行の直後には、
必ず <code class="literal">11</code> バイトの「実引数」が静的に与えられている。
この値を見ることで、ROM 内に静的に存在する構造体データ配列の定義が解析できる。
配列のインデックスを <code class="varname">X</code> レジスタで与える。
これは取りも直さず性格 ID そのものだ。
</p>
              </td>
            </tr>
            <tr>
              <td width="5%" valign="top" align="left">
                <p><a href="#dq3.character.co.2"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> </p>
              </td>
              <td valign="top" align="left">
                <p>
この行の <code class="literal">2</code> バイトで示される数は、
性格構造体データ一個当たりのバイトサイズを示している。
<code class="literal">#$00C0</code> すなわち <code class="literal">12</code> バイトだ。
</p>
              </td>
            </tr>
            <tr>
              <td width="5%" valign="top" align="left">
                <p><a href="#dq3.character.co.3"><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span></a> </p>
              </td>
              <td valign="top" align="left">
                <p>
この行の <code class="literal">3</code> バイトで示される数は、
構造体配列の存在するアドレスを示している。
この場合「性格構造体データ配列は ROM 内のアドレス <code class="varname">$C426F0</code> に置かれている」
と解釈できる。
</p>
              </td>
            </tr>
            <tr>
              <td width="5%" valign="top" align="left">
                <p><a href="#dq3.character.co.4"><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span></a> </p>
              </td>
              <td valign="top" align="left">
                <p>
この行の <code class="literal">2</code> バイトで示される数は、
一つの構造体データ内のどの位置のバイト列にアクセスするのかを意味する。
構造体データの先頭アドレスからのバイト単位でのオフセット量で指示している。
この場合は <code class="literal">7</code> バイト目を要求している。
</p>
              </td>
            </tr>
            <tr>
              <td width="5%" valign="top" align="left">
                <p><a href="#dq3.character.co.5"><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span></a> </p>
              </td>
              <td valign="top" align="left">
                <p>
データをバイト単位でなく、より細かい粒度で欲しい場合にビットマスクを指示する。
この場合、上記のバイト列が表現する数値に <code class="literal">#$000003</code> で AND マスクをかけ、
下位 <code class="literal">2</code> ビットを得ることになる。
</p>
              </td>
            </tr>
          </table>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.character.hack.C424BC"></a>5.25.1.1. <code class="varname">$C424BC</code> 性格構造体</h4>
              </div>
            </div>
          </div>
          <p>
アドレス <code class="varname">$C424BC</code> からすべての性格構造体データが定義されている。
ひとつの構造体データが占めるデータサイズは <code class="literal">#$000C</code> バイト であり、
<code class="literal">#$2F</code> (<code class="literal">47</code>) 個配列されている。
</p>
          <p>
また、アドレス <code class="varname">$C426F0</code> からは、各データへの先頭アドレスを格納する配列となっている。
ただし、<code class="varname">$C426F0</code> (<code class="literal">1</code>バイト) だけはデータバンク <code class="literal">#$C2</code> を意味する。
</p>
          <p>
性格構造体のメモリレイアウトは以下のようになっている。
"..." となっている部分は、データフィールドがバイト境界をまたぐことを示す。
</p>
          <div class="table">
            <a id="table.C424BC"></a>
            <p class="title">
              <strong>表 5.41 $C424BC 性格構造体</strong>
            </p>
            <div class="table-contents">
              <table id="table.C424BC" class="memorylayout">
                <colgroup>
<col width="12%" />
<col span="7" width="11%" />
</colgroup>
                <thead>
                  <tr><th>Byte:Bit</th>
<th>80</th>
<th>40</th>
<th>20</th>
<th>10</th>
<th>08</th>
<th>04</th>
<th>02</th>
<th>01</th>
</tr>
                </thead>
                <tbody>
                  <tr><th>00</th>
<td colspan="8" rowspan="2">文字列 ID</td>
</tr>
                  <tr><th>01</th>
</tr>
                  <tr><th>02</th>
<td colspan="8">ちから上昇補正</td>
</tr>
                  <tr><th>03</th>
<td colspan="8">すばやさ上昇補正</td>
</tr>
                  <tr><th>04</th>
<td colspan="8">たいりょく上昇補正</td>
</tr>
                  <tr><th>05</th>
<td colspan="8">かしこさ上昇補正</td>
</tr>
                  <tr><th>06</th>
<td colspan="8">うんのよさ上昇補正</td>
</tr>
                  <tr><th>07</th>
<td>...</td>
<td>性格変化 女</td>
<td>性格変化 男</td>
<td colspan="3">登録所台詞</td>
<td colspan="2">性別</td>
</tr>
                  <tr><th>08</th>
<td>...</td>
<td colspan="4">武闘家転職</td>
<td colspan="3">戦士転職...</td>
</tr>
                  <tr><th>09</th>
<td>...</td>
<td colspan="4">魔法使い転職</td>
<td colspan="3">僧侶転職...</td>
</tr>
                  <tr><th>0A</th>
<td>...</td>
<td colspan="4">商人転職</td>
<td colspan="3">賢者転職...</td>
</tr>
                  <tr><th>0B</th>
<td>未使用</td>
<td colspan="4">盗賊転職</td>
<td colspan="3">遊び人転職...</td>
</tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
          <div class="glosslist">
            <dl>
              <dt>
                <span class="glossterm">文字列 ID</span>
              </dt>
              <dd class="glossdef">
                <p>
性格の名前を表す<a class="link" href="dq3_string.html" title="5.3. 文字列">文字列 ID</a> である。
</p>
              </dd>
              <dt>
                <span class="glossterm">ちから上昇補正</span>
              </dt>
              <dd class="glossdef">
                <p>
キャラクターのレベルアップ時に「ちから」を上昇させるときに参照するフィールドである。
「ちから」に対する補正係数のような役割を果たす。
レベルアップによる「ちから」の変更アルゴリズムは、
おおまかに書けば以下のようになっている。
当フィールドは以下の強調した箇所にのみ影響すると考えてよいが、
このフィールドの値のみで補正されるわけではないため、
厳密な解説を与えることが（記者の能力では）難しい。
</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: disc; ">
                    <li class="listitem">レベルに相応しい「ちから」の値を計算する。</li>
                    <li class="listitem">
                      <p>
相応しい値が現在の「ちから」の値に比べて、
</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: circle; ">
                          <li class="listitem">
                            <p>
それ以上であれば：
<span class="emphasis"><em>
「ちから端数」の増分値と「ちから」の増分値を、職業・レベル・性格・（正規分布系）乱数により、それぞれ決定する。
</em></span>
</p>
                          </li>
                          <li class="listitem">
                            <p>
それ未満であれば：
「ちから端数」増分値をレベルそのものとし、
「ちから」増分値を <code class="literal">0</code> または <code class="literal">1</code> とする。
</p>
                          </li>
                        </ul>
                      </div>
                      <p>
</p>
                    </li>
                    <li class="listitem">「ちから端数」「ちから」をそれぞれ上で求めた値で加算</li>
                    <li class="listitem">
                      <p class="simpara">この時点で「ちから」が相応しい値未満であれば：</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: circle; ">
                          <li class="listitem">「ちから」= 相応しい値</li>
                          <li class="listitem">「ちから端数」= 0</li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
                <p>
ちなみに「ちから端数」というのは、「ちから」同様にキャラクター構造体 <code class="varname">$7E3925</code> のフィールドである。
ナンバーズくじのキャリーオーバーのような役割を果たす。
上記にあるように、レベルアップごとに増加していき、
<code class="literal">255</code> を越えた時点で「ちから」本体がさらに <code class="literal">1</code> ポイント加算されるようなイメージでよい。
</p>
              </dd>
              <dt>
                <span class="glossterm">すばやさ上昇補正</span>
              </dt>
              <dd class="glossdef">
                <p>
上述「ちから」のすばやさ版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">たいりょく上昇補正</span>
              </dt>
              <dd class="glossdef">
                <p>
上述「ちから」のたいりょく版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">かしこさ上昇補正</span>
              </dt>
              <dd class="glossdef">
                <p>
上述「ちから」のかしこさ版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">うんのよさ上昇補正</span>
              </dt>
              <dd class="glossdef">
                <p>
上述「ちから」のうんのよさ版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">性別</span>
              </dt>
              <dd class="glossdef">
                <p>
登録所で新規キャラクターを登録する際に、
その初期性格を決定するために参照するフィールドである。
<a class="link" href="dq3_entry.html#dq3.entry.hack.C3E134" title="5.15.1.5.4. 性格を決定">性格を決定</a>の項を参照。
</p>
              </dd>
              <dt>
                <span class="glossterm">登録所台詞</span>
              </dt>
              <dd class="glossdef">
                <p>
ルイーダの酒場二階の登録所で新規キャラクターを登録する際に、
登録屋が性格を評価する台詞 ID 配列 <code class="varname">$C3E2EA</code> のインデックスである。
<a class="link" href="dq3_entry.html#dq3.entry.hack.C3E2D0" title="5.15.1.6. 登録屋が性格を告げるサブルーチン">登録屋が性格を告げるサブルーチン</a>の項を参照。
</p>
              </dd>
              <dt>
                <span class="glossterm">性格変化 男</span>
              </dt>
              <dd class="glossdef">
                <p>
すごろくの「？」マスのランダムイベントのひとつである
「はげしい炎は すべてを無に帰し～」において、
性格変更処理サブルーチン <code class="varname">$C56D90</code> が参照するフィールドである。
</p>
                <p>
すごろくを攻略しているキャラクターの性別が男のとき、
このフィールドが <code class="literal">1</code> である性格のどれかランダムに変えられる。
</p>
              </dd>
              <dt>
                <span class="glossterm">性格変化 女</span>
              </dt>
              <dd class="glossdef">
                <p>
上述「性格変化 男フィールド」の女版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">戦士転職</span>
              </dt>
              <dd class="glossdef">
                <p>
ダーマの神殿でキャラクターが戦士に転職するときに、
性格によっては神官の台詞が変わるときがある。
このフィールドはそれを決める値である。
詳しくは、<a class="link" href="dq3_classchange.html#dq3.classchange.hack.C3E5F8" title="5.17.1.1.1. 性格によっては神官がコメントを出すサブルーチン">性格によっては神官がコメントを出すサブルーチン</a>の項を参照。
</p>
              </dd>
              <dt>
                <span class="glossterm">武闘家転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの武闘家版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">僧侶転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの僧侶版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">魔法使い転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの魔法使い版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">賢者転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの賢者版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">商人転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの商人版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">遊び人転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの遊び人版である。
</p>
              </dd>
              <dt>
                <span class="glossterm">盗賊転職</span>
              </dt>
              <dd class="glossdef">
                <p>
上述した「戦士転職」フィールドの盗賊版である。
</p>
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.character.data"></a>5.25.2. データ</h3>
            </div>
          </div>
        </div>
        <p>
<a class="xref" href="appendix_b.html" title="付録 B データ">付録 B <em>データ</em></a>
</p>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_class.html" title="5.24. 職業構造体解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_talk.html" title="5.26. はなす"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_class.html">5.24. 職業構造体解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_talk.html">5.26. はなす</a></div>
  </body>
</html>
