<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>3.7. 文字列</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq5.html" title="第 3 章 SFC 版ドラクエ 5 (1992)" />
    <link rel="prev" href="dq5_text.html" title="3.6. テキスト解析" />
    <link rel="next" href="dq5_windows.html" title="3.8. ウィンドウ" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq5_text.html" title="3.6. テキスト解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq5.html" title="第 3 章 SFC 版ドラクエ 5 (1992)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq5_windows.html" title="3.8. ウィンドウ"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq5_text.html">3.6. テキスト解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq5.html">第 3 章 SFC 版ドラクエ 5 (1992)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq5_windows.html">3.8. ウィンドウ</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq5.string"></a>3.7. 文字列</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq5_string.html#dq5.string.overview">3.7.1. 概要</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="dq5_string.html#dq5.string.access">3.7.2. 文字列へのアクセス方法</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="dq5_string.html#dq5.string.data">3.7.3. データ</a>
            </span>
          </dt>
        </dl>
      </div>
      <a id="term.dq5.string" class="indexterm"></a>
      <p> 
本節では文字列処理について述べる。
まず、いくつかの基本的な概念を簡単に説明する。
次に、プログラムがどのように文字列データにアクセスするかを、具体的なコードと併せて示す。
最後に、全文字列データを独自コードから UTF-8 に変換したテキストデータを作成する。
</p>
      <p>
なお、本節で言う文字列とはメニューウィンドウや戦闘時のウィンドウで用いられる文字列を指す。
移動時のメッセージウィンドウに描画されるテキストに用いられる文字列は該当しない。
そちらについては <a class="xref" href="dq5_text.html" title="3.6. テキスト解析">3.6 テキスト解析</a> で述べる。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq5.string.overview"></a>3.7.1. 概要</h3>
            </div>
          </div>
        </div>
        <p>
ポイントとなる概念を以下に列挙していく。
</p>
        <div class="variablelist">
          <dl class="variablelist">
            <dt>
              <span class="term">文字コード</span>
            </dt>
            <dd>
              <p>
        文字列を構成する文字コードは、単に 1 バイトの数値として表現されている。
        次に挙げる偉大な先人の業績を参照することで、文字コードと実際に画面上に描画される文字との対応がわかる：
      </p>
              <div class="itemizedlist">
                <ul class="itemizedlist" style="list-style-type: disc; ">
                  <li class="listitem">
                    <p>
            ソニタウン <a class="xref" href="appendix_a.html#dqref.url2" title="ドラクエ解析サイト『ソニタウン』">[<abbr class="abbrev">URL2</abbr>]</a>
            （dqviewer が出力する SFC_DQ5gra.bmp を参照）
          </p>
                  </li>
                  <li class="listitem">
                    <p>
            スーパーファミコン版ドラゴンクエスト データ解析プログラム
            （dq_analizer <a class="xref" href="appendix_a.html#dqref.url1" title="Index of /~s-endo/">[<abbr class="abbrev">URL1</abbr>]</a> 内の <code class="filename">dq5decode.c</code> を参照）
          </p>
                  </li>
                </ul>
              </div>
            </dd>
            <dt>
              <span class="term">文字列のデータ構造</span>
            </dt>
            <dd>
              <p>
        文字列はいわゆる Pascal 文字列の形式を採用しているようだ。
        すなわち、最初の 1 バイトに文字列の長さ L を格納し、
        次のバイトから L 個のバイトが文字列を構成する文字コードの配列だ。
      </p>
            </dd>
            <dt>
              <span class="term">半濁点・濁点処理</span>
            </dt>
            <dd>
              <p>
        データとしては「エ゛ヒル゜フラント」のように
        半濁点、濁点はそれぞれひとつの文字として存在する。
        ウィンドウに文字画像を描画するときには、
        位置をずらすことで「ビ」「プ」のように見せる。
        本書では、可読性を上げるために「エビルプラント」のように整形してある。
      </p>
            </dd>
            <dt>
              <span class="term">ベースアドレス</span>
            </dt>
            <dd>
              <p>
        アドレス <code class="varname">$21955B</code> に各種文字列表のアドレス表がある。
        ウィンドウ描画時に、どれかのアドレスからデータを取得するのである。
      </p>
              <div class="table">
                <a id="table.dq5.string.overview"></a>
                <p class="title">
                  <strong>表 3.22 アドレス表</strong>
                </p>
                <div class="table-contents">
                  <table id="table.dq5.string.overview" class="lighttable">
                    <thead>
                      <tr>
            <th>ID</th>
            <th>アドレス</th>
            <th>内容</th>
          </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th>00</th>
                        <td>
                          <code class="varname">$23C5CE</code>
                        </td>
                        <td>仲間の名前</td>
                      </tr>
                      <tr>
                        <th>01</th>
                        <td>
                          <code class="varname">$23C5F9</code>
                        </td>
                        <td>肩書</td>
                      </tr>
                      <tr>
                        <th>02</th>
                        <td>
                          <code class="varname">$23C690</code>
                        </td>
                        <td>性別</td>
                      </tr>
                      <tr>
                        <th>03</th>
                        <td>
                          <code class="varname">$228000</code>
                        </td>
                        <td>じゅもん・とくぎの名前</td>
                      </tr>
                      <tr>
                        <th>04</th>
                        <td>
                          <code class="varname">$23C69C</code>
                        </td>
                        <td>モンスター名</td>
                      </tr>
                      <tr>
                        <th>05</th>
                        <td>
                          <code class="varname">$23CE0E</code>
                        </td>
                        <td>アイテム名</td>
                      </tr>
                      <tr>
                        <th>06</th>
                        <td>
                          <code class="varname">$23D5B5</code>
                        </td>
                        <td>さくせん名</td>
                      </tr>
                      <tr>
                        <th>07</th>
                        <td>
                          <code class="varname">$308000</code>
                        </td>
                        <td>不明 1</td>
                      </tr>
                      <tr>
                        <th>08</th>
                        <td rowspan="2">
                          <code class="varname">$23D6A1</code>
                        </td>
                        <td rowspan="2">不明 2</td>
                      </tr>
                      <tr>
                        <th>09</th>
                      </tr>
                      <tr>
                        <th>0A</th>
                        <td>
                          <code class="varname">$23C242</code>
                        </td>
                        <td>仲間モンスターの名前</td>
                      </tr>
                      <tr>
                        <th>0B</th>
                        <td>
                          <code class="varname">$23D5F3</code>
                        </td>
                        <td>ルーラ行き先</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <br class="table-break" />
            </dd>
          </dl>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq5.string.access"></a>3.7.2. 文字列へのアクセス方法</h3>
            </div>
          </div>
        </div>
        <p>
文字列の取得処理は BRK 命令を経由した汎用データアクセスサブルーチン呼び出しとして実現している。
BRK のオペランドとしては <code class="literal">#$80</code> ... <code class="literal">#$93</code> が適用され、
汎用データアクセス ID としては例えば <code class="literal">#$2B</code> が利用される。
これらの一般的な振る舞いについては <a class="xref" href="dq5_brk.html#dq5.brk.spec.80-93" title="3.2.3.4. オペランド #$80, ..., #$93: オブジェクトのフィールドにアクセス">3.2.3.4 オペランド <code class="literal">#$80</code>, ..., <code class="literal">#$93</code>: オブジェクトのフィールドにアクセス</a> と
<a class="xref" href="dq5_accessor.html" title="3.3. 汎用データアクセスサブルーチン（仮）">3.3 汎用データアクセスサブルーチン（仮）</a> で述べる。
</p>
        <p>
例えば現在のさくせんの名前を取得するコードは次のようなものになる。
最初の BRK 呼び出しでは現在のさくせんを <code class="varname">$46</code> に取得する。
二番目の BRK 呼び出しで対応する文字列を（ここでは説明しないが <code class="varname">$00, ...</code> に）取得する。
異なる種類の ID をあらかじめ既定のアドレスに格納してから BRK するのが作法だ。
</p>
        <pre class="programlisting">
04/B912:    0088        BRK #$88            ; #$88, #$4F: さくせんを参照する
04/B914:    4F
04/B915:    A546        LDA $46             ; さくせん ID
04/B917:    8542        STA $42             ; オブジェクト ID を指示（＝さくせん ID の値）
04/B919:    A906        LDA #$06
04/B91B:    8543        STA $43             ; 上述のアドレステーブル $21955B の ID として 6 を指示（＝さくせん名テーブルアドレス）
04/B91D:    0088        BRK #$88            ; #$88, #$2B: 指定オブジェクトの名前を得る
04/B91F:    2B
</pre>
        <p>
</p>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq5.string.data"></a>3.7.3. データ</h3>
            </div>
          </div>
        </div>
        <p>
<a class="xref" href="appendix_b.html" title="付録 B データ">付録 B <em>データ</em></a> に全文字列データをから UTF-8 に変換したテキストデータを置く。
</p>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq5_text.html" title="3.6. テキスト解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq5.html" title="第 3 章 SFC 版ドラクエ 5 (1992)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq5_windows.html" title="3.8. ウィンドウ"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq5_text.html">3.6. テキスト解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq5.html">第 3 章 SFC 版ドラクエ 5 (1992)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq5_windows.html">3.8. ウィンドウ</a></div>
  </body>
</html>
