<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.9. ダメージ</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_descriptions.html" title="5.8. コマンドに関する記述" />
    <link rel="next" href="dq3_windows.html" title="5.10. ウィンドウ" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_descriptions.html" title="5.8. コマンドに関する記述"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_windows.html" title="5.10. ウィンドウ"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_descriptions.html">5.8. コマンドに関する記述</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_windows.html">5.10. ウィンドウ</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.damage"></a>5.9. ダメージ</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_damage.html#dq3.damage.structure">5.9.1. 構造に関する構成要素</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_damage.html#dq3.damage.structure.C23BB4">5.9.1.1. 構造体 <code class="varname">$C23BB4</code>: ダメージ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_damage.html#dq3.damage.structure.methods">5.9.1.2. 構造体の属性へのアクセス</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="section">
              <a href="dq3_damage.html#dq3.damage.behavior">5.9.2. 振る舞いに関する構成要素</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_damage.html#dq3.damage.behavior.C90AF7">5.9.2.1. サブルーチン <code class="varname">$C90AF7</code>: ダメージ決定サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_damage.html#dq3.damage.behavior.C90B3A">5.9.2.2. サブルーチン <code class="varname">$C90B3A</code>: ダメージ決定サブルーチン</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <a id="term.dq3.damage" class="indexterm"></a>
      <p>
本節ではダメージ構造体を説明する。
ここで議論するのはダメージのいわば基本量についてであり、
コマンドとキャラクターの状態から決定する、ダメージの計算処理過程の全てを網羅するものではないことを断っておく。
</p>
      <p>
また、ダメージ構造体関連の議論に出てくる「ダメージ」という用語だが、
本書で言うダメージとは、通常の意味に加えて、回復量や永続的な属性値をも含むものとする。
抽象的に表現すると「キャラクターの属性値であり、数量的に表現されているものに対する変化量」ということになるだろうか。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.damage.structure"></a>5.9.1. 構造に関する構成要素</h3>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.damage.structure.C23BB4"></a>5.9.1.1. 構造体 <code class="varname">$C23BB4</code>: ダメージ</h4>
              </div>
            </div>
          </div>
          <p>
アドレス <code class="varname">$C23BB4</code> から 50 個、ダメージパターンが定義されている。
各要素のサイズは 5 バイトで、メモリレイアウトは次に示すとおりだ：
</p>
          <div class="table">
            <a id="table.dq3.C23BB4"></a>
            <p class="title">
              <strong>表 5.28 構造体 $C23BB4</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq3.C23BB4" class="lighttable">
                <thead>
                  <tr>
                    <th>オフセット</th>
                    <th>桁</th>
                    <th>属性</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <code class="literal">#$00</code>
                    </td>
                    <td>
                      <code class="literal">#$03FF</code>
                    </td>
                    <td>自陣側実行時の下限値</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$01</code>
                    </td>
                    <td>
                      <code class="literal">#$0FFC</code>
                    </td>
                    <td>敵陣側実行時の下限値</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$02</code>
                    </td>
                    <td>
                      <code class="literal">#$3FF0</code>
                    </td>
                    <td>自陣側実行時の上限値</td>
                  </tr>
                  <tr>
                    <td>
                      <code class="literal">#$03</code>
                    </td>
                    <td>
                      <code class="literal">#$FFC0</code>
                    </td>
                    <td>敵陣側実行時の上限値</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
          <p>
各属性の意味を以下に記す：
</p>
          <div class="variablelist">
            <dl class="variablelist">
              <dt>
                <span class="term">自陣側実行時の下限値, </span>
                <span class="term">敵陣側実行時の下限値</span>
              </dt>
              <dd>
                <p>
        それぞれ自陣側戦闘員と敵陣側戦闘員が実行するコマンドから決まるダメージの下限値を表す属性だ。
        値が 1,023 のときはマジックナンバーとして取り扱う。
        このときは後述の抽選を適用せず、値を 65,535 とする。
      </p>
              </dd>
              <dt>
                <span class="term">自陣側実行時の上限値, </span>
                <span class="term">敵陣側実行時の上限値</span>
              </dt>
              <dd>
                <p>
        それぞれ自陣側戦闘員と敵陣側戦闘員が実行するコマンドから決まるダメージの上限値を表す属性だ。
      </p>
              </dd>
            </dl>
          </div>
          <p>
ROM データをダンプして属性値を検討すると、自陣と敵陣とで威力が異なるコマンドはそれほど多くないことがわかる。
一部の攻撃コマンドしか該当しない。
そのようなダメージについては、いずれも自陣実行時のほうが敵陣のそれよりも大きい値が設定されている。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.damage.structure.methods"></a>5.9.1.2. 構造体の属性へのアクセス</h4>
              </div>
            </div>
          </div>
          <p>
ダメージ構造体のフィールドにアクセスする専用サブルーチンはいくつかあるのだが、
実際にプログラムから参照されているものは <code class="varname">$C2CCF8</code> サブルーチンだけであるようだ。
このサブルーチンは 4 byte のパラメータをとり、
その意味はいつもと同じようなものなので、説明を省く。
</p>
          <div class="table">
            <a id="table.dq3.damage.methods"></a>
            <p class="title">
              <strong>表 5.29 ダメージ構造体の属性にアクセスするサブルーチン</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq3.damage.methods" class="lighttable">
                <thead>
                  <tr>
                    <th>サブルーチン</th>
                    <th>固定引数長</th>
                    <th>入力</th>
                    <th>機能</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CCCF</code>
                    </td>
                    <td>2</td>
                    <td>x</td>
                    <td>2 バイト長の属性値を取得する（未使用）</td>
                  </tr>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CCD6</code>
                    </td>
                    <td>2</td>
                    <td>y</td>
                    <td>2 バイト長の属性値を取得する（未使用）</td>
                  </tr>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CCF1</code>
                    </td>
                    <td>4</td>
                    <td>x</td>
                    <td>ビットフィールド属性値を取得する（未使用）</td>
                  </tr>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CCF8</code>
                    </td>
                    <td>4</td>
                    <td>y</td>
                    <td>ビットフィールド属性値を取得する</td>
                  </tr>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CD13</code>
                    </td>
                    <td>4</td>
                    <td>x</td>
                    <td>ビットフィールド属性値をテストする（未使用）</td>
                  </tr>
                  <tr>
                    <td align="center">
                      <code class="varname">$C2CD1A</code>
                    </td>
                    <td>4</td>
                    <td>y</td>
                    <td>ビットフィールド属性値をテストする（未使用）</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.damage.behavior"></a>5.9.2. 振る舞いに関する構成要素</h3>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.damage.behavior.C90AF7"></a>5.9.2.1. サブルーチン <code class="varname">$C90AF7</code>: ダメージ決定サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
コマンドのダメージ（基本量）を決定するのはサブルーチン <code class="varname">$C90AF7</code> だ。
コマンド実行者とコマンドを入力とし、ダメージ量を出力とする関数とみなすのが理解しやすい。
コードの概要を以下に示す。
</p>
          <pre class="programlisting">
C9/0AF7:    08          PHP
C9/0AF8:    8B          PHB
C9/0AF9:    C230        REP #$30
C9/0AFB:    F47E7E      PEA $7E7E
C9/0AFE:    AB          PLB
C9/0AFF:    AB          PLB
C9/0B00:    DA          PHX
C9/0B01:    5A          PHY
C9/0B02:    AEEE23      LDX $23EE
C9/0B05:    ACE423      LDY $23E4
C9/0B08:    22E0CAC2    JSR $C2CAE0    <a id="dq3.damage.C90AF7.C2CAE0"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C9/0B0C:    3C20
C9/0B0E:    FF00
C9/0B10:    C90500      CMP #$0005
C9/0B13:    9030        BCC $0B45      if(a &lt; 5) goto 実行者が敵陣戦闘員

C9/0B15:    A9FFFF      LDA #$FFFF     ; 65,535
C9/0B18:    48          PHA
C9/0B19:    2225CCC2    JSR $C2CC25    <a id="dq3.damage.C90AF7.C2CC25.1"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C9/0B1D:    7218
C9/0B1F:    FF00
C9/0B21:    A8          TAY
C9/0B22:    22F8CCC2    JSR $C2CCF8    <a id="dq3.damage.C90AF7.C2CCF8.1"></a><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span>
C9/0B26:    443B
C9/0B28:    FF03
C9/0B2A:    C9FF03      CMP #$03FF
C9/0B2D:    F03E        BEQ $0B6D      if(属性値 == 1023) goto 終了
C9/0B2F:    AA          TAX
C9/0B30:    22F8CCC2    JSR $C2CCF8    <a id="dq3.damage.C90AF7.C2CCF8.2"></a><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span>
C9/0B34:    463B
C9/0B36:    F03F
C9/0B38:    802E        BRA $0B68      goto 抽選

.label 実行者が敵陣戦闘員
C9/0B45:    A9FFFF      LDA #$FFFF     ; 65,535
C9/0B48:    48          PHA
C9/0B49:    2225CCC2    JSR $C2CC25    <a id="dq3.damage.C90AF7.C2CC25.2"></a><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span>
C9/0B4D:    7218
C9/0B4F:    FF00
C9/0B51:    A8          TAY
C9/0B52:    22F8CCC2    JSR $C2CCF8    <a id="dq3.damage.C90AF7.C2CCF8.3"></a><span><img src="image/docbook/callouts/6.png" alt="6" border="0" /></span>
C9/0B56:    453B
C9/0B58:    FC0F
C9/0B5A:    C9FF03      CMP #$03FF
C9/0B5D:    F00E        BEQ $0B6D      if(属性値 == 1023) goto 終了
C9/0B5F:    AA          TAX
C9/0B60:    22F8CCC2    JSR $C2CCF8    <a id="dq3.damage.C90AF7.C2CCF8.4"></a><span><img src="image/docbook/callouts/7.png" alt="7" border="0" /></span>
C9/0B64:    473B
C9/0B66:    C0FF
.label 抽選
C9/0B68:    20750B      JSR $0B75      <a id="dq3.damage.C90AF7.rand"></a><span><img src="image/docbook/callouts/8.png" alt="8" border="0" /></span>
C9/0B6B:    8301        STA $01,S
.label 終了
C9/0B6D:    68          PLA
C9/0B6E:    7A          PLY
C9/0B6F:    FA          PLX
C9/0B70:    AB          PLB
C9/0B71:    28          PLP
C9/0B72:    48          PHA
C9/0B73:    68          PLA
C9/0B74:    6B          RTL
</pre>
          <div class="calloutlist">
            <table border="0" summary="Callout list">
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.damage.C90AF7.C2CAE0"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>
      <a class="xref" href="dq3_combatants.html#dq3.combatants.methods" title="5.4.2. 戦闘員構造体メソッド">5.4.2 戦闘員構造体メソッド</a> で述べるように、
      サブルーチン <code class="varname">$C2CAE0</code> の呼び出しは、
      戦闘キャラクター <code class="literal">Y</code> の各種状態を表す構造体オブジェクトから、
      指定の状態を取得することを意味する。
    </p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.damage.C90AF7.C2CC25.1"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> <a href="#dq3.damage.C90AF7.C2CC25.2"><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>
      サブルーチン <code class="varname">$C2CC25</code> を呼び出し、
      戦闘コマンドの属性値を取得する。
      ここでは引数として <code class="literal">#$1872</code> と <code class="literal">#$00FF</code> を渡して、
      この戦闘コマンド <code class="literal">X</code> に関連付けられているダメージオブジェクトの ID を取得する。
    </p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.damage.C90AF7.C2CCF8.1"><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span></a> <a href="#dq3.damage.C90AF7.C2CCF8.2"><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span></a> <a href="#dq3.damage.C90AF7.C2CCF8.3"><span><img src="image/docbook/callouts/6.png" alt="6" border="0" /></span></a> <a href="#dq3.damage.C90AF7.C2CCF8.4"><span><img src="image/docbook/callouts/7.png" alt="7" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>
      サブルーチン <code class="varname">$C2CCF8</code> を呼び出し、
      ダメージオブジェクトから指定の属性値を取得する。
      ここで与えている引数と、取得するメンバーの対応は <a class="xref" href="dq3_damage.html#table.dq3.C23BB4" title="表 5.28 構造体 $C23BB4">表 5.28 構造体 $C23BB4</a> を参照。
      オフセットについては <code class="literal">#$3BB4</code> を <code class="literal">#$00</code> と解釈し、
      以下同様とする。
    </p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.damage.C90AF7.rand"><span><img src="image/docbook/callouts/8.png" alt="8" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>
      同バンクサブルーチン <code class="varname">$0B75</code> を呼び出すことで、
      範囲 <code class="literal">[X, A]</code> に含まれる値を抽選する。
      この乱数を <code class="literal">A</code> に入れた状態でサブルーチンを終了する。
    </p>
                </td>
              </tr>
            </table>
          </div>
          <p>
このサブルーチンは戦闘中に呼び出される。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.damage.behavior.C90B3A"></a>5.9.2.2. サブルーチン <code class="varname">$C90B3A</code>: ダメージ決定サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
こちらのサブルーチンもコマンドのダメージ（基本量）を決定する。
先ほどのものとは、入力が X レジスターであることしか違わない。コマンド ID からだけでダメージ値を決定する。
実行者は敵陣側に決め打ちとなる。
</p>
          <p>
このサブルーチンは移動モードのじゅもんまたはどうぐコマンドから利用されている。
だから実行者を敵陣側ではなく自陣側に決め打ったほうが論理的だと思われるのに、そうなっていない。
しかし、データ上は戦闘時と移動時の両方で実行できるコマンドについては、
陣営によらずダメージ量が同じなので問題は起こらない。
</p>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_descriptions.html" title="5.8. コマンドに関する記述"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_windows.html" title="5.10. ウィンドウ"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_descriptions.html">5.8. コマンドに関する記述</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_windows.html">5.10. ウィンドウ</a></div>
  </body>
</html>
