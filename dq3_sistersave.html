<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.9. シスターセーブ解析</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_king.html" title="5.8. 王様解析" />
    <link rel="next" href="dq3_shop.html" title="5.10. 店屋解析" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_king.html" title="5.8. 王様解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_shop.html" title="5.10. 店屋解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_king.html">5.8. 王様解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_shop.html">5.10. 店屋解析</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.sistersave"></a>5.9. シスターセーブ解析</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_sistersave.html#dq3.sistersave.hack">5.9.1. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_sistersave.html#dq3.sistersave.hack.C3C251">5.9.1.1. シスターセーブ共通処理サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_sistersave.html#dq3.sistersave.hack.lines">5.9.1.2. シスターセーブ用台詞のメッセージ ID</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <a id="term.dq3.save" class="indexterm"></a>
      <a id="term.dq3.save.nun" class="indexterm"></a>
      <p>
シスターセーブとは、アリアハンのルイーダの酒場にいるシスターの行う、
冒険の書への記録サブルーチンを示す。
このシスターの「はなす」処理は冒険の進行状況とかを考慮した上で台詞がけっこう変わったりするが、
本節で見るのはそこではなく、その先のいつもの処理だ。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.sistersave.hack"></a>5.9.1. 解析</h3>
            </div>
          </div>
        </div>
        <p>
シスターセーブの「共通」処理サブルーチンという言い方は奇妙な感じがするが、
<a class="link" href="dq3_shop.html#dq3.shop.hack" title="5.10.1. 解析">店屋</a>や<a class="link" href="dq3_church.html#dq3.church.hack" title="5.13.1. 解析">教会</a>などの、
各種共通処理サブルーチンと同列の扱いでコードを配置しているため、
特定の人物からのみしか利用されないとしても、これも共通処理と呼ぶことにする。
</p>
        <p>
台詞表示にクセがあり、このシスターは一人しかいないので、
メッセージ ID は固定値のセットで実装して構わないはずだが、
なぜか <code class="code">LDA addr,X</code> 命令でメッセージ ID を定数領域からロードしてから、
汎用メッセージ表示サブルーチン <code class="varname">$C1A95A</code> を利用している。
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.sistersave.hack.C3C251"></a>5.9.1.1. シスターセーブ共通処理サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3C251</code> がシスターセーブ処理の主な実装だ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
			事前条件として、<code class="varname">A</code> レジスタの値に台詞種別 ID がセット済みであること。
			ただし、すぐにわかるようにこのセットには実質的な意味はない。
			（台詞の種類が一種類しかないから）
		</p>
              </li>
              <li class="listitem">
                <p>
			もし <code class="varname">A</code> レジスタの値が <code class="literal">1</code> 以上ならば、<code class="code">A = 0</code> とする。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">$2BB2</code> と <code class="varname">X</code> レジスタの両方に <code class="varname">A</code> レジスタの値（つまりゼロ）をセットする。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C2F6,X</code> でシスターの台詞のメッセージ ID をロードし、
			サブルーチン <code class="varname">$C1A95A</code> 呼び出しにより台詞
			「あなたの旅の せいかを 冒険の書に きろくなさいますか？」
			を表示する。
		</p>
              </li>
              <li class="listitem">
                <p>
			はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					キャンセル抜け or いいえ ⇒【終了】へ制御を移す。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒ 次へ制御を進める。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			汎用サブルーチン <code class="varname">$C45E67</code> を呼び出す。
			ウィンドウに冒険の書をリストする準備と思われるが、詳細は未解析。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C2FA,X</code> でシスターの台詞のメッセージ ID をロードし、
			サブルーチン <code class="varname">$C1A95A</code> 呼び出しにより台詞
			「では なん番の冒険の書に書きとめますか？」
			を表示する。
		</p>
              </li>
              <li class="listitem">
                <p>
			冒険の書リストをウィンドウに表示して、プレイヤーの入力待ちとなる。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					いずれかの冒険の書を選択した ⇒【セーブ】へ制御を進める。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒ 次へ制御を進める。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C2FE,X</code> でシスターの台詞のメッセージ ID をロードし、
			サブルーチン <code class="varname">$C1A95A</code> 呼び出しにより台詞
			「おやめに なるのですね」
			を表示する。
			その後【終了】へ制御を移す。
		</p>
              </li>
              <li class="listitem">
                <p>【セーブ】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					文脈から判断すれば、ここは選択した冒険の書に必要なデータを保存する処理だ。
					逆アセンブルコードを以下に転載する。
					バンク <code class="varname">$C4</code> のサブルーチンは解析していないが、
					冒険の書を解析したければ、見ればよい。
					なお、<code class="varname">$33A0</code> と <code class="varname">$33A2</code> は、
					最後に冒険の書にセーブした場所の情報のような値だと思われる。
				</p>
                      <pre class="programlisting">
C3/C2AB:    ACA033      LDY $33A0
C3/C2AE:    22CE2BC4    JSR $C42BCE         <a id="dq3.sistersave.co.1"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C3/C2B2:    FD
C3/C2B3:    ACA233      LDY $33A2
C3/C2B6:    222C2CC4    JSR $C42C2C         <a id="dq3.sistersave.co.2"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C3/C2BA:    FD
C3/C2BB:    224E62C4    JSR $C4624E         <a id="dq3.sistersave.co.3"></a><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span>
C3/C2BF:    FF
</pre>
                      <div class="calloutlist">
                        <table border="0" summary="Callout list">
                          <tr>
                            <td width="5%" valign="top" align="left">
                              <p><a href="#dq3.sistersave.co.1"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> </p>
                            </td>
                            <td valign="top" align="left">
                              <p>未解析サブルーチン。</p>
                            </td>
                          </tr>
                          <tr>
                            <td width="5%" valign="top" align="left">
                              <p><a href="#dq3.sistersave.co.2"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> </p>
                            </td>
                            <td valign="top" align="left">
                              <p>未解析サブルーチン。</p>
                            </td>
                          </tr>
                          <tr>
                            <td width="5%" valign="top" align="left">
                              <p><a href="#dq3.sistersave.co.3"><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span></a> </p>
                            </td>
                            <td valign="top" align="left">
                              <p>未解析サブルーチン。</p>
                            </td>
                          </tr>
                        </table>
                      </div>
                    </li>
                    <li class="listitem">
                      <p>
					効果音 (ID: <code class="literal">#$002B</code>) を鳴らし、終わるまで待つ。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<code class="code">LDA $C3C2FC</code> でシスターの台詞のメッセージ ID をロードし、
					サブルーチン <code class="varname">$C1A95A</code> 呼び出しにより台詞
					「たしかに きろくしました」
					を表示する。次の【終了】に制御を進める。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【終了】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					<code class="code">LDA $C3C2F8,X</code> でシスターの台詞のメッセージ ID をロードし、
					サブルーチン <code class="varname">$C1A95A</code> 呼び出しにより台詞
					「あなたの旅に神のごかごが ありますように」
					を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					サブルーチンの呼び出し元に制御を戻す。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.sistersave.hack.lines"></a>5.9.1.2. シスターセーブ用台詞のメッセージ ID</h4>
              </div>
            </div>
          </div>
          <p>
	<a class="link" href="dq3_sistersave.html#dq3.sistersave.hack.C3C251" title="5.9.1.1. シスターセーブ共通処理サブルーチン">共通処理サブルーチン</a>内から
	<code class="code">LDA addr,X</code> によって参照されるメッセージ ID を以下に載せる。
</p>
          <pre class="programlisting">
C3/C2F6:    4E0B  ; [D6][D1]あなたの旅の せいかを[AD]冒険の書に きろくなさいますか？[AC]
C3/C2F8:    4F0B  ; [D6][D1]あなたの旅に[AD]神のごかごが ありますように。[AC]
C3/C2FA:    500B  ; [D6][D1]では なん番の 冒険の書に[AD]書きとめますか？[AC]
C3/C2FC:    510B  ; [D6][D1]たしかに きろくしました。[AF][AC]
C3/C2FE:    520B  ; [D6][D1]おやめに なるのですね。[AF][AC]
</pre>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_king.html" title="5.8. 王様解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_shop.html" title="5.10. 店屋解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_king.html">5.8. 王様解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_shop.html">5.10. 店屋解析</a></div>
  </body>
</html>
