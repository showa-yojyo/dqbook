<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.20. 格闘場解析</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_matchmake.html" title="5.19. 格闘場マッチメイク解析" />
    <link rel="next" href="dq3_tipster.html" title="5.21. 予想屋解析" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_matchmake.html" title="5.19. 格闘場マッチメイク解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_tipster.html" title="5.21. 予想屋解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_matchmake.html">5.19. 格闘場マッチメイク解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_tipster.html">5.21. 予想屋解析</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.stadium"></a>5.20. 格闘場解析</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_stadium.html#dq3.stadium.hack">5.20.1. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_stadium.html#dq3.stadium.hack.C3EE64">5.20.1.1. 格闘場共通処理サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_stadium.html#dq3.stadium.hack.C3EF29">5.20.1.2. 賭け金計算サブルーチン</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <a id="term.dq3.stadium" class="indexterm"></a>
      <p>
本節は、格闘場の胴元の共通処理サブルーチンを解析する。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.stadium.hack"></a>5.20.1. 解析</h3>
            </div>
          </div>
        </div>
        <p>
世界各地の格闘場受付（胴元）に「はなす」と呼び出されるサブルーチンは共通して
<a class="link" href="dq3_stadium.html#dq3.stadium.hack.C3EE64" title="5.20.1.1. 格闘場共通処理サブルーチン"><code class="varname">$C3EE64</code></a> を呼び出す。
</p>
        <p>
サブルーチンでは、胴元の話す台詞を、
<a class="link" href="dq3_text.html#dq3.text.travel" title="5.2.2. 移動モード">メッセージ ID</a>
<code class="literal">2</code> バイト 値を引数として渡すサブルーチン <code class="varname">$C1A92E</code> でウィンドウに表示する。
逆アセンブルコードを解読する際には、ここを手掛かりとして処理を読み進めることができる。
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.stadium.hack.C3EE64"></a>5.20.1.1. 格闘場共通処理サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$C3EE64</code> では、
パーティが受付に話しかけてから話し終わるまでの処理を実装する。
格闘場の処理の本筋とは外れた処理コードを排除して、受付男処理のアウトラインを示す。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
                  <code class="code">A = $337A</code>
                </p>
              </li>
              <li class="listitem">
                <p>
			<a class="link" href="dq3_stadium.html#dq3.stadium.hack.C3EF29" title="5.20.1.2. 賭け金計算サブルーチン">賭け金計算サブルーチン</a>を呼び出す。
		</p>
              </li>
              <li class="listitem">
                <p>
                  <code class="code">$3376 = 掛札の金額</code>
                </p>
              </li>
              <li class="listitem">
                <p>
			メッセージ ID <code class="literal">#$09BB</code> の台詞を表示する。
			「かけふだは一枚○○ゴールドだ。買うかい？」のような文言である。
		</p>
              </li>
              <li class="listitem">
                <p>
			はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					キャンセルボタン or いいえ ⇒【買わない】へ進む。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒ 次へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">X</code> レジスタと <code class="varname">A</code> レジスタに
			<code class="literal">0</code> と 賭け金をそれぞれロードしてから
			所持金変更サブルーチン <code class="varname">$C45B66</code> を呼び出し、
			パーティの所持金から賭け金を徴収することを試みる。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					失敗した ⇒【所持金不足】へ進む。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外は（所持金から賭け金を徴収された状態で）次へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			出場モンスターリストをウィンドウに表示する。
			プレイヤーの入力を待つ。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					キャンセルボタン抜け ⇒【途中でキャンセル】へ進む。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒ 次へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			<code class="code">$3374 = 選択したモンスターが何番目か</code> (<code class="code">0..</code>)
		</p>
              </li>
              <li class="listitem">
                <p>
			ビットセット汎用サブルーチン <code class="varname">$C902E9</code> を呼び出すことで、
			<code class="code">$7E2011 &amp; #$000C</code> 部分に選択番号を詰め込む。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">$BE71 = 選択したモンスターのモンスター構造体 ID</code>
			として、<a class="link" href="dq3_tipster.html#dq3.tipster.hack.C3F022" title="5.21.1.2. 予想モンスターの名前を調べるサブルーチン">予想モンスターの名前を調べるサブルーチン</a>
			<code class="varname">$C3F022</code> を呼び出す。
			これは直後の台詞表示にモンスター名文字列を含むためである。
		</p>
              </li>
              <li class="listitem">
                <p>
			ビットセット汎用サブルーチン <code class="varname">$C902E9</code> を呼び出すことで、
			<code class="code">$7E2011 &amp; #$0040</code> ビットを立てる
		</p>
              </li>
              <li class="listitem">
                <p>
			メッセージ ID <code class="literal">#$09BE</code> の台詞を表示する。
			「毎度ありい！ スタジアムへ行っておくれ」のような文言である。
		</p>
              </li>
              <li class="listitem">
                <p>
			意味不明のスタック値直接操作コードが走る。
			この時点での <code class="varname">$08,S</code> は、サブルーチン呼び出し直後の <code class="code">PHP</code> 命令でスタックしたものである。
		</p>
                <pre class="programlisting">
C3/EEE2:    09A308      ORA #$08A3
C3/EEE5:    090100      ORA #$0001
C3/EEE8:    8308        STA $08,S
</pre>
              </li>
              <li class="listitem">
                <p>
			【終了】へ進む。
		</p>
              </li>
              <li class="listitem">
                <p>【所持金不足】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID <code class="literal">#$09BF</code> の台詞を表示する。
					「お金が足りないみたいだよ」のような文言である。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
				 	【また来てくれよな】へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【途中でキャンセル】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					<code class="varname">X</code> レジスタと <code class="varname">A</code> レジスタに <code class="literal">0</code> と 賭け金をそれぞれロードしてから
					所持金変更サブルーチン <code class="varname">$C45B1A</code> を呼び出し、
					パーティの所持金を更新することを試みる。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【買わない】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID <code class="literal">#$09BC</code> の台詞を表示する。
					「なんだやめるのか」のような文言である。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					次の【また来てくれよな】へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【また来てくれよな】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID <code class="literal">#$09BD</code> の台詞を表示する。
					「それじゃまた来てくれよな」のような文言である。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					スタック上のアドレスにある値 <code class="varname">$08,S</code> 
					（サブルーチン呼び出し直後の <code class="code">PHP</code> 命令で退避しておいた値）にマスク #$FFFE をかける。
					当サブルーチン呼び出し元に制御を戻したときに、
					<code class="varname">Carry</code> ビットがリセットされている (<code class="code">CLC</code>) 状態にするのが目的である。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【終了】</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					サブルーチン呼び出し元に制御を戻す。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
          <p>
最初唐突に参照される <code class="varname">$337A</code> が奇異に思えるが、
これは<a class="link" href="dq3_matchmake.html" title="5.19. 格闘場マッチメイク解析">マッチメイク処理</a>を終えていることが事前条件になっているから問題ない。
勇者のレベルがこのアドレスに既に格納されていると考えればよい。
</p>
          <p>
<code class="varname">$7E2011</code> は戦闘時のコンテキストで参照されることで有名なアドレスだが、
このサブルーチンの解読から、一部のビットが格闘場処理のために機能していることが読み取れる。
例えば、<code class="code">$7E2011 &amp; #$0040</code> ビットが立っていることは、
その戦闘が格闘場モードであることと同値だ。
</p>
          <p>
余計なお世話だが、所持金から代金を徴収するタイミングが尚早な印象を受けた。
キャンセルが発生したときに、わざわざ所持金を元に戻している。
徴収は「毎度あり」すなわち購入成功確定と同時でよいのではなかろうか。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.stadium.hack.C3EF29"></a>5.20.1.2. 賭け金計算サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
サブルーチン <code class="varname">$EF29</code> は <code class="varname">A</code> レジスタの値を <code class="literal">10</code> 倍にして
<code class="varname">$BE81</code> に <code class="literal">3</code> バイト長でセットするだけの仕事をする。
この値が格闘場での賭け金となる。
<code class="varname">$BE81</code> はメッセージ表示用サブルーチンが参照する値を格納するアドレスである。
短いサブルーチンであるので、全コードを以下に載せる。
</p>
          <pre class="programlisting">
C3/EF29:    0A          ASL A
C3/EF2A:    48          PHA            <a id="dq3.stadium.co.1"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C3/EF2B:    0A          ASL A
C3/EF2C:    0A          ASL A          <a id="dq3.stadium.co.2"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C3/EF2D:    6301        ADC $01,S      <a id="dq3.stadium.co.3"></a><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span>
C3/EF2F:    9C82BE      STZ $BE82
C3/EF32:    8D81BE      STA $BE81
C3/EF35:    FA          PLX 
C3/EF36:    60          RTS
</pre>
          <div class="calloutlist">
            <table border="0" summary="Callout list">
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.stadium.co.1"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>値 <code class="code">A * 2</code> をスタックにプッシュ（倍プッシュ）する。</p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.stadium.co.2"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>この時点での <code class="varname">A</code> の値は、サブルーチン開始直後の <code class="literal">8</code> 倍になっている。</p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a href="#dq3.stadium.co.3"><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p>
      <code class="varname">A</code> にスタックの値を加算する。
      これで <code class="varname">A</code> はサブルーチン開始直後の <code class="literal">10</code> 倍になっている。
    </p>
                </td>
              </tr>
            </table>
          </div>
          <p>
	<code class="varname">X</code> レジスタに呼び出し直後の <code class="varname">A</code> レジスタの値を
	<code class="literal">2</code> 倍したものがロードされることになるが、特に深い意味はない。
</p>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_matchmake.html" title="5.19. 格闘場マッチメイク解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_tipster.html" title="5.21. 予想屋解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_matchmake.html">5.19. 格闘場マッチメイク解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_tipster.html">5.21. 予想屋解析</a></div>
  </body>
</html>
