<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>4.21. 移動中の呪文コマンド処理</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq6.html" title="第 4 章 SFC 版ドラクエ 6 (1995)" />
    <link rel="prev" href="dq6_battle_commands.html" title="4.20. 戦闘コマンド" />
    <link rel="next" href="dq6_item_commands.html" title="4.22. 移動中の道具使用コマンド処理" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq6_battle_commands.html" title="4.20. 戦闘コマンド"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq6.html" title="第 4 章 SFC 版ドラクエ 6 (1995)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq6_item_commands.html" title="4.22. 移動中の道具使用コマンド処理"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq6_battle_commands.html">4.20. 戦闘コマンド</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq6.html">第 4 章 SFC 版ドラクエ 6 (1995)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq6_item_commands.html">4.22. 移動中の道具使用コマンド処理</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq6.spell.commands"></a>4.21. 移動中の呪文コマンド処理</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq6_spell_commands.html#dq6.spell.commands.C3B814">4.21.1. 呪文ハンドラーテーブル</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="dq6_spell_commands.html#dq6.spell.commands.desc">4.21.2. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3B9A8">4.21.2.1. ホイミ・べホイミ・ベホマ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BA5B">4.21.2.2. べホマラー・べホマズン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BAD1">4.21.2.3. キアリー</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BB4A">4.21.2.4. ザオラル</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BBF8">4.21.2.5. ザオリク</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BC70">4.21.2.6. ルーラ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BD4A">4.21.2.7. リレミト</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BDA6">4.21.2.8. くちぶえ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BDDE">4.21.2.9. トヘロス</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BE10">4.21.2.10. トラマナ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BE24">4.21.2.11. フローミ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BE7F">4.21.2.12. タカのめ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BEF9">4.21.2.13. とうぞくのはな</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BF55">4.21.2.14. しのびあし</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BF77">4.21.2.15. ねる</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BF95">4.21.2.16. おおごえ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3C066">4.21.2.17. あなほり</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3C344">4.21.2.18. インパス</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3C71B">4.21.2.19. レミラーマ</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C7CDAF">4.21.2.20. おもいだす・もっとおもいだす・ふかくおもいだす</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq6_spell_commands.html#dq6.spell.commands.desc.C3C7A3">4.21.2.21. わすれる</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <p>
本節では移動中に呪文を唱えるときに発生する処理を呪文ごとに見ていく。
プレイヤーがコマンドメニューから「じゅもん」を選択し、
どのパーティーにメンバーが唱えるのかを選択したあとに一つ呪文を選択する。
すると十分な MP があるときに、プログラムは選択された呪文に対応するサブルーチンを呼び出す。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq6.spell.commands.C3B814"></a>4.21.1. 呪文ハンドラーテーブル</h3>
            </div>
          </div>
        </div>
        <p>
呪文の文字列インデックスと処理コードの開始アドレスとの対応表はアドレス
<code class="varname">$C3B814</code> に次のように定義されている。
呪文ウィンドウで選択された呪文文字列のインデックスと行前半が一致すれば、
プログラムカウンターを行後半のアドレスへ JMP させる。
</p>
        <pre class="programlisting">
C3/B814:    3000A4B9    ; ホイミ
C3/B818:    330049BA    ; べホイミ
C3/B81C:    360050BA    ; べホマ
C3/B820:    390057BA    ; べホマラー
C3/B824:    3A00CABA    ; べホマズン
C3/B828:    3E00D1BA    ; キアリー
C3/B82C:    3B004ABB    ; ザオラル
C3/B830:    3C00F8BB    ; ザオリク
C3/B834:    410070BC    ; ルーラ
C3/B838:    9E004ABD    ; リレミト
C3/B83C:    A900A6BD    ; くちぶえ
C3/B840:    A100DEBD    ; トヘロス
C3/B844:    A00010BE    ; トラマナ
C3/B848:    A40024BE    ; フローミ
C3/B84C:    A2007FBE    ; タカのめ
C3/B850:    A500F9BE    ; とうぞくのはな
C3/B854:    A80055BF    ; しのびあし
C3/B858:    A30077BF    ; ねる
C3/B85C:    A70095BF    ; おおごえ
C3/B860:    AA0066C0    ; あなほり
C3/B864:    9F0044C3    ; インパス
C3/B868:    A6001BC7    ; レミラーマ
C3/B86C:    AB0064C7    ; おもいだす
C3/B870:    AD0079C7    ; もっとおもいだす
C3/B874:    AC008EC7    ; ふかくおもいだす
C3/B878:    AE00A3C7    ; わすれる
</pre>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq6.spell.commands.desc"></a>4.21.2. 解析</h3>
            </div>
          </div>
        </div>
        <p>
以下、各呪文の処理を簡単に説明していく。
その前に、実際にはハンドラーごとにコード化されているものの、
各呪文に共通して見られる仕様傾向を列挙しておく。
これらの事実についてはいちいち個々の呪文解説の項では、例外的な扱いがある場合を除き繰り返さない。

</p>
        <div class="itemizedlist">
          <ul class="itemizedlist" style="list-style-type: disc; ">
            <li class="listitem">サブルーチン <code class="varname">$C3B8C5</code> 呼び出しにより、特定の効果音 (ID: <code class="literal">#$00B0</code>) を鳴らす。</li>
            <li class="listitem">途中でキャンセルしたり、呪文の効果が無効であったりすると、呪文選択時に消費した MP を返還する。</li>
            <li class="listitem">コマンドの対象がパーティーメンバーの一人となるものについては、それをウィンドウ <code class="literal">#$00CA</code> で決定する。</li>
          </ul>
        </div>
        <p>
</p>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3B9A8"></a>4.21.2.1. ホイミ・べホイミ・ベホマ</h4>
              </div>
            </div>
          </div>
          <p>
ホイミ・べホイミ・ベホマの各コマンドは開始直後に同一の処理 <code class="varname">$C3B9A8</code> に合流するので、まとめて解説する。
</p>
          <p>
これらの呪文は、対象者一人が死んでいなければ、そのメンバーの HP をある量だけ回復しようとするものだ。
ここで、ある量とは指定する範囲にある数からランダムに選ぶものであり、
ホイミ系 5 種の呪文に対する回復量テーブルは <code class="varname">$C3B963</code> において次のように定められている。
</p>
          <pre class="programlisting">
C3/B963:    30001E002800 ; ホイミ
C3/B969:    33004B005F00 ; べホイミ
C3/B96F:    3600E703E703 ; べホマ
C3/B975:    390064007800 ; べホマラー
C3/B97B:    3A00E703E703 ; べホマズン
</pre>
          <p>

十六進数を十進数で書き直し、表にまとめると次のようになる：
  </p>
          <div class="table">
            <a id="table.dq6.C3B963"></a>
            <p class="title">
              <strong>表 4.97 $C3B963 ホイミ系回復量テーブル</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq6.C3B963" class="lighttable">
                <thead>
                  <tr>
                    <th>コマンド</th>
                    <th>下限値</th>
                    <th>上限値</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>ホイミ    </td>
                    <td align="right"> 30</td>
                    <td align="right"> 40</td>
                  </tr>
                  <tr>
                    <td>べホイミ  </td>
                    <td align="right"> 75</td>
                    <td align="right"> 95</td>
                  </tr>
                  <tr>
                    <td>べホマ    </td>
                    <td align="right">999</td>
                    <td align="right">999</td>
                  </tr>
                  <tr>
                    <td>べホマラー</td>
                    <td align="right">100</td>
                    <td align="right">120</td>
                  </tr>
                  <tr>
                    <td>べホマズン</td>
                    <td align="right">999</td>
                    <td align="right">999</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <p><br class="table-break" />
</p>
          <p>
乱数の適用は、ホイミ系専用サブルーチン <code class="varname">$C3B8FC</code> で行う。
具体的には、汎用乱数系サブルーチン <code class="varname">$C00F28</code> を利用して回復量を決める。
つまり、ゼロから回復量範囲の長さまでのいずれかの数をランダムに発生させ、
これに下限値を加えた値を回復量とする。
</p>
          <p>
指定メンバーへの HP の回復処理自体はキャラクターのプロパティー設定サブルーチンの一種である
<code class="varname">$C44685</code>で行う。
回復量が過剰な場合はそこで対処することを期待する。
</p>
          <p>
最後に効果音 <code class="literal">#$00CD</code> を鳴らし、メッセージを表示して終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BA5B"></a>4.21.2.2. べホマラー・べホマズン</h4>
              </div>
            </div>
          </div>
          <p>
べホマラー・べホマズンの各コマンドは開始直後に同一の処理 <code class="varname">$C3BA5B</code> に合流するので、まとめて解説する。
</p>
          <p>
これらの呪文は、パーティーにいるメンバーを先頭から順番に、HP をある量だけ回復しようとするものだ。
ただし、死んでいるメンバーは単にスキップする。
また、回復量をメンバーごとに <a class="xref" href="dq6_spell_commands.html#dq6.spell.commands.desc.C3B9A8" title="4.21.2.1. ホイミ・べホイミ・ベホマ">4.21.2.1 ホイミ・べホイミ・ベホマ</a> のようにしてランダムに決定する。
回復処理、効果音、メッセージについても同様だが、呪文を受けたメンバーごとに発生する。
</p>
          <p>
全員の回復メッセージを表示し終えた後、パーティーの HP/MP ウィンドウを表示してコマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BAD1"></a>4.21.2.3. キアリー</h4>
              </div>
            </div>
          </div>
          <p>
キアリーは、対象者一人が死んでいなければ、その毒状態をクリアするコマンドだ。
</p>
          <p>
サブルーチン <code class="varname">$C44CA3</code> により、指定メンバーの状態をテストする。
「しに」状態ならばいつものようにキャンセル扱いとする。
そうでなければ、指定メンバーの「もうどく」「どく」フラグがセットされているかをテストする。
これらのフラグのどちらもセットされていないならば、「しかし 何も おこらなかった」を表示して終了する。
この場合には MP の返還は発生しない。
</p>
          <p>
対象が本当に毒に冒されている場合には、
キャラクターのプロパティー設定サブルーチンの一種であるサブルーチン
<code class="varname">$C44E2B</code> により「もうどく」「どく」フラグをリセットする。
</p>
          <p>
最後にメッセージ <code class="literal">#$16A9</code> を表示し、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BB4A"></a>4.21.2.4. ザオラル</h4>
              </div>
            </div>
          </div>
          <p>
ザオラルは対象者一人が死んでいれば、半分の確率で生き返らせ、HP を最大値の半分とするコマンドだ。
</p>
          <p>
サブルーチン <code class="varname">$C44CA3</code> により、指定メンバーの状態をテストする。
「しに」状態でなければいつものようにキャンセル扱いとする。
</p>
          <p>
死んでいる場合にはサブルーチン <code class="varname">$C00E97</code> により乱数を発生させる。
この値が奇数ならば（最下位ビットを調べる）、ザオラルの結果を失敗とする。
メッセージ <code class="literal">#$16A8</code> を表示し、当然ながら MP を返還せずに終了とする。
</p>
          <p>
乱数が偶数ならば成功とする。この場合、次の一連の処理を行う：
  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">サブルーチン <code class="varname">$C44D34</code> でメンバーの状態をすべてクリアする。</li>
              <li class="listitem">サブルーチン <code class="varname">$C44729</code> でメンバーの最大 HP を取得する。
      次に LSR 命令でその半分の値を計算する。</li>
              <li class="listitem">サブルーチン <code class="varname">$C44685</code> でメンバーの HP を回復する。</li>
            </ul>
          </div>
          <p>
</p>
          <p>
最後にメッセージ <code class="literal">#$16A7</code> を表示し、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BBF8"></a>4.21.2.5. ザオリク</h4>
              </div>
            </div>
          </div>
          <p>
ザオリクは対象者一人が死んでいれば、HP ごと完全回復するコマンドだ。
処理内容は <a class="xref" href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BB4A" title="4.21.2.4. ザオラル">4.21.2.4 ザオラル</a> で説明したものから、
乱数関連と半減関連を取り除いたものになる。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BC70"></a>4.21.2.6. ルーラ</h4>
              </div>
            </div>
          </div>
          <p>
ルーラはパーティーが訪問したことがある場所の一定の集合から一点を選択し、そこへ一瞬で移動するコマンドだ。
次のような処理になっている：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p class="simpara">
      サブルーチン <code class="varname">$C435B3</code> を呼び出す。
      これにより、パーティーが一度訪問したすべての移動先候補地点をアドレス <code class="varname">$7E48D8</code> に配列としてセットする。
      </p>
                <p class="simpara">
      なお、訪問情報は <code class="varname">$7E3E60</code> にビット列として保持されている。
      また、すべての移動先候補地点は <code class="varname">$C8A162</code> に 1 バイト型の配列として定義されている。
      </p>
              </li>
              <li class="listitem">
      次に配列 <code class="varname">$7E48D8</code> に要素があれば、そこから移動先候補をいくつか取り除く。
      サブルーチン <code class="varname">$C7CAD5</code> を実行することで、
      パーティーが現在いるフィールド区分（フィールド、したフィールド、かいてい、はざま）に一致しない候補を検索し、取り除く。
      この結果、移動先候補が全くなくなればメッセージ <code class="literal">#$16D8</code> を表示して、
      コマンドをキャンセル扱いで終了する。
      </li>
              <li class="listitem">
        ルーラウィンドウを表示する。
        候補先の個数に応じてウィンドウの ID を <code class="literal">#$004E</code> か <code class="literal">#$004F</code> に使い分ける。
      </li>
              <li class="listitem">
                <p class="simpara">
        呪文効果音を鳴らしたら、サブルーチン <code class="varname">$C7C650</code> を実行する。
        このとき、次に述べるような失敗パターンがあり、いずれもコマンドキャンセル扱いとなる。
      </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
            天井に頭をぶつけるパターン。
            この場合はメッセージ <code class="literal">#$16AC</code> を表示する。
          </li>
                    <li class="listitem">
            不思議なちからで失敗するパターン。
            この場合はメッセージ <code class="literal">#$16D8</code> を表示する。
          </li>
                    <li class="listitem">
            特定の状況かつ特定の行き先について、パーティーにチャモロがいない（しに状態である）ために失敗するパターン。
            この場合はメッセージ <code class="literal">#$16AD</code> を表示する。
          </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
        以上をすべてクリアすれば画面を切り替えてコマンドを終了する。
      </li>
            </ul>
          </div>
          <p>
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BD4A"></a>4.21.2.7. リレミト</h4>
              </div>
            </div>
          </div>
          <p>
リレミトは現在パーティーがいる地域から「脱出」するコマンドだ。
次のように処理する：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p class="simpara">サブルーチン <code class="varname">$C7C783</code> を呼び出すことで、
      パーティーが現在いる地域や状況がリレミトを許可するかどうかを調べる。
      リレミトが意味のない場所ならばメッセージ <code class="literal">#$16D6</code> を、
      何らかのイベント中であるなどの理由により禁止されているならばメッセージ
      <code class="literal">#$16D8</code> を、それぞれ表示してコマンドを終了する。
      この場合、消費済みの MP を呪文を唱えたメンバーに返還する。
      </p>
                <p class="simpara">サブルーチン <code class="varname">$C7C783</code> のチェック内容は次のようなものだ：</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem"><code class="code">$7E5EE1 != #$0000</code> であるか。
          ゼロでなければ、リレミトにより「何も起こらない」場である。
          <a class="link" href="dq6_debug.html#dq6.debug.menu.C906CF" title="4.1.2.2. いんちきリレミト">いんちきリレミト</a>すら認めない場ということだ。
          </li>
                    <li class="listitem">現在「不思議なちから」が作用する場にいるか、
          または <code class="code">$7E3E28 &amp; #$0001</code> がセットされているかを調べる。
          どちらかならば、リレミトに「不思議なちから」が作用する。
          </li>
                    <li class="listitem"><code class="code">$7E3D2B &amp; #$0002</code> がセットされているか。
          セットされていればリレミトが発動する。
          </li>
                  </ul>
                </div>
                <p class="simpara">これらを全てクリアすればリレミトが発動する。</p>
              </li>
              <li class="listitem">許可されているならば、サブルーチン <code class="varname">$C7C9CE</code> を実行する。
      これがリレミトの本体処理だ。</li>
            </ul>
          </div>
          <p>

リレミトが成功する条件が思いのほか複雑であることがわかる。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BDA6"></a>4.21.2.8. くちぶえ</h4>
              </div>
            </div>
          </div>
          <p>
くちぶえは現在パーティーがいる戦闘地域に基いて、強制的に通常戦闘を引き起こすコマンドだ。
次のように処理する：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">サブルーチン <code class="varname">$C79447</code> を呼び出し、
      適切なタイルせんとう ID を取得する。
      <a class="xref" href="dq6_debug.html#dq6.debug.menu.C9086A" title="4.1.2.10. タイルせんとう">4.1.2.10 タイルせんとう</a>で既定値として表示される値とこの ID は同じだ。
      この値がゼロだと、メッセージ「しかし 何も おこらなかった」を出力してコマンドを終了する。</li>
              <li class="listitem">現在、通常戦闘が発生してよい状況なのかどうかをフラグ
      <code class="code">$7E3D2A &amp; #$0010</code> をテストすることで確認する。
      なお、このフラグは <a class="xref" href="dq6_debug.html#dq6.debug.menu.C908E9" title="4.1.2.12. いんちきせってい">4.1.2.12 いんちきせってい</a>メニューにある「エンカウント」の操作対象そのものだ。
      フラグがリセットされていると、メッセージ「しかし 何も おこらなかった」を出力してコマンドを終了する。</li>
              <li class="listitem">フラグがセットされていれば、戦闘開始サブルーチン <code class="varname">$C7952C</code> を呼び出す。</li>
            </ul>
          </div>
          <p>

全くの個人的な感想だが、フラグのテストを ID 取得より先に処理して欲しい。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BDDE"></a>4.21.2.9. トヘロス</h4>
              </div>
            </div>
          </div>
          <p>
トヘロスは次の処理を行うコマンドだ：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">トヘロス系カウンター <code class="varname">$7E3BA9</code> をリセットする。</li>
              <li class="listitem">トヘロスフラグ <code class="code">$7E3D2B &amp; #$0004</code> をセットする。</li>
              <li class="listitem">せいすいフラグ <code class="code">$7E3D2B &amp; #$0010</code> をリセットする。</li>
            </ul>
          </div>
          <p>

最後にメッセージ <code class="literal">#$16B6</code> を表示し、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BE10"></a>4.21.2.10. トラマナ</h4>
              </div>
            </div>
          </div>
          <p>
トラマナはトラマナフラグ <code class="code">$7E3D2B &amp; #$0020</code> をセットするコマンドだ。
実装はここというよりはサブルーチン <code class="varname">$C7CC5C</code> の呼び出しで済ませている。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BE24"></a>4.21.2.11. フローミ</h4>
              </div>
            </div>
          </div>
          <p>
フローミはパーティーが現在いる場所のメッセージを表示するコマンドだ。
次のように処理する：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">サブルーチン <code class="varname">$C7CAFA</code> を呼び出し、
      フローミ名とフローミ階数を得る。
      このフローミ階数がゼロだと、呪文に意味がない旨を示すメッセージ
      (ID <code class="literal">#$16C5</code>) を表示してコマンドを終了する。
      この場合 MP の返還処理はない。</li>
              <li class="listitem">
                <p class="simpara">フローミ階数の符号により、表示メッセージを若干変える。
      正数の場合は単に ID <code class="literal">#$16C3</code> のメッセージを出力する。
      負数の場合はいわゆる二の補数で表現された値の絶対値を計算してから
      ID <code class="literal">#$16C4</code> のメッセージを出力する。
      </p>
                <pre class="programlisting">
C3/BE59:    49FFFF      EOR #$FFFF          <a id="dq6.spell.commands.desc.C3BE24.co.1"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C3/BE5C:    1A          INC A               <a id="dq6.spell.commands.desc.C3BE24.co.2"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C3/BE5D:    8D2E5A      STA $5A2E           <a id="dq6.spell.commands.desc.C3BE24.co.3"></a><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span>
C3/BE60:    AD305A      LDA $5A30           <a id="dq6.spell.commands.desc.C3BE24.co.4"></a><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span>
C3/BE63:    2900FF      AND #$FF00
C3/BE66:    8D305A      STA $5A30
C3/BE69:    22C22DC0    JSR $C02DC2         <a id="dq6.spell.commands.desc.C3BE24.co.5"></a><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span>
C3/BE6D:    C416
</pre>
                <div class="calloutlist">
                  <table border="0" summary="Callout list">
                    <tr>
                      <td width="5%" valign="top" align="left">
                        <p><a href="#dq6.spell.commands.desc.C3BE24.co.1"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> <a href="#dq6.spell.commands.desc.C3BE24.co.2"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> </p>
                      </td>
                      <td valign="top" align="left">情報処理試験の基本問題でよく見かけるように、
    負の整数はそのビットを反転させて 1 を加えれば絶対値を得る。</td>
                    </tr>
                    <tr>
                      <td width="5%" valign="top" align="left">
                        <p><a href="#dq6.spell.commands.desc.C3BE24.co.3"><span><img src="image/docbook/callouts/3.png" alt="3" border="0" /></span></a> <a href="#dq6.spell.commands.desc.C3BE24.co.4"><span><img src="image/docbook/callouts/4.png" alt="4" border="0" /></span></a> </p>
                      </td>
                      <td valign="top" align="left"><code class="varname">$5A2E</code> は次のメッセージ中の [BB] に当てはめる値。
    一方 <code class="varname">$5A30</code> はこの場合は無視してよい。</td>
                    </tr>
                    <tr>
                      <td width="5%" valign="top" align="left">
                        <p><a href="#dq6.spell.commands.desc.C3BE24.co.5"><span><img src="image/docbook/callouts/5.png" alt="5" border="0" /></span></a> </p>
                      </td>
                      <td valign="top" align="left">メッセージ <code class="literal">#$16C4</code>: ここは [B2]の[AD]地下[BB]階のようだ。</td>
                    </tr>
                  </table>
                </div>
              </li>
            </ul>
          </div>
          <p>

どちらかのメッセージを出力した後、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BE7F"></a>4.21.2.12. タカのめ</h4>
              </div>
            </div>
          </div>
          <p>
タカのめは近くにある城や街等の現在パーティーがいる地点からの相対的な位置を調べるコマンドだ。
探索処理をサブルーチン <code class="varname">$C7CB22</code> で、
データ処理とメッセージ処理を当ハンドラー内でそれぞれ実行する。
当ハンドラーでの手続きはこのようなものだ：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p class="simpara">
      サブルーチン <code class="varname">$C7CB22</code> を呼び出し、探索処理を実行する。
      これにより位置データを変数 <code class="varname">$7E6C[D1:D8]</code> にセットする。
    </p>
                <p class="simpara">
      この結果 <code class="varname">$6CD3</code> と <code class="varname">$6CD1</code> の両方がゼロだと、
      失敗メッセージ <code class="literal">#16C0</code> を出力してコマンドを終了する。
      前者が南北方向の歩数で、後者が東西方向の歩数を表す。
    </p>
              </li>
              <li class="listitem">
      メッセージ中の東西何歩なのかを決めるために <code class="varname">$7E6CD5</code> の符号を調べる。
      正ならば東に何歩とのメッセージ <code class="literal">#16BC</code> を、
      負ならば西に何歩とのメッセージ <code class="literal">#16BD</code> をそれぞれ出力する。
    </li>
              <li class="listitem">
      メッセージ中の南北何歩なのかを決めるために <code class="varname">$7E6CD7</code> の符号を調べる。
      正ならば南に何歩とのメッセージ <code class="literal">#16BF</code> を、
      負ならば北に何歩とのメッセージ <code class="literal">#16BE</code> をそれぞれ出力する。
    </li>
              <li class="listitem">
      コマンドを終了する。
    </li>
            </ul>
          </div>
          <p>
</p>
          <p>
本質的な処理はサブルーチン <code class="varname">$C7CB22</code> 以下のコードによる。

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      パーティーがタカのめにとっての有効地域にいるかどうかは
      構造体 <code class="varname">$C8A188</code> のメンバーを調べることによる。
      余談だが、この構造体配列を精査すれば、タカのめが有効な地域は「フィールド」および「したフィールド」しかないことが判明する。
    </li>
              <li class="listitem">
      長さが 160 の二つの配列 <code class="varname">$7E5F19</code> と <code class="varname">$7E5FB9</code> を並行して調べる。
      興味がある値とは、前者の値の最下位ビットが立っていて、かつ後者の要素が 3 または 4 となる
      添字だ。
      この添字に対応する配列
      <code class="varname">$7E62D9</code>,
      <code class="varname">$7E6199</code>,
      <code class="varname">$7E6379</code>,
      <code class="varname">$7E6239</code> の要素も利用する。
    </li>
              <li class="listitem">
      アルゴリズムはパーティーのいる地点との Manhattan 距離が最小をとる候補地点を一つ検索する。
    </li>
              <li class="listitem">
      候補地点が基準点から東西方向に <code class="literal">#$0012</code> 以上離れているか、
      あるいは南北方向に <code class="literal">#$000E</code> 以上離れているならば、
      その候補地点はタカのめの解から除外する。
    </li>
            </ul>
          </div>
          <p>
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BEF9"></a>4.21.2.13. とうぞくのはな</h4>
              </div>
            </div>
          </div>
          <p>
とうぞくのはなは現在パーティーがいる階や部屋に「しらべる」で入手できるお宝やゴールドがどれだけあるかを知るコマンドだ。
次のような手続きを行う：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      現在パーティーがいる階や部屋がフィールド系であるかどうかを調べる。
      フィールド系だとメッセージ「しかし 何も おこらなかった」を出力してコマンドを終了する。
      余談だが、このチェックでははざまの世界後半部フィールドを漏らしている。
    </li>
              <li class="listitem">
      サブルーチン <code class="varname">$C7CC26</code> を呼び出し、探索処理を実行する。
    </li>
              <li class="listitem">
      戻り値によって出力メッセージを使い分ける。
      値がゼロならばメッセージ <code class="literal">#$16C7</code> を、
      そうでなければメッセージ <code class="literal">#$16C6</code> をそれぞれ表示して、
      コマンドを終了する。
    </li>
            </ul>
          </div>
          <p>
</p>
          <p>
とうぞくのはなの本質的な処理はサブルーチン <code class="varname">$C7CC26</code> 以下になる。
手続きの概要のみ記す：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      お宝カウンターは <code class="varname">$7E679D</code> だ。
    </li>
              <li class="listitem">
                <p class="simpara">
      検索対象は三つ組の配列 <code class="varname">$7E641D</code>,
      <code class="varname">$7E65DD</code>, <code class="varname">$7E661D</code> となる。
    </p>
                <p class="simpara">
      配列 <code class="varname">$7E641D</code> はマップ内のマスが「しらべる」コマンドの対象であるかを
      管理するようだ。上位 2 ビットの状態によりスキップするかどうかを決める。
      このうち <code class="literal">#$4000</code> のビットのほうがこのコマンド専用のデータ扱いになっている。
    </p>
                <p class="simpara">
      配列 <code class="varname">$7E65DD</code> で「しらべる」コマンドによる反応対象の種別を管理している。
      値については下記の表を参照。この値によってサブルーチンを呼び分ける。
    </p>
                <p class="simpara">
      配列 <code class="varname">$7E661D</code> ではマップ内の各マスに対応する
      各種お宝構造体配列の添字、
      すなわち「しらべる」イベントの ID を管理している。
    </p>
              </li>
              <li class="listitem">
      基本的には「しらべる」コマンドで得られる対象物は、
      一度アクセスしたら二度目以降は反応しない。そのフラグを管理するのは配列
      <code class="varname">$7E3D2A</code> のビットセットだ。
      一度「しらべる」コマンドで入手した項目に対応するビットは 1 になっている。
      このアルゴリズムで調べたいのは、そのようなビットが 0 になっているものの個数だ。
    </li>
            </ul>
          </div>
          <p>
</p>
          <div class="table">
            <a id="table.dq6.look.kind"></a>
            <p class="title">
              <strong>表 4.98 しらべる反応種別</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq6.look.kind" class="lighttable">
                <thead>
                  <tr>
                    <th>値</th>
                    <th>種別</th>
                    <th>参照構造体</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>0</td>
                    <td>どうぐ</td>
                    <td>
                      <code class="varname">$C83E5C</code>
                    </td>
                  </tr>
                  <tr>
                    <td>1</td>
                    <td>ゴールド</td>
                    <td>
                      <code class="varname">$C8477E</code>
                    </td>
                  </tr>
                  <tr>
                    <td>2</td>
                    <td>立て札・貼り紙・本棚</td>
                    <td>n/a</td>
                  </tr>
                  <tr>
                    <td>3</td>
                    <td>罠モンスター</td>
                    <td>
                      <code class="varname">$C85534</code>
                    </td>
                  </tr>
                  <tr>
                    <td>4</td>
                    <td>（不明）</td>
                    <td>
                      <code class="varname">$C855AB</code>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <br class="table-break" />
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BF55"></a>4.21.2.14. しのびあし</h4>
              </div>
            </div>
          </div>
          <p>
しのびあしは次の処理を行うコマンドだ：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">しのびあし歩数 <code class="varname">$7E3BAD</code> をリセットする。</li>
              <li class="listitem">しのびあしフラグ <code class="code">$7E3D2B &amp; #$0008</code> をセットする。</li>
            </ul>
          </div>
          <p>

最後にメッセージ <code class="literal">#$16B6</code> を表示し、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BF77"></a>4.21.2.15. ねる</h4>
              </div>
            </div>
          </div>
          <p>
ねるは本人の状態をサブルーチン <code class="varname">$C44F0D</code> 呼び出しによってねむり状態にするコマンドだ。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3BF95"></a>4.21.2.16. おおごえ</h4>
              </div>
            </div>
          </div>
          <p>
おおごえは旅の店屋を呼びつけて営業をさせるコマンドだ。次のようなことを行う：

  </p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">トヘロス・せいすい歩数 <code class="varname">$7E3BA9</code> をリセットする。</li>
              <li class="listitem">サブルーチン <code class="varname">$C7CC76</code> を呼び出し、現在おおごえを利用可能かどうかを調べる。
      無効な場合にはメッセージ <code class="literal">#$16D5</code> を表示してコマンドを終了する。
      </li>
              <li class="listitem">おおごえフラグ <code class="code">$7E3D2B &amp; #$0040</code> をセットする。</li>
              <li class="listitem">
                <p class="simpara">最近訪問した店と同じ品揃えの旅の店屋、
      ある旅の宿屋、または旅の神父がそれぞれ確率 1/3 で現れる。</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">店屋の場合には <code class="varname">$7E3B77</code> に格納済みの店屋 ID を参照する。
          店の種別に合わせて出力メッセージ用に誰が現れるのかを決め、
          <a class="xref" href="dq6_shop.html#dq6.shop.behavior" title="4.6.2. 処理手順">4.6.2 処理手順</a> で述べる処理を実行する。</li>
                    <li class="listitem">宿屋の場合には ID <code class="literal">#$0024</code> の宿屋が現れる。
          それから <a class="xref" href="dq6_inn.html#dq6.inn.behavior" title="4.7.2. 処理手順">4.7.2 処理手順</a> で述べるサブルーチンを実行する。
          宿賃は一人 100 ゴールドだ。</li>
                    <li class="listitem">教会の場合には ID <code class="literal">#$0006</code> の教会が現れる。
          つまり「おいのりをする」がない教会だ。
          それから <a class="xref" href="dq6_church.html#dq6.church.behavior.C3D3E3" title="4.8.2.1. サブルーチン $C3D3E3: 標準的な教会">4.8.2.1 サブルーチン <code class="varname">$C3D3E3</code>: 標準的な教会</a> で述べるサブルーチンを実行する。
          </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">おおごえフラグ <code class="code">$7E3D2B &amp; #$0040</code> をリセットする。</li>
            </ul>
          </div>
          <p>

フラグをリセットしたら、コマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3C066"></a>4.21.2.17. あなほり</h4>
              </div>
            </div>
          </div>
          <p>
あなほりは物品またはゴールドをランダムに入手するコマンドだ。
できればアクティビティー図でも描いて展望を明瞭にしておきたいところだが、文章でコマンドの手続きを示す：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      サブルーチン <code class="varname">$C7CC3A</code> を実行し、あなほりが利用可能な状況かどうかを判定する。
      単に変数 <code class="varname">$7E85EF</code> がゼロであるかをテストするだけだ。
      ゼロでなければメッセージ <code class="literal">#$16D3</code> を表示してコマンドを終了する。
    </li>
              <li class="listitem">
      あなほりカウンターを参照する。変数 <code class="varname">$7E5ED3</code> がそれだが、
      この値が 5 以上ならばメッセージ <code class="literal">#$16D2</code> を表示してコマンドを終了する。
    </li>
              <li class="listitem">
      確率 1/2 でスカかどうかを抽選する。
      スカならばメッセージ <code class="literal">#$16D2</code> を表示してコマンドを終了する。
    </li>
              <li class="listitem">
                <p class="simpara">
      確率 1/2 でアイテム抽選を行うかどうかを補助サブルーチンの呼び出しにより抽選する。
      この抽選処理の概要は後述する。
    </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
          当選すれば、サブルーチン <code class="varname">$C3ED1D</code> を実行して獲得した物品をパーティーの所持品の空きまたはふくろに追加する。
        </li>
                    <li class="listitem">
          発見メッセージ <code class="literal">#$16D1</code> を出力する。
        </li>
                    <li class="listitem">
          サウンド <code class="literal">#$002C</code> を鳴らし、演奏終了を待機する。
        </li>
                    <li class="listitem">
          補助サブルーチンを呼び出して、あなほりカウンター <code class="varname">$7E5ED3</code> を 1 だけ加える。
          そこでは値が 5 を超えるようならば 5 のまま保留する。
        </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p class="simpara">
      アイテム抽選に漏れた場合は確率 1/128 で所持金の半額を掘り当てる。
    </p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
          当選すれば、サブルーチン <code class="varname">$C427E0</code> を呼び出してパーティーの所持金を問い合わせる。
          次に LSR 命令と ROR 命令を併用して半額を計算し、これを収入額とする。
        </li>
                    <li class="listitem">
          落選すればランダムに 1 または 2 ゴールドを収入額とする。
        </li>
                  </ul>
                </div>
                <p class="simpara">
      最後にサブルーチン <code class="varname">$C42862</code> を呼び出して所持金に収入額を加算し、
      メッセージ <code class="literal">#$16D0</code> を表示する。
    </p>
              </li>
              <li class="listitem">
      前述のあなほりカウンター補助サブルーチンを呼び出して、あなほりカウンターを更新する。
    </li>
            </ul>
          </div>
          <p>

以上でコマンドを終了する。
</p>
          <p>
次にアイテム抽選を行うかを決定する補助サブルーチンの処理を示す：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p class="simpara">
      パーティーがいる地域のタイルせんとうデータを参照する。
    </p>
                <p class="simpara">
      <a class="link" href="dq6_encounter.html#dq6.encounter.model.C6843C" title="4.17.1.1. 構造体 $C6843C: 通常の戦闘用編成">タイルせんとうデータ</a>内のモンスター抽選属性値の総和を計算する。
      この和がゼロならば、アイテム抽選を行わないものとする。
    </p>
                <p class="simpara">
      ゼロからこの和までの間の数をランダムに一つ取る。
    </p>
                <p class="simpara">
      この乱数から、タイルせんとうデータ内の謎の重みメンバーデータを一つずつ順に減算する。
      この値が負になるところで反復処理を中断するが、
      最後まで行っても負にならない場合は、アイテム抽選を行わないものとする。
    </p>
                <p class="simpara">
      反復処理中断時のインデックスを基に、タイルせんとうデータ中のモンスターを決定する。
      モンスターの ID がゼロならば、アイテム抽選を行わないものとする。
    </p>
                <p class="simpara">
      このモンスターの宝箱を落とす確率を<a class="link" href="dq6_monster.html#dq6.monster.C20154" title="4.14.1. 構造体 $C20154: モンスター">モンスターデータ</a>の対応属性に基いて決定する。
      確率表は <a class="xref" href="dq6_monster.html#table.dq6.C2B1C3" title="表 4.55 アイテム確率">表 4.55 アイテム確率</a> のものを参照する。
      それから当選確率がこの値であるような抽選をする。
    </p>
                <p class="simpara">
      このモンスターの宝箱が元々設定されていないならば、アイテム抽選を行わなかったものとする。
    </p>
                <p class="simpara">
      変数 <code class="varname">$7E5A2A</code> に宝箱の中身のアイテム ID をセットして、
      この補助サブルーチンを終了する。
    </p>
              </li>
            </ul>
          </div>
          <p>
</p>
          <p>
補足だが、処理中に乱数取得処理がいくつかあるが、そのほとんどはサブルーチン
<code class="varname">$C00F28</code> だが、アイテム確率だけは分母が大きいのでサブルーチン
<code class="varname">$C00F49</code> を採用している。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3C344"></a>4.21.2.18. インパス</h4>
              </div>
            </div>
          </div>
          <p>
インパスは次のような三段構造のコマンドだ：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">「まじゅつしのとう」入場に関する処理</li>
              <li class="listitem">宝箱またはツボの中身を判定する処理</li>
              <li class="listitem">所持品を一つ鑑定する処理</li>
            </ul>
          </div>
          <p>
</p>
          <p>
「まじゅつしのとう」入場に関する処理はサブルーチン
<code class="varname">$C7CC8E</code> 以下に実装されており、その内容とは次のようなものだ：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      現在パーティーがいるのが「まじゅつしのとう」玄関外部 (ID: <code class="literal">#$024D</code>) でなければ抜ける。
    </li>
              <li class="listitem">
      パーティーの先頭メンバーが入口の扉の前面に、扉の方を向いているかどうかを調べ、
      かつ扉がまだ閉まっているかどうかを調べる。いずれかの条件が成り立っていなければ抜ける。
    </li>
              <li class="listitem">
      この扉を開く。
    </li>
              <li class="listitem">
      <a class="link" href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BC70" title="4.21.2.6. ルーラ">ルーラフラグ列</a>内「まじゅつしのとう」のビットをセットする。
      これにはサブルーチン <code class="varname">$C6DE8A</code> を呼び出すことで達成する。
    </li>
            </ul>
          </div>
          <p>

この扉を開ける処理がなされると、インパスのコマンド処理が終了する。
そうでなければ、以下の処理へ進む。
</p>
          <p>
宝箱またはツボの中身を判定する処理はサブルーチン
<code class="varname">$C7CCEF</code> 以下で実装されている。次のようになっている：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      パーティーの先頭メンバーの正面に宝箱またはツボが置いてあるかどうかを調べる。
      具体的には、その対象に対応する「しらべる」メッセージ構造体配列の添字の値を見て、
      それが宝箱なのかツボなのかを判定する。
      対象が宝箱とツボのいずれでもなければ抜ける。
    </li>
              <li class="listitem">
      とうぞくのはなやレミラーマの要領で、対象の中身が収拾済みかどうかを確認する。
      また、中身が未回収ならばアイテム、ゴールド、罠の種別に応じて色を決める。
    </li>
            </ul>
          </div>
          <p>

このサブルーチン呼び出しにより、インパスが宝箱またはツボに反応する可能性があるかどうかがわかる。
コマンドハンドラー側ではこの戻り値によって、選択ウィンドウ「たからばこ アイテム」や
「ツボ アイテム」ウィンドウを表示するかどうかを決める。

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      ここでキャンセルされた場合は、コマンド自体をキャンセル扱いで終了する。
    </li>
              <li class="listitem">
      プレイヤーが「たからばこ」と「ツボ」のどちらかを選択すると、下の表に示した色に応じて
      <code class="literal">#$16AE</code> から <code class="literal">#$16B4</code> のいずれかの固定メッセージを表示してコマンドを終了する。
      「アイテム」を選択すると、次に述べる鑑定処理を実行する。
    </li>
            </ul>
          </div>
          <p>
</p>
          <div class="table">
            <a id="table.dq6.identification.colors"></a>
            <p class="title">
              <strong>表 4.99 インパスにおける色と内容の対応</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq6.identification.colors" class="lighttable">
                <thead>
                  <tr>
                    <th>値</th>
                    <th>色</th>
                    <th>内容</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>0</td>
                    <td>からっぽ</td>
                    <td>回収済みにつき空</td>
                  </tr>
                  <tr>
                    <td>1</td>
                    <td>青</td>
                    <td>品物</td>
                  </tr>
                  <tr>
                    <td>2</td>
                    <td>黄</td>
                    <td>ゴールド</td>
                  </tr>
                  <tr>
                    <td>3</td>
                    <td>赤</td>
                    <td>罠</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <p><br class="table-break" />
</p>
          <p>
最後に所持品の鑑定となる：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      ウィンドウ <code class="literal">#$00CB</code> を表示して、
      鑑定する品物を所持するパーティーメンバーまたは「ふくろ」のいずれかをプレイヤーに選択させる。
      ここでキャンセルされた場合は、再び宝箱・ツボチェックまで戻る。
    </li>
              <li class="listitem">
                <p class="simpara">
      パーティーメンバーが選択されると、所持品があるのかどうかを調べる。
      何も持っていなければメッセージ <code class="literal">#$1527</code> を表示して
      コマンド入力を一つ戻す。
    </p>
                <p class="simpara">
      道具袋が選択されると、中身が何かあるのかどうかを調べる。
      何も収納されていなければメッセージ <code class="literal">#$1722</code> を表示して
      コマンド入力を一つ戻す。
    </p>
              </li>
              <li class="listitem">
                <p class="simpara">鑑定する品物が決まったら、呪文効果音を鳴らして鑑定処理を実行する：</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
          サブルーチン <code class="varname">$C4608D</code> により、鑑定品の道具種別情報を取得する。
        </li>
                    <li class="listitem">
          鑑定メッセージを 2, 3 表示する。
          この際にメッセージ ID を道具構造体 <code class="varname">$C41A3D</code> のデータから取得するが、
          種別が道具か否かで出力手続きが異なる。
          メッセージ出力が最も多くなるのは、鑑定品が装備可能品かつ
          装備していると特殊な効用があり、さらに戦闘中に使うと何か起こるものだ。
        </li>
                    <li class="listitem">
          別サブルーチン呼び出しにより鑑定品の耐久性を鑑定する。
          道具構造体 <code class="varname">$C41A3D</code> の関連メンバーを取得し、
          メッセージ <code class="literal">#$163F</code> から <code class="literal">#$1641</code> までのいずれかを表示する。
        </li>
                    <li class="listitem">
          装備品ならば、パーティーメンバーの誰が装備可能なのかを調べる。
          具体的にはサブルーチン <code class="varname">$C45FA6</code> で情報取得を、
          配列 <code class="varname">$7E3BB6</code> で各員の装備可能性を保持する。
        </li>
                    <li class="listitem">
          前処理に基いて装備可能者をメッセージで表示する。
          大きく分けて三通り。
          誰も装備できないならばメッセージ <code class="literal">#$1642</code> か <code class="literal">#$1648</code> を示して売値評価へ進む。
          あるいは装備可能者が 6 名以上いるか否かで、メッセージ表示が異なる。
          詳細は割愛する。
        </li>
                    <li class="listitem">
          最後に売値を評価する。
          貴重品ビットのセットされた品物ならばメッセージ <code class="literal">#$164A</code> を、
          そうでなければサブルーチン <code class="varname">$C45F3C</code> で売値を計算し、
          メッセージ <code class="literal">#$1649</code> で知らせる。
        </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
          <p>

以上でコマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3C71B"></a>4.21.2.19. レミラーマ</h4>
              </div>
            </div>
          </div>
          <p>
レミラーマはパーティーの近くにある怪しいものを目立たせるコマンドだ。
ハンドラーでの処理は次のようになっている：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      サブルーチン <code class="varname">$C7CCF4</code> を呼び出して、このコマンドが利用可能であるかを問い合わせる。
      利用できなければメッセージ <code class="literal">#$16D8</code> を出力し、
      キャンセル扱いでコマンドを終了する。
    </li>
              <li class="listitem">
      次にサブルーチン <code class="varname">$C7CD10</code> を呼び出して、怪しいものを目立たさせる。
    </li>
            </ul>
          </div>
          <p>
</p>
          <p>
サブルーチン <code class="varname">$C7CCF4</code> の処理は単純で、
変数 <code class="varname">$7E5ED1</code> の値が <code class="literal">#$FFFF</code> でないことをテストするものだ。
</p>
          <p>
サブルーチン <code class="varname">$C7CD10</code> の処理では画面内の怪しい地点を光らせて効果音を鳴らす。
具体的な内容は説明が困難なので、明らかな処理のみ記す：

</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
      <a class="link" href="dq6_spell_commands.html#dq6.spell.commands.desc.C3BEF9" title="4.21.2.13. とうぞくのはな">とうぞくのはな</a>のアルゴリズムと同様にして、
      パーティーがいる地点近辺の怪しい地点を探索する。
      ただし、配列 <code class="varname">$7E641D</code> のテストするビットが異なる。
      レミラーマの場合は最上位ビットに加えて <code class="literal">#$0200</code> を見る。
    </li>
              <li class="listitem">
      怪しい地点が光るときの効果音は <code class="literal">#$00CD</code> を用いる。
      これは<a class="link" href="dq6_spell_commands.html#dq6.spell.commands.desc.C3B9A8" title="4.21.2.1. ホイミ・べホイミ・ベホマ">ホイミ系</a>と同じ効果音だ。
    </li>
            </ul>
          </div>
          <p>
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C7CDAF"></a>4.21.2.20. おもいだす・もっとおもいだす・ふかくおもいだす</h4>
              </div>
            </div>
          </div>
          <p>
おもいだす・もっとおもいだす・ふかくおもいだすの各コマンドは同一の処理
<code class="varname">$C7CDAF</code> に合流するので、まとめて解説する。
</p>
          <p>
今まで記憶したメッセージの ID は配列 <code class="varname">$7E3EAC</code> に最大 32 個格納されている。
これらはこのメッセージを配列の先頭から高々規定個数分を連続してウィンドウに出力するコマンド群だ。
メッセージ数の上限はコマンドによって異なり、次のようになっている：

  </p>
          <div class="table">
            <a id="table.dq6.recall.limits"></a>
            <p class="title">
              <strong>表 4.100 おもいだす系コマンドのメッセージ数上限</strong>
            </p>
            <div class="table-contents">
              <table id="table.dq6.recall.limits" class="lighttable">
                <thead>
                  <tr>
                    <th>コマンド</th>
                    <th>上限</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>おもいだす      </td>
                    <td align="right"> 3</td>
                  </tr>
                  <tr>
                    <td>もっとおもいだす</td>
                    <td align="right">10</td>
                  </tr>
                  <tr>
                    <td>ふかくおもいだす</td>
                    <td align="right">32</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <p><br class="table-break" />
</p>
          <p>
この配列には値 <code class="literal">#$FFFF</code> が混入していることがある。
そのときにはこの値をスキップして次に行く（配列の末尾まで <code class="literal">#$FFFF</code> のはずだが）。
また、メッセージ内の米印文字は星印文字に置換して出力する。
</p>
          <p>
この配列の中身 32 個が全て <code class="literal">#$FFFF</code> で埋まっている場合、
このコマンドはメッセージ <code class="literal">#$16DB</code> を表示して終了する。
</p>
          <p>
プレイヤーがメッセージ出力中にキャンセルボタンを押した場合、
出力するメッセージが残っていてもコマンドを終了する。
また、配列内が事実上空のときにはメッセージ <code class="literal">#$16DB</code> を表示してコマンドを終了する。
</p>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq6.spell.commands.desc.C3C7A3"></a>4.21.2.21. わすれる</h4>
              </div>
            </div>
          </div>
          <p>
わすれるは、メッセージ配列 <code class="varname">$7E3EAC</code> の内容を対話的に削除するコマンドだ。
</p>
          <p>
この配列の中身 32 個が全て <code class="literal">#$FFFF</code> で埋まっている場合、
このコマンドはメッセージ <code class="literal">#$16DC</code> を表示して終了する。
</p>
          <p>
候補メッセージがあるならば、画面に「？つまえ」ウィンドウおよびメッセージ出力ウィンドウを表示する。
「？つまえ」ウィンドウは二種類あり、メッセージ個数が 1 ならば ID <code class="literal">#$00A8</code> のものを用いるが、
普通は <code class="literal">#$00A7</code> のものを表示する。
プレイヤーは十字キーの左右でメッセージをめくり、対象を一個決定する。
</p>
          <p>
何かメッセージを決定すると、ウィンドウ <code class="literal">#$00A6</code>「わすれる はい・いいえ」を表示する。
プレイヤーが「はい」と答えると、サブルーチン <code class="varname">$C6E125</code> を呼び出すことで、
現在表示されているメッセージをメッセージ配列 <code class="varname">$7E3EAC</code> から取り除き、
それ以降のメッセージ ID をすべて最近覚えた方向にシフトし、
配列の末尾に <code class="literal">#$FFFF</code> をセットするという一連の処理を実行する。
</p>
          <p>
画面に「？つまえ」ウィンドウが表示している間にプレイヤーがキャンセルボタンを押すか、
わすれるためのメッセージ配列が空になったらコマンドを終了する。
</p>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq6_battle_commands.html" title="4.20. 戦闘コマンド"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq6.html" title="第 4 章 SFC 版ドラクエ 6 (1995)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq6_item_commands.html" title="4.22. 移動中の道具使用コマンド処理"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq6_battle_commands.html">4.20. 戦闘コマンド</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq6.html">第 4 章 SFC 版ドラクエ 6 (1995)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq6_item_commands.html">4.22. 移動中の道具使用コマンド処理</a></div>
  </body>
</html>
