<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>5.8. 王様解析</title>
    <link rel="stylesheet" type="text/css" href="dqbook.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="home" href="index.html" title="ドラクエ命" />
    <link rel="up" href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)" />
    <link rel="prev" href="dq3_window.html" title="5.7. ウィンドウ解析" />
    <link rel="next" href="dq3_sistersave.html" title="5.9. シスターセーブ解析" />
  </head>
  <body>
    <div class="navigation"><table><tr><td class="online-navigation"><a href="dq3_window.html" title="5.7. ウィンドウ解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_sistersave.html" title="5.9. シスターセーブ解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_window.html">5.7. ウィンドウ解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_sistersave.html">5.9. シスターセーブ解析</a><hr /></div>
    <div class="section">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title" style="clear: both"><a id="dq3.king"></a>5.8. 王様解析</h2>
          </div>
        </div>
      </div>
      <div class="toc">
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="dq3_king.html#dq3.king.hack">5.8.1. 解析</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.C3C07E">5.8.1.1. 王様共通処理サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.C3C300">5.8.1.2. 冒険の書が使用済かチェックするサブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.C3C31F">5.8.1.3. 冒険の書の名前文字列 ID を取得するサブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.C3C332">5.8.1.4. 冒険の書の勇者レベルを取得するサブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.C3C3E4">5.8.1.5. 次のレベルに必要な経験値を知らせる処理サブルーチン</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="dq3_king.html#dq3.king.hack.lines">5.8.1.6. 王様処理台詞用メッセージ ID 配列群</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <a id="term.dq3.king" class="indexterm"></a>
      <a id="term.dq3.save.king" class="indexterm"></a>
      <p>
	いろいろな国の城の王様・女王様に話すと、一言二言しゃべったあとにおなじみの処理に入る。
	すなわち、パーティの各メンバーについて、次のレベルになるまでに必要な経験値を教えてから、
	それまでのプレイ内容を冒険の書に記録するかどうかを問う処理だ。
	本節ではその処理を解析する。
</p>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h3 class="title"><a id="dq3.king.hack"></a>5.8.1. 解析</h3>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.C3C07E"></a>5.8.1.1. 王様共通処理サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
	各国の王・女王に「はなす」と、まずはそれぞれに固有の台詞を言うが、
	その後には全員同じく、レベルアップまでの残り経験値告知と、冒険の書記録の問い合わせからなる手続きを行う。
	この共通した手続きを、ここでは王様共通処理サブルーチンと称する。
</p>
          <p>
	王様共通処理サブルーチンは <code class="varname">$C3C07E</code> に定義されている。
	なお、このサブルーチンを呼び出す前に
	<code class="varname">A</code> レジスタに台詞セット ID をロードすることが事前条件となっている。
	一例を挙げよう。
</p>
          <pre class="programlisting">
C3/C4BA:    08          PHP
C3/C4BB:    C230        REP #$30
C3/C4BD:    48          PHA
C3/C4BE:    DA          PHX
C3/C4BF:    5A          PHY
C3/C4C0:    8B          PHB
C3/C4C1:    F47E7E      PEA $7E7E
C3/C4C4:    AB          PLB
C3/C4C5:    AB          PLB
C3/C4C6:    8DA033      STA $33A0
C3/C4C9:    8CA233      STY $33A2
C3/C4CC:    A90000      LDA #$0000          <a id="king.1-co"></a><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span>
C3/C4CF:    227EC0C3    JSR $C3C07E         <a id="king.2-co"></a><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span>
C3/C4D3:    AB          PLB
C3/C4D4:    C230        REP #$30
C3/C4D6:    7A          PLY
C3/C4D7:    FA          PLX
C3/C4D8:    68          PLA
C3/C4D9:    28          PLP
C3/C4DA:    6B          RTL
</pre>
          <div class="calloutlist">
            <table border="0" summary="Callout list">
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a id="king.1"></a><a href="#king.1-co"><span><img src="image/docbook/callouts/1.png" alt="1" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p><code class="varname">$C3C07E</code> 呼び出し直前に <code class="varname">A</code> レジスタにセットされている値が、人物の台詞を決める。</p>
                  <p>
一連の処理では、台詞をウィンドウに表示するのに、
<code class="code">LDA addr,X</code>（ここで <code class="varname">X</code> は上記 <code class="varname">A</code> の値と一致する）と、
台詞表示サブルーチン <code class="varname">$C1A95A</code> 呼び出しを組み合わせて実現している。
ここで、<code class="varname">addr</code> は王様共通処理サブルーチンの直後に定義されている
<a class="link" href="dq3_text.html#dq3.text.travel" title="5.2.2. 移動モード">メッセージ ID</a> 各配列の配置アドレスだ。
</p>
                </td>
              </tr>
              <tr>
                <td width="5%" valign="top" align="left">
                  <p><a id="king.2"></a><a href="#king.2-co"><span><img src="image/docbook/callouts/2.png" alt="2" border="0" /></span></a> </p>
                </td>
                <td valign="top" align="left">
                  <p><code class="varname">$C3C07E</code> に定義されている王様共通処理サブルーチンを呼び出す。</p>
                </td>
              </tr>
            </table>
          </div>
          <p>
	サブルーチン <code class="varname">$C3C07E</code> の実装は以下の通り。
	紙面が煩雑になるのを避けるため、本筋の処理とは本質的に関係のない処理の説明は省く。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
			<code class="code">A &lt;= #$0009</code> のときに限り <code class="code">A = 0</code> とする。
			<code class="varname">A</code> レジスタの値は王様それぞれの台詞グループの ID だ。
			<code class="code">X = A</code> としておく。
		</p>
              </li>
              <li class="listitem">
                <p>
			パーティの各メンバーが次のレベルになるまでに必要な経験値を教えるために、
			<a class="link" href="dq3_king.html#dq3.king.hack.C3C3E4" title="5.8.1.5. 次のレベルに必要な経験値を知らせる処理サブルーチン">サブルーチン <code class="varname">$C3C3E4</code></a> を呼び出す。
		</p>
              </li>
              <li class="listitem">
                <p>
			メッセージ ID を <code class="varname">$C3C1E3,X</code> からロードして、
			汎用メッセージ表示サブルーチンを呼び出すことで
			「そなたらの旅の成果をこの冒険の書に記録してもよいかな？」
			系統の台詞を表示する。
		</p>
              </li>
              <li class="listitem">
                <p>
			はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					キャンセルボタン or いいえ ⇒【冒険の書は更新しない】へ進む。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒【冒険の書番号を尋ねる】へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【冒険の書番号を尋ねる】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C1F7,X</code> からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「何番の冒険の書に書きとめるかの？」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					冒険の書リストウィンドウを表示して、プレイヤーの入力を待つ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							冒険の書を選択した ⇒【冒険の書を選択した】へ進む。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒
						</p>
                            <div class="itemizedlist">
                              <ul class="itemizedlist" style="list-style-type: disc; ">
                                <li class="listitem">
                                  <p>
									メッセージ ID を <code class="varname">$C3C229,X</code> からロードして、
									汎用メッセージ表示サブルーチンを呼び出すことで
									「ではまたいつでも来るがよい。○○○○よ！」
									系統の台詞を表示する。
								</p>
                                </li>
                                <li class="listitem">
                                  <p>
									【終了】へ進む。
								</p>
                                </li>
                              </ul>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【冒険の書は更新しない】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C1ED,X</code> からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「では書きとめないでおこう」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					【ゲーム終了の意思を確認】へ進む。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【冒険の書を選択した】</p>
                <p>
			選択した冒険の書 ID と <code class="varname">$40AB</code> すなわち現在プレイ中の冒険の書 ID を比較する。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					違うならば、【現在のものではない冒険の書を選択した】へ制御を進める。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					同じならば、次の処理【セーブ】へ制御を進める。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【セーブ】</p>
                <p>
			<a class="link" href="dq3_sistersave.html#dq3.sistersave.hack.C3C251" title="5.9.1.1. シスターセーブ共通処理サブルーチン">シスターセーブ</a>と同様の処理をする。
			すなわち、以下のコードを実行する。
		</p>
                <pre class="programlisting">
C3/C0FB:    ACA033      LDY $33A0
C3/C0FE:    22CE2BC4    JSR $C42BCE         ■(RTL+1) 未解析サブルーチン
C3/C102:    FD
C3/C103:    ACA233      LDY $33A2
C3/C106:    222C2CC4    JSR $C42C2C         ■(RTL+1) 未解析サブルーチン
C3/C10A:    FD
C3/C10B:    224E62C4    JSR $C4624E         ■(RTL+1) 未解析サブルーチン
C3/C10F:    FF
</pre>
              </li>
              <li class="listitem">
                <p>
			効果音 (ID: <code class="literal">#$002B</code>) を鳴らし、終わるまで待つ。
		</p>
              </li>
              <li class="listitem">
                <p>
			【現在のものではない冒険の書を選択した】
		</p>
                <p>
			<code class="varname">A</code> レジスタにプレイヤーが選択した冒険の書 ID (<code class="literal">0..2</code>) がロード済みとなっている。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					選択した冒険の書が未使用かどうかをテストするため、
					<a class="link" href="dq3_king.html#dq3.king.hack.C3C300" title="5.8.1.2. 冒険の書が使用済かチェックするサブルーチン">サブルーチン <code class="varname">$C3C300</code></a> を呼び出す。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							未使用であれば【セーブ】に制御を移す。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                    <li class="listitem">
                      <p>
					選択した冒険の書の識別用文字列 ID を取得するために
					<a class="link" href="dq3_king.html#dq3.king.hack.C3C31F" title="5.8.1.3. 冒険の書の名前文字列 ID を取得するサブルーチン">サブルーチン <code class="varname">$C3C31F</code></a> を呼び出す。
					そして <code class="varname">$BE77</code> にセットする。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					選択した冒険の書の勇者レベルを取得するために
					<a class="link" href="dq3_king.html#dq3.king.hack.C3C332" title="5.8.1.4. 冒険の書の勇者レベルを取得するサブルーチン">サブルーチン <code class="varname">$C3C332</code></a> を呼び出す。
					そして <code class="varname">$BE81</code> に <code class="literal">3</code> バイトサイズでセットする。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C201,X</code> からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「すると○○○○ ＬＶ○○の記録は消えてしまうが？」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							キャンセルボタン or いいえ ⇒【冒険の書番号を尋ねる】へ戻る。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒【セーブ】に制御を移す。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【記録終了】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C20B,X</code> からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「しかときろくしたぞよ。またすぐに旅立つつもりか？」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							キャンセルボタン or いいえ ⇒【また会おう】へ進む。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒【終了】へ進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【ゲーム終了の意思を確認】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C20B,X</code> からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「また すぐに旅立つ つもりかの？」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							キャンセルボタン or いいえ ⇒【さらに確認】へ進む。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒【終了】へ進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【さらに確認】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C21F,X</code>  からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「旅の記録が前に書きとめたところまで戻ってしまうが？」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					はい・いいえウィンドウを表示して、プレイヤーの入力を待つ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							キャンセルボタン or いいえ ⇒【冒険の書番号を尋ねる】へ戻る。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒【また会おう】へ進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【また会おう】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C233,X</code>  からロードして、
					汎用メッセージ表示サブルーチンを呼び出すことで
					「ではしばし休むがよい！ また会おう！ ○○○○よ！」
					系統の台詞を表示する。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<code class="code">JMP $C67B76</code> して画面暗転。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【終了】</p>
                <p>
			サブルーチン呼び出し元に制御を戻す。
		</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.C3C300"></a>5.8.1.2. 冒険の書が使用済かチェックするサブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
	サブルーチン <code class="varname">$C3C300</code> は
	<code class="varname">A</code> レジスタの値で示される冒険の書が既に使用されているかどうかを調べるものだ。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>【事前条件】</p>
                <p>
			<code class="varname">A</code> レジスタには調べたい冒険の書 ID がロード済み。
			<code class="code">A == 0, 1, 2</code> のどれかである。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C319,X</code> (where <code class="code">X == A * 2</code>) により、<code class="varname">A</code> レジスタに <code class="literal">2</code> バイトの定数をロードする。
			これはアドレス値だ。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">$0000,X</code> (where <code class="code">X == A</code>) の値と <code class="literal">1</code> を比較する。
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					等しい ⇒ <code class="varname">Carry</code> ビットをリセット
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					それ以外 ⇒ <code class="varname">Carry</code> ビットをセット
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			サブルーチン呼び出し元に制御を戻す。
		</p>
              </li>
              <li class="listitem">
                <p>【事後条件】</p>
                <p>
			冒険の書が未使用ならば <code class="code">Carry == 1</code>; そうでなければ <code class="code">Carry == 0</code>
		</p>
              </li>
            </ul>
          </div>
          <p>
	小さなデータ領域 <code class="varname">$C3C319</code> は以下の通りになっている。
	つまり、それぞれの <code class="varname">$7Exxxx</code> に存在する <code class="literal">2</code> バイト値が、
	それぞれの冒険の書の使用・未使用のフラグになっているのだ。
</p>
          <pre class="programlisting">
C3/C319:    6940  ; 冒険の書 1 が使用済ならば $7E4069 == 1
C3/C31B:    6B40  ; 冒険の書 2
C3/C31D:    6D40  ; 冒険の書 3
</pre>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.C3C31F"></a>5.8.1.3. 冒険の書の名前文字列 ID を取得するサブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
	サブルーチン <code class="varname">$C3C31F</code> は
	<code class="varname">A</code> レジスタの値で示される冒険の書の名前文字列 ID を取得する。
	実装は以下の通り。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>【事前条件】</p>
                <p>
			<code class="varname">A</code> レジスタには調べたい冒険の書 ID がロード済み。
			<code class="code">A == 0, 1, 2</code> のどれかである。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C32C,X</code> (where <code class="code">X == A * 2</code>) により、
			<code class="varname">A</code> レジスタに <code class="literal">2</code> バイトの定数をロードする。
			これはアドレス値だ。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">$0000,X</code> (where <code class="code">X == A</code>) の値を <code class="varname">A</code> レジスタにロードする。
		</p>
              </li>
              <li class="listitem">
                <p>
			サブルーチン呼び出し元に制御を戻す。
		</p>
              </li>
              <li class="listitem">
                <p>【事後条件】</p>
                <p>
			<code class="varname">A</code> レジスタには冒険の書の名前文字列 ID がロードされている。
		</p>
              </li>
            </ul>
          </div>
          <p>
	小さなデータ領域 <code class="varname">$C3C32C</code> は以下の通りになっている。
	つまり、それぞれの <code class="varname">$7Exxxx</code> に存在する <code class="literal">2</code> バイト値が、
	それぞれの冒険の書の名前文字列 ID だ。
</p>
          <pre class="programlisting">
C3/C32C:    7540  ; $7E4075 を意味する
C3/C32E:    7740  ; $7E4077
C3/C330:    7940  ; $7E4079
</pre>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.C3C332"></a>5.8.1.4. 冒険の書の勇者レベルを取得するサブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
	サブルーチン <code class="varname">$C3C332</code> は
	<code class="varname">A</code> レジスタの値で示される冒険の書の勇者レベルを取得する。
	実装は以下の通り。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>【事前条件】</p>
                <p>
			<code class="varname">A</code> レジスタには調べたい冒険の書 ID がロード済み。
			<code class="code">A == 0, 1, 2</code> のどれかである。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="code">LDA $C3C33F,X</code> (where <code class="code">X == A * 2</code>) により、
			<code class="varname">A</code> レジスタに <code class="literal">2</code> バイトの定数をロードする。
		</p>
              </li>
              <li class="listitem">
                <p>
			<code class="varname">$0000,X</code> (where <code class="code">X == A</code>) の値を <code class="varname">A</code> レジスタにロードする。
		</p>
              </li>
              <li class="listitem">
                <p>
			サブルーチン呼び出し元に制御を戻す。
		</p>
              </li>
              <li class="listitem">
                <p>【事後条件】</p>
                <p>
			<code class="varname">A</code> レジスタには冒険の書の勇者レベルがロードされている。
		</p>
              </li>
            </ul>
          </div>
          <p>
	小さなデータ領域 <code class="varname">$C3C33F</code> は以下の通りになっている。
	つまり、それぞれの <code class="varname">$7Exxxx</code> に存在する <code class="literal">2</code> バイト値が、
	それぞれの冒険の書の勇者のレベルだ。
</p>
          <pre class="programlisting">
C3/C33F:    6F40  ; $7E406F を意味する
C3/C341:    7140  ; $7E4071
C3/C343:    7340  ; $7E4073
</pre>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.C3C3E4"></a>5.8.1.5. 次のレベルに必要な経験値を知らせる処理サブルーチン</h4>
              </div>
            </div>
          </div>
          <p>
	王様共通処理の中で、この処理だけは個別にサブルーチン化されている。
	サブルーチン <code class="varname">$C3C3E4</code> の実装は以下の通り。
</p>
          <div class="itemizedlist">
            <ul class="itemizedlist" style="list-style-type: disc; ">
              <li class="listitem">
                <p>
			<code class="code">A &lt;= #$0009</code> のときに限り <code class="code">A = 0</code> とする。
			<code class="varname">A</code> レジスタの値は王様それぞれの台詞グループの ID だ。
			さらに <code class="varname">$74</code> にこの値をとっておく。
		</p>
              </li>
              <li class="listitem">
                <p>
			パーティの人数取得サブルーチン <code class="varname">$C4297C</code> を呼び出す。
			<code class="varname">Y</code> レジスタに人数をロードする。
		</p>
              </li>
              <li class="listitem">
                <p>
			【一人分の処理開始】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					パーティメンバーの先頭から
					<code class="varname">A</code> 番目のキャラクターの<span class="emphasis"><em>現在のレベル</em></span>を取得するために、
					サブルーチン <code class="varname">$C42FEB</code> を呼び出す。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<code class="varname">X</code> = 現在のレベル + <code class="literal">1</code> とする。すなわち<span class="emphasis"><em>次のレベル</em></span>だ。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					キャラクターの<span class="emphasis"><em>次のレベルの経験値</em></span>を取得するために、
					サブルーチン <code class="varname">$C43C07</code> を呼び出す。
					呼び出し終了後、値が <code class="varname">$70</code> に <code class="literal">3</code> バイトサイズでセットされている。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							この呼び出し先によって
							<code class="varname">Carry</code> ビットがリセットされている場合、
							【現在の経験値を見る】に進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C23D,X</code> (where <code class="code">X == $74</code>) からロードして【台詞表示】に進む。
					これは「○○○○はもう十分に強い！」
					系統の台詞 ID を意味する。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【現在の経験値を見る】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					<code class="literal">3</code> バイトコピー代入処理として <code class="code">$BE81 = $70</code> する。すなわち、
					キャラクターの次のレベルの経験値を <code class="varname">$BE81</code> にセットする。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					キャラクターの<span class="emphasis"><em>現在の経験値</em></span>を調べるべく、
					サブルーチン <code class="varname">$C43B5F</code> を呼び出す。
					呼び出し先で <code class="varname">$70</code> が現在の経験値で上書きされる。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					<code class="varname">$71</code> と <code class="varname">$BE82</code> を比較する。
					<code class="literal">3</code> バイト値の上位 <code class="literal">2</code> バイトの比較だ。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							<code class="code">$71 == $BE82</code> ⇒ さらに <code class="varname">$70</code> と <code class="varname">$BE81</code> を比較する。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							<code class="code">$71 &gt; $BE82</code> ⇒【現在の経験値が多すぎ】に進む。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外は【経験値の差を計算】に進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                    <li class="listitem">
                      <p>
					<code class="varname">$70</code> と <code class="varname">$BE81</code> を比較する。
				</p>
                      <div class="itemizedlist">
                        <ul class="itemizedlist" style="list-style-type: square; ">
                          <li class="listitem">
                            <p>
							<code class="code">$70 &lt; $BE81</code> ⇒【経験値の差を計算】に進む。
						</p>
                          </li>
                          <li class="listitem">
                            <p>
							それ以外 ⇒【現在の経験値が多すぎ】に進む。
						</p>
                          </li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【経験値の差を計算】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					<code class="code">$BE81 -= $70</code> の算術処理を <code class="literal">3</code> バイトサイズで行う。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C1D9,X</code> (where <code class="code">X == $74</code>) からロードして【台詞表示】に進む。
					これは「次のレベルになるにはあと○○○の経験が必要じゃ」
					系統の台詞 ID を意味する。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【現在の経験値が多すぎ】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ ID を <code class="varname">$C3C247,X</code> (where <code class="code">X == $74</code>) からロードして【台詞表示】に進む。
					これは「○○○○はわしにもわからぬ経験を積んだようじゃな」
					系統の台詞 ID を意味する。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>
			【台詞表示】
		</p>
                <div class="itemizedlist">
                  <ul class="itemizedlist" style="list-style-type: circle; ">
                    <li class="listitem">
                      <p>
					メッセージ表示サブルーチン <code class="varname">$C1A95A</code> を呼び出す。
				</p>
                    </li>
                    <li class="listitem">
                      <p>
					次のキャラクターがいれば、<code class="varname">$BE7D</code> を
					次のキャラクターにセットして、制御を【一人分の処理開始】に戻す。
				</p>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="listitem">
                <p>【終了】</p>
                <p>
			サブルーチン呼び出し元に制御を戻す。
		</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h4 class="title"><a id="dq3.king.hack.lines"></a>5.8.1.6. 王様処理台詞用メッセージ ID 配列群</h4>
              </div>
            </div>
          </div>
          <p>
	これまで述べてきた各処理中には、<code class="code">LDA addr,X</code> によってメッセージ ID を参照する箇所がいくつかあった。
	今後の解析作業用に、その一覧を以下にまとめる。
	各 <code class="code">addr,X</code> は <code class="literal">2</code> バイトサイズの値が <code class="literal">5</code> 個からなる配列であり、
	各 <code class="literal">2</code> バイトの値は王様の台詞メッセージ ID だが、
	ここでは <code class="varname">X</code> がゼロのときの台詞を記しておけば、作業には十分役立つだろう。
</p>
          <div class="variablelist">
            <dl class="variablelist">
              <dt>
                <span class="term">
                  <code class="varname">$C3C1D9,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「[C0]が つぎのレベルに[AD]なるには あと[BB]の[AD]けいけんが 必要じゃ。[AF][AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C1E3,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「そなたらの 旅の せいかを[AD]この 冒険の書に[AD]きろくしても よいかな？[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C1ED,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「そうか… では[AD]書きとめないでおこう。[AF][AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C1F7,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「では なん番の 冒険の書に[AD]書きとめるかの？[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C201,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「すると [B2] ＬＶ[BB]の[AD]きろくは 消えてしまうが[AD]それでも いいかな？[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C20B,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「しかと きろくしたぞよ。[AD]どうじゃ？ また すぐに[AD]旅立つ つもりか？[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C215,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「また すぐに[AD]旅立つ つもりかの？[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C21F,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「なんと！ きろくせずに[AD]休むというのか。[AF]...</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C229,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「おや やめるのかね。[AD]では また いつでも 来るがよい。[AD][CB]よ！[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C233,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「では しばし 休むがよい！[AD]また 会おう！ [CB]よ！[AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C23D,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「[C0]は[AD]もう じゅうぶんに 強い！[AF][AC]</p>
              </dd>
              <dt>
                <span class="term">
                  <code class="varname">$C3C247,X</code>
                </span>
              </dt>
              <dd>
                <p>[CD][D6]王「[C0]は わしにも わからぬ[AD]けいけんを つんだようじゃな。[AF]...</p>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation"><hr /><table><tr><td class="online-navigation"><a href="dq3_window.html" title="5.7. ウィンドウ解析"><img src="image/docbook/prev.png" alt="戻る" /></a></td><td class="online-navigation"><a href="dq3.html" title="第 5 章 SFC 版ドラクエ 3 (1996)"><img src="image/docbook/up.png" alt="上に戻る" /></a></td><td class="online-navigation"><a href="dq3_sistersave.html" title="5.9. シスターセーブ解析"><img src="image/docbook/next.png" alt="次へ" /></a></td><td>ドラクエ命</td><td class="online-navigation"><a href="index.html" title="ドラクエ命"><img src="image/docbook/home.png" alt="ホーム" /></a></td><td class="online-navigation"><a href="" title=""><img src="image/docbook/index.png" alt="索引" /></a></td></tr></table><b class="navlabel">Previous: </b><a accesskey="p" class="sectref" href="dq3_window.html">5.7. ウィンドウ解析</a> <b class="navlabel">Up: </b><a accesskey="u" class="sectref" href="dq3.html">第 5 章 SFC 版ドラクエ 3 (1996)</a> <b class="navlabel">Next: </b><a accesskey="n" class="sectref" href="dq3_sistersave.html">5.9. シスターセーブ解析</a></div>
  </body>
</html>
